// let warning_table_Type;
let Warning_Rank;
let warningtotal;
$(function () {
  getMonitorInfo();

  note.on("subject.change", (event, checked, station) => {
    // warning_table_Type = checked.id;
    if ($('#date-box').css('display') == 'none') {
      $("#calendar-main").show();
      $("#flood-back").hide();
    }
    // issuingEarly();
  })

  $('#暴雨预警,#洪水预警').on('click', 'span', function () {
    warningtotal = $(this).attr('data-total');
    if (warningtotal <= 0 || motype == 'error') {
      layer.msg('没有预警信息', {
        time: 2000
      })
      return
    }
    const id = $(this).parent().attr('id');
    motype = id == '暴雨预警' ? 2 : id == '洪水预警' ? 3 : id == '滑坡预警' ? 4 : id == '火险预警' ? 5 : 'error';
    const css = $(this).attr('class');
    Warning_Rank = css == 'very-danger-color' ? 10 : css == 'high-danger-color' ? 6 : css == 'danger-color' ? 4 : css == 'low-dange-color' ? 1 : 0;
    pageNow = 1;
    pageSize = 100;
    tableSearchKey = '';
    adcdUser = '';
    tableAdcd = '';
    drnaType = 0;
    listChecked = '';
    showWarningLayer();
    propertiesWin.dom.css("z-index", "999");
  })
})

function showWarningLayer() {
  showTip(0);
  const params = {
    alarmtype: motype,
    type: adcdUser,
    adcd: tableAdcd,
    startTime: `${today} 00:00:00`,
    endTime: `${today} 24:00:00`,
    rank: Warning_Rank,
    drnaType,
    pageNow,
    pageSize,
    searchKey: tableSearchKey,
  }
  ajaxCallJson(params, '/warning/getAlarmByPage', function (res) {
    if (!res.info && tableSearchKey) {
      showTip(1)
      tableSearchKey = '';
      return;
    }
    $('#base-properties-table').bootstrapTable('destroy');
    if (res.flag) {
      if (warningtotal != res.info.Num.total) {
        warningtotal = res.info.Num.total;
        getMonitorInfo();
      }
      if (motype != 2 && motype != 3) {
        const methodType = 'Warning';
        creatTabledata(res.info, methodType);
      } else {
        ajaxCallJson(params, '/warning/getWarningCountByUser', function (res1) {
          let data = res.info;
          data.adcd = res1.info;
          
          const methodType = 'Warning';
          adcdUser = res1.type || '';
          creatTabledata(data, methodType);
          showTip(2);
          const title = `${
            motype == 2 ? (Warning_Rank == 10 ? `暴雨红色预警 <span style='color:#FF0000;'>(${warningtotal})</span>`
              : Warning_Rank == 6 ? `暴雨橙色预警 <span style='color:#FF9900;'>(${warningtotal})</span>`
                : Warning_Rank == 4 ? `暴雨黄色预警 <span style='color:#FFFF00;'>(${warningtotal})</span>`
                  : Warning_Rank == 1 ? `暴雨蓝色预警 <span style='color:#3266FF;'>(${warningtotal})</span>`
                    : `暴雨预警 <span>(${warningtotal})</span>`) :
              motype == 3 ? (Warning_Rank == 10 ? `特大洪水预警 <span style='color:#FF0000;'>(${warningtotal})</span>`
                : Warning_Rank == 6 ? `大洪水预警 <span style='color:#FF9900;'>(${warningtotal})</span>`
                  : Warning_Rank == 4 ? `中洪水预警 <span style='color:#FFFF00;'>(${warningtotal})</span>`
                    : Warning_Rank == 1 ? `小洪水预警 <span style='color:#3266FF;'>(${warningtotal})</span>`
                      : `洪水预警 <span>(${warningtotal})</span>`) : id
            }`
          propertiesWin.setTitle(title);
        })
      }
    } else {
      propertiesWin.hide();
      showTip(1)
    }
  })
}

/**
 * 获取预警统计
 */
let woringNum = 2;
let warningTimer;
async function getMonitorInfo() {
  clearTimeout(warningTimer);
  warningTimer = setTimeout(function () {
    getMonitorInfo();
  }, 1000 * 60 * 15);
  if (woringNum < 2) return
  // if (!warning_table_Type) return
  // $("#count-loading").show();
  woringNum = 0;

  let html = [];

  await new Promise(function (resolve, reject) {
    ajaxCallJson({
      alarmtype: 2,
      startTime: `${today} 00:00:00`,
      endTime: `${today} 24:00:00`
    }, '/warning/getWarningCount', function (res) {
      if (res.flag) {
        woringNum++;
        html.push(addWarningList(res.info));
        resolve(res.info);
      } else {
        reject('获取暴雨预警信息失败！');
      }
    })
  }).catch(e => console.log(e));

  await new Promise(function (resolve, reject) {
    ajaxCallJson({
      alarmtype: 3,
      startTime: `${today} 00:00:00`,
      endTime: `${today} 24:00:00`
    }, '/warning/getWarningCount', function (res) {
      if (res.flag) {
        warningCountData = res.info.total;
        woringNum++;
        html.push(addWarningList(res.info));
        resolve(res.info);
      } else {
        reject('获取洪水预警信息失败！');
      }
    })
  }).catch(e => console.log(e));

  $(".warning-storm-data,.warning-flood-data").empty();

  $('.warning-storm-data').append(html[0]);
  $('.warning-flood-data').append(html[1]);
  if (woringNum <= 0) {
    // $("#count-loading").hide();
    nodata();
    return
  }
  if (woringNum >= 2) woringNum = 2;
  // $("#count-loading").hide();
}

function addWarningList(data) {
  const html = `
      <span class="very-danger-color" data-total='${data.level4}'>${data.level4}</span>
      <span class="high-danger-color" data-total='${data.level3}'>${data.level3}</span>
      <span class="danger-color" data-total='${data.level2}'>${data.level2}</span>
      <span class="low-dange-color" data-total='${data.level1}'>${data.level1}</span>`;
  return html;
}

function nodata() {
  const html = `
     <div class="warning-nodata">
        <span>暂无数据</span>
     </div>`;
  $(".warning-box").append(html);
}

function initMainTitle() {
  if (warningCountData > 0) {
    mainTittleClick(1);
  } else {
    mainTittleClick(0);
  }
}
//分类查询预警的方法
// if (warning_table_Type == '1' || warning_table_Type == '2') {
//   const params = {
//     alarmtype: 2,
//             startTime: `${today} 00:00:00`,
// endTime: `${today} 24:00:00`
//   }
//   ajaxCallJson(params, '/warning/getWarningCount', function (res) {
//     if (res.flag) {
//       if (warning_table_Type == '1' && res.info.total <= 0) return
//       const name = ['暴雨预警', 'storm'];
//       woringNum++;
//       setWarningCount(res.info, name, woringNum);
//     }
//   })
// }

// if (warning_table_Type == '1' || warning_table_Type == '3') {
//   const params = {
//     alarmtype: 3,
//             startTime: `${today} 00:00:00`,
// endTime: `${today} 24:00:00`
//   }
//   ajaxCallJson(params, '/warning/getWarningCount', function (res) {
//     if (res.flag) {
//       warningCountData = res.info.total;
//       const name = ['洪水预警', 'flood'];
//       woringNum++;
//       setWarningCount(res.info, name, woringNum);
//     }
//   })
// }

// if (warning_table_Type == '1' || warning_table_Type == '4') {
//   const params = {
//     alarmtype: 4,
//             startTime: `${today} 00:00:00`,
// endTime: `${today} 24:00:00`
//   }
//   ajaxCallJson(params, '/warning/getWarningCount', function (res) {
//     if (res.flag) {
//       if (warning_table_Type == '1' && res.info.total <= 0) return
//       const name = ['滑坡预警', 'landslide'];
//       woringNum++;
//       setWarningCount(res.info, name, woringNum);
//     }
//   })
// }

// if (warning_table_Type == '1' || warning_table_Type == '5') {
//   const params = {
//     alarmtype: 5,
//             startTime: `${today} 00:00:00`,
// endTime: `${today} 24:00:00`
//   }
//   ajaxCallJson(params, '/warning/getWarningCount', function (res) {
//     if (res.flag) {
//       if (warning_table_Type == '1' && res.info.total <= 0) return
//       warningCountData = res.info.total;
//       const name = ['火险预警', 'fire'];
//       woringNum++;
//       setWarningCount(res.info, name, woringNum);
//     }
//   })
// }

//火灾预警前端分页方法
// if (warning_table_Type == '1' || warning_table_Type == '5') {
//   const params = {
//     tm: `${today.replace(/-/g,'')}0000`,
//     tmend: `${today.replace(/-/g,'')}2400`,
//   }
//   ajaxCallJson(params, '/warning/findFireMonitor', function (res) {
//     if (res.flag) {
//       if (warning_table_Type == '1' && res.info.total <= 0) return
//       const name = ['火险预警', 'fire'];
//       woringNum++;
//       fireWarningData = res.info;
//       setWarningCount(fireWarningData, name, woringNum);
//     }
//   })
// }

// let fireWarningData;

// function getFireData() {
//   $('#base-properties-table').bootstrapTable('destroy');
//   const level = Warning_Rank == 10 ? '极危' : Warning_Rank == 6 ? '高危' : Warning_Rank == 4 ? '危险' : Warning_Rank == 1 ? '低危' : 0;
//   const total = Warning_Rank == 10 ? fireWarningData.level4 : Warning_Rank == 6 ? fireWarningData.level3 : Warning_Rank == 4 ? fireWarningData.level2 : Warning_Rank == 1 ? fireWarningData.level1 : fireWarningData.total;
//   let index = 0,
//     rows = [];
//   for (let i of fireWarningData.rows) {
//     if (level == 0 || level == i.level) {
//       index++;
//       if (index > (pageNow - 1) * pageSize)
//         rows.push({
//           Num: index,
//           ...i
//         });
//       if (index >= pageNow * pageSize) {
//         break;
//       }
//     }
//   }
//   data = {
//     rows,
//     columnTxt: fireWarningData.columnTxt,
//     total,
//   }
//   const methodType = 'Warning_fire';
//   creatTabledata(data, methodType);
// }