/**
 * Created by Administrator on 2017/2/22.
 */
var monitorWindow = new Array(); //监控对象信息窗口
var currentMocd; //当前点击监控对象的mocd
var currentName; //当前点击监控对象的Name
var currentOrgcd; //当前点击监控对象的机构编码
var currentStcd; //当前点击监控对象的stcd
var currentType; //当前点击监控对象的stcd
var doubleClickLayer;
var reservoirDamWindow;
var changeType = "";
var maxVideo = false;
var player;

/**
 * 点击监控对象
 * @param params Object 监控对象参数(type:1 河道，2 城镇，3 水库水电站，4 山洪小流域，5 城市易涝点；mocd:监控对象编码，name:监控对象名称)
 *
 * **/
function monitorClick(params, obj, zindex) {
  var showOperationRight = initShowRight(obj);
  console.info(showOperationRight);
  chartArray.forEach(function (chart) {
    chart.dispose();
  });
  chartArray.clear();
  closeMonitorWindow();
  if (zindex) {
    $("#monitor-detail").css("z-index", zindex);
    $("#monitor-detail-right").css("z-index", zindex);
    $("#monitor-detail-right-warning").css("z-index", zindex);
  }
  $('#monitor-detail-content li').hide();
  $("#monitor-detail-right-warning").hide();
  var type = params.type;
  currentMocd = params.mocd;
  currentName = params.name || params.monm;
  currentStcd = params.stcd;
  if (!currentMocd) {
    console.error("点击对象的mocd不能为空");
    return;
  }
  // initReservoirVideo();
  var msg = "数据加载中，请稍等...";

  if (type == obj_type_river_section) {
    layui.use('layer', function () {
      index = layui.layer;
      // doubleClickLayer= layer.msg(msg, {
      //     time: 10000,
      //     icon: 16,
      //     skin: 'layer-ext-simulation',
      //     shade: [0.2, '#000']
      // });
    });
    getRiverDbClickData(params, obj, showOperationRight);
  }
  if (type == obj_type_city) {
    layui.use('layer', function () {
      index = layui.layer;
      doubleClickLayer = layer.msg(msg, {
        time: 10000,
        icon: 16,
        skin: 'layer-ext-simulation',
        shade: [0.2, '#000']
      });
    });
    currentType = obj_type_city;
    getCityDbClickData(params);
    //  initCityVideo();
  }
  if (type == obj_type_reservoir || type=='flood') {
    layui.use('layer', function () {
      index = layui.layer;
      // doubleClickLayer= layer.msg(msg, {
      //     time: 10000,
      //     icon: 16,
      //     skin: 'layer-ext-simulation',
      //     shade: [0.2, '#000']
      // });
    });
    getReservoirDbClickData(params, obj, showOperationRight);
  }
  if (type == obj_type_mountain_torrents) {
    layui.use('layer', function () {
      index = layui.layer;
      doubleClickLayer = layer.msg(msg, {
        time: 10000,
        icon: 16,
        skin: 'layer-ext-simulation',
        shade: [0.2, '#000']
      });
    });
    currentType = obj_type_mountain_torrents;
    getWatershedDbClickData(params, showOperationRight);
    //  initEnlargeWatershedVideoWin();
  }
  if (type == obj_type_waterlogged) {
    layui.use('layer', function () {
      index = layui.layer;
      doubleClickLayer = layer.msg(msg, {
        time: 10000,
        icon: 16,
        skin: 'layer-ext-simulation',
        shade: [0.2, '#000']
      });
    });
    currentType = obj_type_waterlogged;
    getWaterlogggedDbClickData(params, showOperationRight);
  }

  //隐藏站点详细信息
  $('#p_hidden').click(function () {
    $('#monitor-detail').css('display', 'none');
    $('#monitor-detail-right').css('display', 'none');
    if (hiddenVideo != undefined) {
      hiddenVideo();
    }
  });
}

/**河道 start**/
//河道双击信息
function getRiverDbClickData(params, obj, rightData) {
  noReservoirStageHtml(rightData);//判断右侧显示哪两个
  var mocd = params.mocd;
  var name = params.name;
  currentType = obj_type_river_section;
  $('.monitor-detail-title').html(name);
  $('#river-rain-table').html('<table id="river-rain-table-content"></table>');
  var data = {
    mocd: mocd,
    rainId: "forecast-rain-chart",
    otherId: "forecast-other-chart",
    tableId: 'river-rain-table-content',
    type: obj_type_river_section
  };
  for (var i = 0; i < rightData.length; i++) {
    if (rightData.indexOf("fore") !== -1) {
      data.rainId = 'reservoir-rain-right-chart';
      data.otherId = 'reservoir-other-right-chart';
    }
  }
  getRiverForeRain(data, function (data) {
    if (!data || data == "") {
      layer.close(doubleClickLayer);
      return;
    }
    if (data.rainData.length == 0) {
      layer.close(doubleClickLayer);
      return;
    }

    initEnlargeRiverRainWin(data, name, mocd, rightData);
    layer.close(doubleClickLayer);
  })
  //河道实时数据
  realTimeRiver(mocd, name, rightData);
  ajaxCallJson({
    mocd: mocd,
    type: 1
  }, '/floodSituation/cross/data', function (result) {
    if (result && result.data) {
      $("#monitor-detail-right").show();
      $("#peripheral-information-max").css("display", "block");
      var title = name + "-横断面示意图";
      $('#cross-sectional').prev().find(".title-name").html(title);
      // $("#peripheral-information-max .monitor-detail-right-title").html("横断面示意图");
      // $("#detail-two").find(".title").html("横断面示意图");
      //初始化横断面示意图
      $("#monitor-detail-right").show();
      $('#cross-sectional-chart').html('');
      $('#cross-sectional-chart').css("text-align", "center");
      initDetailWinImg(mocd, 10);
      changeType = 2;
      reservoirDamWindow = "";
      initEnlargeRiverCrossWin(result.data, title, mocd);
    }
  });
  // ajaxCallJson({
  //     mocd: mocd,
  //     type: 1
  // }, '/floodSituation/vertical/data', function (result) {
  //     if (result && result.data) {
  //         var title = name + "-纵断面示意图";
  //         $('#vertical-sectional').prev().find(".title-name").html(title);
  //         $("#detail-three").find(".title").html("纵断面示意图");
  //         //初始化横断面示意图
  //         $('#vertical-sectional-chart').html('');
  //         $('#vertical-sectional-chart').css("text-align", "center");
  //         initDetailWinImg(mocd, 3);
  //         initEnlargeRiverVerticalWin(result.data, title, mocd);
  //     }
  // });

  ajaxCallJson({
    mocd: mocd
  }, "/floodSituation/river/rating/curve", function (result) {
    if (!result) {
      return;
    }
    if (result.data == "" || !result.data) {
      return;
    }
    if (result.data.q == null || result.data.z == null) {
      return;
    }
    var title = name + "-基础信息";
    $("#detail-four").find(".title").html("基础信息");
    initSmallWin('detail-four');
    if (result.data.q == "" || !result.data.q) {
      $('#river-water-flood-chart').html("");
      $('#river-water-parent-flood-chart').css("margin-top", "-25px");
      $('#river-water-flood-chart').html("<span style='font-size: 14px;padding-top: -25px'>暂无数据</span>");
      $('#river-water-view').hide();
    } else {
      //$('#river-water-parent-flood-chart').css("margin-top","25px");
    }
    $('.river-water-flood').show();
    //$('#river-water-flood-table').css("width","97%").css("height","94%");
    $('#river-water-flood-table').html('<table id="river-water-flood-table-content" ></table>')
    $('#river-water-flood-chart').css("width", "100%").css("height", "100%");

    riverBasicMyWindow = new MyWindow($("#river-basic-data"), {
      title: title
    });
    loadTab();
    riverBasicMyWindow.dom.css("z-index", "-999");
    riverBasicMyWindow.show();
    var clickTableHeight = getMoniterClickTableHeight(riverBasicMyWindow);
    $('#river-water-flood-chart').show();
    resizeChartContainerSize(riverBasicMyWindow)
    result.title = name;
    getWaterFloodData(result, clickTableHeight, riverBasicMyWindow); //水位流量关系曲线
    //资料文档
    getWaterFloodDataDocument(mocd);
    riverBasicMocd = mocd
    setTimeout(callback, 1000);

    function callback() {
      initDetailWinImg(mocd, 4);
      loadHtml2canvas(riverBasicMyWindow, 'river-basic-data', 'detail-four', {
        mocd: mocd,
        num: 4
      });
    };
    riverBasicMyWindow.resizecbfn(function () {
      resizeWaterLevelChartTableHeight("river-water-flood-table-content", riverBasicMyWindow); //水位流量放大窗口
      resizeTablePaddingBottom(riverBasicMyWindow);
      resizeChartContainerSize(riverBasicMyWindow)
      resizeChart();
    });

  });
  //河道快报预警
  getReservoirEarlyWarningClickData(obj, "mapPoint", rightData);
  for (var i = 0; i < rightData.length; i++) {
    if (rightData.indexOf("video") !== -1) {
      inlitVideoData(mocd);//视频
    }
  }
  //getReservoirVideoData();
  //    周边信息
  // initLoadPeripheral(mocd);
  // getRiverVideoData();
};
//得到河道来水预报
var getRiverForeRain = function (params, done) {
  ajaxCallJson({
    mocd: params.mocd,
    type: params.type
  }, '/floodSituation/fore/rain', function (result) { //获取来水预报
    if (!result) {
      return;
    }
    var title = name + "来水预报";
    var data = result.data;
    if (!data) {
      done(null);
      return;
    }
    if (data.rainData.length == 0) {
      done(null);
      return;
    }
    $("#detail-one").find(".title").html("来水预报");
    data.rainId = params.rainId;
    data.otherId = params.otherId;
    data.type = params.type;
    var columns = [{
      field: 'id',
      title: '序号',
      align: 'center'
    },
    {
      field: 'time',
      title: '时间',
      sortable: true,
      align: 'center'
    },
    {
      field: 'rain',
      title: '降水(mm)',
      align: 'center'
    },
    ];
    if (data.realFlood.length != 0) {
      columns.push({
        field: 'rf',
        title: '实测流量(m³/s)',
        align: 'center'
      })
    }
    if (data.forecastFlood.length != 0) {
      columns.push({
        field: 'ff',
        title: '预报流量(m³/s)',
        align: 'center'
      });
    }
    var tableData = [];
    for (var i = 0; i < data.xData.length; i++) {
      var temp = {};
      temp.id = i + 1;
      temp.time = data.xData[i];
      temp.rain = data.rainData[i];
      if (data.realFlood[i] != undefined && data.realFlood[i] != "-") {
        temp.rf = data.realFlood[i];
      }
      if (data.forecastFlood[i] != undefined && data.forecastFlood[i] != "-") {
        temp.ff = data.forecastFlood[i];
      }
      tableData.push(temp)
    }
    data.table = {
      columns: columns,
      data: tableData,
      id: params.tableId
    }
    done(data)
  });
}

//河道来水预报窗口
var initEnlargeRiverRainWin = function (result, name, mocd, rightData) {
  // initSmallWin('detail-one');
  var myWindow = new MyWindow($("#forecast-rain"), {
    title: name + "-来水预报"
  });
  $('#forecast-rain-chart').css("width", "100%").css("height", "45%");
  $('#forecast-other-chart').css("width", "100%").css("height", "55%");
  $('#reservoir-rain-right-chart').css("width", "100%").css("height", "45%");
  $('#reservoir-other-right-chart').css("width", "100%").css("height", "55%");
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.tableHeight = getMoniterClickTableHeight(myWindow);
  resizeChartContainerSize(myWindow);
  //初始化界面
  myWindow.body.find('.chart-container').show();
  $('#river-rain-table').hide();
  $('#river-rain-view').css("margin-top", "23px");
  $('#river-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  result.title = name + "-来水预报";
  initRainForecast(result, myWindow);
  for (var i = 0; i < rightData.length; i++) {
    if (rightData.indexOf("fore") !== -1) {
      $("#detail-one").css("display", "none");
      $("#monitor-detail").css("display", "none");
      return
    }
  }
  myWindow.resizecbfn(function () {
    if (result.table) {
      resizeChartTableHeight(result.table.id, myWindow);
      resizeTablePaddingBottom(myWindow)
    }
    resizeChartContainerSize(myWindow)
    resizeChart();
  });
  setTimeout(callback, 1000);

  function callback() {
    initDetailWinImg(mocd, 1);
    loadHtml2canvas(myWindow, 'forecast-rain', 'detail-one', {
      mocd: mocd,
      num: 1
    });
  };
  var startTime = result.publishTime,
    endTime = result.xData[result.xData.length - 1];
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出所有" ></a><a href="/floodSituation/fore/rain?mocd=' + mocd + '&startTime=' + startTime + '&endTime=' + endTime + '"><img src="/images/icon/export-forecast.png"  title="导出预报" ></a>');
  $('#river-rain-view').attr('flag', "chart");
  myWindow.body.find('.chart-container').show();
  $('#river-rain-table').hide();
  $('#river-rain-view').removeClass('has-export');
  $('#river-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').hide();
  $('#river-rain-view').bind('click', function () {
    if ($('#river-rain-view').attr('flag') == "chart") {
      $('#river-rain-view').css("margin-top", "5px");
      $('#river-rain-view').attr('flag', 'table');
      myWindow.body.find('.chart-container').hide();
      $('#river-rain-table').show();
      if ($("#river-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc') == false && $("#river-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('desc') == false) {
        $("#river-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      if ($("#river-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc')) {
        $("#river-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      $('#river-rain-view').addClass('has-export');
      $('#river-rain-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
      myWindow.body.find('.export-excel').show();
    } else {
      $('#river-rain-view').css("margin-top", "23px");
      $('#river-rain-view').attr('flag', "chart");
      myWindow.body.find('.chart-container').show();
      $('#river-rain-table').hide();
      $('#river-rain-view').removeClass('has-export');
      $('#river-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      resizeChart();
    }
  });
}
//河道横断面示意图初始化
var initEnlargeRiverCrossWin = function (result, title, mocd) {
  initSmallWin('detail-right-peripheral');
  var myWindow = new MyWindow($("#cross-sectional"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.title = title;
  $('#detail-right-peripheral').css("width", "490px").css("height", "240px");
  createSectionView("detail-right-peripheral-content", result, myWindow);
  //var p=new PlayImage("#cross-sectional-chart",iData);
  monitorWindow.push(myWindow);
  // setTimeout(callback, 1700);
  //
  // function callback() {
  //     loadHtml2canvas(myWindow, 'cross-sectional', 'detail-right-peripheral', {
  //         mocd: mocd,
  //         num: 10
  //     });
  // };

}
//河道纵断面示意图初始化
var initEnlargeRiverVerticalWin = function (result, title, mocd) {
  initSmallWin('detail-three');
  var myWindow = new MyWindow($("#vertical-sectional"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.title = title;
  createVerticalSectionView("vertical-sectional", result, myWindow);
  //var p=new PlayImage("#cross-sectional-chart",iData);
  monitorWindow.push(myWindow);
  setTimeout(callback, 1700);

  function callback() {
    loadHtml2canvas(myWindow, 'vertical-sectional', 'detail-three', {
      mocd: mocd,
      num: 3
    });
  };
}

//河道资料文档
function getWaterFloodDataDocument(mocd) {
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: ""
  }, '/floodSituation/data/document', function (result) {
    if (!result.xData || result.xData == "") {
      $("#river-basic-document").hide();
      $(".river-basic-document").hide();
      return;
    }
    var obj = getZtreeDataFirstData(result.xData);
    showPointBaseData(obj.data, 3, obj.first);
  })
}

//河道成果报告
var initRiverReportWin = function (title) {
  $("#detail-report").find(".title").html("成果报告");
  initSmallWin('detail-report');
  var myWindow = new MyWindow($('#river-report'), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  initReportSmallWin("detail-report", myWindow, obj_type_river)
};
var initReportSmallWin = function (id, myWindow, type) {
  var pHtml;
  switch (type) {
    case obj_type_mountain_torrents:
      pHtml = '<img src="/images/base/mountain-report.png" />';
      break;
    case obj_type_river:
      pHtml = '<img src="/images/base/river-report.png" />';
      break;
    case obj_type_reservoir:
      pHtml = '<img src="/images/base/reservoir-report.png" />';
      break;
    case obj_type_waterlogged:
      pHtml = '<img src="/images/base/waterlogged-report.png" />';
      break;
    default:
      pHtml = '<img src="/images/base/trend.png" />';
  }
  $('#' + id).find(".content-img").html(pHtml);
  $('#' + id).find(".content-img").css("display", "block");
  $('#' + id + ' img').css({
    height: 105,
    width: 150,
    margin: "0px",
    border: "none"
  });
  $('#' + id + ' .content-img').unbind('click').bind('click', function () {
    myWindow.dom.css("z-index", 999);
    myWindow.show();
  })
  $('#' + id).show();
}

/**河道 end**/


/**城镇 start**/
//城镇双击信息
function getCityDbClickData(params) {
  var mocd = params.mocd;
  var name = params.name;
  $('.monitor-detail-title').html(name);
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/city/section', function (result) {
    if (!result) {
      layer.close(doubleClickLayer);
      return;
    }
    var title = name + "-来水预报";
    var data = result.data;
    if (!data || data == "") {
      layer.close(doubleClickLayer);
      return;
    }
    $("#detail-one").find(".title").html("来水预报");
    initDetailWinImg(mocd, 1);
    initCitySectionRainWin(data, title, mocd);
    layer.close(doubleClickLayer);
  });
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/city/data', function (result) { //获取城镇基本信息
    if (!result.data || result.data == "") {
      return;
    }
    var title = name + "-基础信息";
    $("#detail-basic").find(".title").html("基础信息");
    initCityBasicDataWin(result, mocd, title);
  });
  initCityPlanWin(mocd, name); //获取城镇预案
  initCityRiskWin(mocd, name); //获取城镇风险图
  $.get('/report/getReportByObj?mocd=' + mocd, function (data, status) {
    if (status == 'success' && data != 0) {
      var title = name + "-成果报告";
      $('#city-report-content').html();
      $('#city-report-content').html('<iframe src="/report/getReportByObj?mocd=' + mocd + '" width="100%" height="99%" frameborder=0 scrolling="no"></iframe>')
      initCityReportWin(title);
    }
  });
  ajaxCallJson({
    id: mocd
  }, '/video/getVideoCode', function (_data) {
    if (_data && _data.data && _data.data.length > 0) {
      videoUrl = '/video/getVideoView?id=' + mocd;
      videoTitle = "图像监控";
    } else {
      $("#detail-video").hide();
    }
  });
  //  getCityVideoData();
}

//城镇监控视频
var getCityVideoData = function () {
  initSmallWin('detail-video');
  var myWindow = new MyWindow($("#monitor-city-video"), {
    title: "图像监控"
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  $('#detail-video img').unbind('click').bind('click', function () {
    myWindow.dom.css("z-index", 999);
    myWindow.show();
  });
  setCenter()
}
//初始化城镇河道断面来水预报
var initCitySectionRainWin = function (data, title, mocd) {
  initSmallWin("detail-one");
  var html = "<span style='font-size: 14px'>暂无数据</span>";
  if (data) {
    if (data.length != 0) {
      html = '<select style="background-color: rgba(18, 51, 51, 0.7);color: #fff;" class="form-control">'
      for (var i = 0; i < data.length; i++) {
        html += '<option value="' + data[i].mocd + '">' + data[i].sectnm + '</option>';
      }
    }
  }
  $("#city-section-choose").html(html);
  var myWindow = new MyWindow($("#monitor-city-section"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  var mocd = $("#city-section-choose select").val();
  createCityRainChart(mocd);
  $("#city-section-choose select").change(function () {
    var mocd = $("#city-section-choose select").val();
    createCityRainChart(mocd)
  });
  myWindow.resizecbfn(function () {
    resizeChartTableHeight('city-section-table-content', myWindow);
    resizeTablePaddingBottom(myWindow);
    resizeChartContainerSize(myWindow)
    resizeChart();
  })
  setTimeout(callback, 3000);

  function callback() {
    loadHtml2canvas(myWindow, 'monitor-city-section', 'detail-one', {
      mocd: mocd,
      num: 1
    });
  };
  var startTime = result.publishTime,
    endTime = result.xData[result.xData.length - 1];
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出所有" ></a><a href="/floodSituation/fore/rain?mocd=' + mocd + '&startTime=' + startTime + '&endTime=' + endTime + '"><img src="/images/icon/export-forecast.png"  title="导出预报" ></a>');

  function createCityRainChart(mocd) {
    if (!mocd) {
      return
    }
    ;
    $('#city-rain-view').show();
    $('#city-section-table').html('<table id="city-section-table-content"></table>');
    getRiverForeRain({
      mocd: mocd,
      rainId: "city-section-rain-chart",
      otherId: "city-section-other-chart",
      tableId: 'city-section-table-content',
      type: obj_type_river_section
    }, function (params) {
      $('#city-section-rain-chart').css("width", "100%").css("height", "45%");
      $('#city-section-other-chart').css("width", "100%").css("height", "55%");
      resizeChartContainerSize(myWindow)
      params.tableHeightget = getMoniterClickTableHeight(myWindow);
      myWindow.body.find('.chart-container').show();
      $('#city-section-table').hide();
      $('#city-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      initRainForecast(params, myWindow);
      $('#city-rain-view').attr('flag', "chart");
      myWindow.body.find('.chart-container').show();
      $('#city-section-table').hide();
      $('#city-rain-view').removeClass('has-export');
      $('#city-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      $('#city-rain-view').unbind('click').bind('click', function () {
        if ($('#city-rain-view').attr('flag') == "chart") {
          $('#city-rain-view').attr('flag', 'table');
          myWindow.body.find('.chart-container').hide();
          $('#city-section-table').show();
          $('#city-rain-view').addClass('has-export');
          $('#city-rain-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
          myWindow.body.find('.export-excel').show();
        } else {
          $('#city-rain-view').attr('flag', "chart");
          myWindow.body.find('.chart-container').show();
          $('#city-section-table').hide();
          $('#city-rain-view').removeClass('has-export');
          $('#city-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
          myWindow.body.find('.export-excel').hide();
          resizeChart();
        }
      });
    })
  }
}
//初始化城镇基本信息窗口
var initCityBasicDataWin = function (result, mocd, title) {
  initSmallWin('detail-basic');
  $('#detail-basic').show();
  var myWindow = new MyWindow($("#monitor-city-data"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  var content = $("#monitor-city-data-top");
  var contentHtml = "<table style='width: 100%'>" +
    "<tr><td width='45px'>城镇名称：</td><td >" + (result.data.dtnm == undefined ? "" : result.data.dtnm) + "</td><td style='border-left: 1px solid'></td><td width='45px'>地址:</td><td >" + (result.data.address == undefined ? "" : result.data.address) + "</td><td style='border-left: 1px solid'></td><td width='45px'>城镇概况:</td><td >" + (result.data.desc == undefined ? "" : result.data.desc) + "</td><td style='border-left: 1px solid'></td><td width='45px'>房屋数(间):</td><td>" + (result.data.housecount == undefined ? "" : result.data.housecount) + "</td></tr>" +
    "<tr><td width='45px'>家庭户数(户):</td><td >" + (result.data.familycount == undefined ? "" : result.data.familycount) + "</td><td style='border-left: 1px solid'></td><td width='45px'>备注:</td><td >" + (result.data.remark == undefined ? "" : result.data.remark) + "</td><td style='border-left: 1px solid'></td><td width='45px'>总人口(万人):</td><td >" + (result.data.population == undefined ? "" : result.data.population) + "</td> <td style='border-left: 1px solid'></td><td width='45px'>土地面积(km²):</td><td>" + (result.data.landarea == undefined ? "" : result.data.landarea) + "</td></tr>" +
    "<tr><td width='45px'>耕地面积(亩):</td><td >" + (result.data.cultivated == undefined ? "" : result.data.cultivated) + "</td><td style='border-left: 1px solid'></td><td width='45px'>国内生产总值(万元):</td><td >" + (result.data.gdp == undefined ? "" : result.data.gdp) + "</td><td style='border-left: 1px solid'></td></tr>" +
    "</table>"
  content.html(contentHtml);
  //资料文档
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: ""
  }, '/floodSituation/controlTownData/document', function (result) {
    if (!result) {
      return;
    }
    if (!result.xData || result.xData == "" || result.xData.length == 0) {
      $("#monitor-city-data-left").html("<span style='font-size: 14px'>资料文档暂无数据</span>");
      $("#monitor-city-data-tree").html("");
      return;
    }
    if (!result.xData || result.xData != "" || result.xData.length != 0) {
      var obj = getZtreeDataFirstData(result.xData);
      showPointBaseData(obj.data, typr = 5, obj.first);
    }
  })
  addImageToDetail("/images/base/moniter-data.png", 'detail-basic', myWindow);
}

//初始化城镇预案窗口
var initCityPlanWin = function (mocd, name) {
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: "CZSTON08"
  }, '/floodSituation/data/document', function (result) {
    if (!result.xData || result.xData == "") {
      return;
    }
    var title = name + "-城镇预案";
    $("#detail-two").find(".title").html("城镇预案");
    initSmallWin('detail-two');
    $('#detail-two').show();
    var myWindow = new MyWindow($("#monitor-city-plan"), {
      title: title
    });
    myWindow.dom.css("z-index", "-999");
    myWindow.show();
    var obj = getZtreeDataFirstData(result.xData);
    showPointBaseData(obj.data, 6, obj.first);
    addImageToDetail("/images/base/cityPlan.png", 'detail-two', myWindow);
  })

}
//初始化城镇风险图窗口
var initCityRiskWin = function (mocd, name) {
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: "CZSTON09"
  }, '/floodSituation/data/document', function (result) {
    if (!result) {
      return;
    }
    if (!result.xData || result.xData == "") {
      return;
    }
    var title = name + "-城镇风险图";
    $("#detail-three").find(".title").html("城镇风险图");
    $('#monitor-city-risk').css("text-align", "center")
    initSmallWin('detail-three');
    $('#detail-three').show();
    var myWindow = new MyWindow($("#monitor-city-risk"), {
      title: title
    });
    var obj = getZtreeDataFirstData(result.xData);
    showPointBaseData(obj.data, 7, obj.first);
    // setTimeout(callback,1000);
    // function callback() {
    //     loadHtml2canvas(myWindow,'monitor-city-risk','detail-three');
    // };
    addImageToDetail("/images/base/cityRisk.png", 'detail-three', myWindow);
  })

}
//城鎮图像监控
var initCityVideo = function () {
  $('#detail-video .content-img').css('display', 'block');
  $('#monitor-city-video').parent().css("z-index", -100);
}
var initCityReportWin = function (title) {
  $("#detail-report").find(".title").html("成果报告");
  initSmallWin('detail-report');
  var myWindow = new MyWindow($('#city-report'), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  initReportSmallWin("detail-report", myWindow, obj_type_city)
};

/**城镇 end**/

/**水库水电站 start**/
function getReservoirDbClickData(params, obj, rightData) {
  noReservoirStageHtml(rightData);//判断右侧显示哪两个
  var mocd = params.mocd;
  var name = params.name;
  currentType = obj_type_reservoir;
  $('.monitor-detail-title').html(name);
  initPostInflowForecast(mocd, name, rightData, obj_type_reservoir);//来水预报
  realTimeReservoir(mocd, name);//水库实时信息
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/dispatch/data', function (result) { //获取水库调度
    if (!result) {
      return;
    }
    var data = result.data;
    if (!data) {
      return;
    }
    var title = name + "-水库调度";
    $("#detail-two").find(".title").html("水库调度");
    data.id = "reservoir-dispatch-chart";
    $('#reservoir-dispatch-table').html('<table id="dispatch-table-content"></table>');
    data.tableId = "dispatch-table-content";
    initReservoirDispatchWin(data, title, mocd);
  });
  // initLoadPeripheral(mocd);//水库周边信息
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/dam/getRsvrFeature', function (_data) {
    if (_data && _data.flag && _data.data) {
      if (_data.data.max == 0) {
        // $("#peripheral-information-max").hide();
        return;
      }
      $("#monitor-detail-right").show();
      $("#peripheral-information-max").show();
      reservoirDamWindow = "";
      initDetailWinImg(mocd, 10);
      //初始化大坝示意图
      $('#reservoir-dam-chart').html('');
      $("#detail-right-peripheral-content").html('');
      $('#reservoir-dam-chart').css("text-align", "center");
      $('#reservoir-dam-chart').css("width", "100%").css("height", "100%");
      $('#detail-right-peripheral').css("width", "490px").css("height", "240px");
      var myNewChart = createDamView("detail-right-peripheral-content", _data.data, "");
      changeType = 1;
      // $("#peripheral-information").click();
    }
  });
  initReservoirDataWin(mocd, name); //获取基础信息
  //获取溃坝信息
  ajaxCallJson({
    mocd: currentStcd
  }, '/floodSituation/dam/break', function (result) { //获取水库调度
    if (!result) {
      return;
    }
    if (result.data && result.data.length == 0) {
      return;
    }
    if (result.flag == false) {
      return;
    }
    if (result.data == null) {
      return;
    }
    var title = name + "-水库溃坝";
    $("#detail-dam-break").find(".title").html("水库溃坝");
    $("#detail-dam-break").css("display", "inline-block");
    $('#detail-dam-break .content-img').css('display', 'block');
  });
  for (var i = 0; i < rightData.length; i++) {
    if (rightData.indexOf("video") !== -1) {
      inlitVideoData(mocd);//视频
    }
  }
  //水库预警
  getReservoirEarlyWarningClickData(obj, "mapPoint", rightData);
}
function getReservoirEarlyWarningClickData(obj, clickType, rightData) {
  var title = obj.monm + "预警";
  var mocd = obj.mocd;

  $(".early-warning-box-title").css({
    "height": "30px",
    "display": "flex",
    "justify-content": "center",
    "align-items": "center"
  })
  $('.early-warning-chart').css({
    "width": "100%",
    "height": "33.3%"
  });
  $(".early-warning-box-title").css({
    "height": "30px",
    "display": "flex",
    "justify-content": "center",
    "align-items": "center"
  })

  var params = {
    eacId: obj.topoid,
    recent: "720", //一个月的数据
    type: "1",
    time: obj.warntime ? moment(obj.warntime).valueOf() / 1000 : 0
  };
  //请求过程线数据
  currentChartParam = params;
  ajaxCallJson(params, '/tempRouter', function (result) { //获取来水预报
    if (result.flag) {
      var objGridArr = [option1OpenGrid, option2OpenGrid, option3OpenGrid];
      if (result.info != null) {
        for (var i = 0; i < rightData.length; i++) {
          if (rightData.indexOf("flood") === -1) {
            $("#detail-reservoir-waring").css("display", "inline-block");
            $("#detail-reservoir-waring").find(".title").html("预警");
            var myWindow1 = new MyWindow($('#reservoir-monitor-early-warning'), {
              title: title
            });
            myWindow1.dom.css("z-index", "-999");
            myWindow1.show();
            myWindow1.resizecbfn(function () {
              resizeMiniChart();
            });
            setTimeout(callback, 1000);

            function callback() {
              initDetailWinImg(mocd, 13);
              loadHtml2canvas(myWindow1, 'reservoir-monitor-early-warning', 'detail-reservoir-waring', {
                mocd: mocd,
                num: 13
              });
            };
            break;
          } else {
            $("#detail-reservoir-waring").css("display", "none");
          }
        }
        newChart(result.info, objGridArr, "notReservoirMapPoint");
      }
    }
  })
}

var videoWindow = new MyWindow();
var videoUrl = '';
var videoTitle = '';
$("#detail-video img").click(function () {
  if (videoUrl.length > 0) {
    videoWindow = new MyWindow();
    videoWindow.isClose = true;
    videoWindow.setWindow(videoUrl, {
      title: videoTitle
    });
    videoWindow.dom.css("z-index", "999");
    videoWindow.show();
  }
});
//请求来水预报-水库降水格式
function initPostInflowForecast(mocd, name, rightData, type, clickType) {
  if (clickType === "maxRightClick") {
    rightMaxChartArray.forEach(function (chart) {
      chart.dispose();
    });
    rightMaxChartArray.clear();
  }
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/fore/rain', function (result) { //获取来水预报
    if (!result) {
      layer.close(doubleClickLayer);
      return;
    }
    // console.info(result)
    var title = name + "-来水预报";
    var data = result.data;
    if (!data || data == "") {
      return;
    }
    if (data.rainData.length == 0) {
      layer.close(doubleClickLayer);
      return;
    }
    $("#detail-one").find(".title").html("来水预报");
    data.rainId = 'reservoir-rain-chart';
    data.otherId = 'reservoir-other-chart';
    for (var i = 0; i < rightData.length; i++) {
      if (rightData.indexOf("fore") !== -1) {
        data.rainId = 'reservoir-rain-right-chart';
        data.otherId = 'reservoir-other-right-chart';
      }
    }
    if (clickType === "maxRightClick") {//右侧放大窗口点击
      data.rainId = 'reservoir-rain-chart';
      data.otherId = 'reservoir-other-chart';
    }
    data.type = type;
    var columns = [{
      field: 'id',
      title: '序号',
      align: 'center'
    }, {
      field: 'time',
      title: '时间',
      sortable: true,
      align: 'center'
    },
    {
      field: 'rain',
      title: '降水(mm)',
      align: 'center'
    }
    ];
    if (data.realInFlood.length != 0) {
      columns.push({
        field: 'rif',
        title: '实测入库(m³/s)',
        align: 'center'
      })
    }
    ;
    if (data.foreInFlood.length != 0) {
      columns.push({
        field: 'fif',
        title: '预报入库(m³/s)',
        align: 'center'
      })
    }
    if (data.realOutFlood.length != 0) {
      columns.push({
        field: 'rof',
        title: '实测出库(m³/s)',
        align: 'center'
      })
    }
    var tableData = [];
    for (var i = 0; i < data.xData.length; i++) {
      var temp = {};
      temp.id = i + 1;
      temp.rain = data.rainData[i];
      temp.time = data.xData[i];
      if (data.realInFlood[i] != undefined && data.realInFlood[i] != "-") {
        temp.rif = data.realInFlood[i];
      }
      if (data.foreInFlood[i] != undefined && data.foreInFlood[i] != "-") {
        temp.fif = data.foreInFlood[i];
      }
      if (data.realOutFlood[i] != undefined && data.realOutFlood[i] != "-") {
        temp.rof = data.realOutFlood[i];
      }
      tableData.push(temp);
    }
    $('#reservoir-rain-table').html('<table id="reservoir-rain-table-content"></table>');
    data.table = {
      columns: columns,
      data: tableData,
      id: 'reservoir-rain-table-content'
    }
    initReservoirRainWin(data, title, mocd, rightData, clickType);
    layer.close(doubleClickLayer);
  });
}
//初始化水库水电站来水预报窗口
var initReservoirRainWin = function (result, title, mocd, rightData, clickType) {
  initSmallWin('detail-one');
  var myWindow = new MyWindow($("#reservoir-fore-rain"), {
    title: title
  });
  $('#reservoir-rain-chart').css("width", "100%").css("height", "45%");
  $('#reservoir-other-chart').css("width", "100%").css("height", "55%");
  $('#reservoir-rain-right-chart').css("width", "100%").css("height", "45%");
  $('#reservoir-other-right-chart').css("width", "100%").css("height", "55%");
  myWindow.dom.css("z-index", "-999");
  if (clickType === "maxRightClick") {
    myWindow.dom.css("z-index", "999");
  }
  myWindow.show();
  resizeChartContainerSize(myWindow);
  result.tableHeight = getMoniterClickTableHeight(myWindow);
  myWindow.body.find(".chart-container").show();
  var startTime = result.publishTime,
    endTime = result.xData[result.xData.length - 1];
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出所有" ></a><a href="/floodSituation/fore/rain?mocd=' + mocd + '&startTime=' + startTime + '&endTime=' + endTime + '"><img src="/images/icon/export-forecast.png"  title="导出预报" ></a>');
  $('#reservoir-rain-table').hide();
  $('#reservoir-rain-view').css("margin-top", "23px")
  $('#reservoir-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  result.title = title;
  initRainForecast(result, myWindow, clickType);
  myWindow.resizecbfn(function () {
    if (result.table) {
      resizeChartTableHeight(result.table.id, myWindow);
      resizeTablePaddingBottom(myWindow);
    }
    resizeChartContainerSize(myWindow);
    resizeChart();
  });
  $('#reservoir-rain-view').attr('flag', "chart");
  myWindow.body.find(".chart-container").show();
  $('#reservoir-rain-table').hide();
  $('#reservoir-rain-view').removeClass('has-export');
  $('#reservoir-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').hide();
  $('#reservoir-rain-view').unbind('click').bind('click', function () {
    if ($('#reservoir-rain-view').attr('flag') == "chart") {
      $('#reservoir-rain-view').attr('flag', 'table');
      myWindow.body.find(".chart-container").hide();
      $('#reservoir-rain-view').addClass('has-export');
      $('#reservoir-rain-view').css("margin-top", "5px")
      $('#reservoir-rain-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
      $('#reservoir-rain-table').show();
      if ($("#reservoir-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc') == false && $("#reservoir-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('desc') == false) {
        $("#reservoir-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      if ($("#reservoir-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc')) {
        $("#reservoir-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      myWindow.body.find('.export-excel').show();
    } else {
      $('#reservoir-rain-view').css("margin-top", "23px")
      $('#reservoir-rain-view').attr('flag', "chart");
      myWindow.body.find(".chart-container").show();
      $('#reservoir-rain-table').hide();
      $('#reservoir-rain-view').removeClass('has-export');
      $('#reservoir-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      resizeChart();
    }
  });
  for (var i = 0; i < rightData.length; i++) {
    if (rightData.indexOf("fore") !== -1) {
      $("#detail-one").css("display", "none")
      // $("#monitor-detail").css("display","none");
      return
    }
  }
  setTimeout(callback, 100);

  function callback() {
    initDetailWinImg(mocd, 1);
    loadHtml2canvas(myWindow, 'reservoir-fore-rain', 'detail-one', {
      mocd: mocd,
      num: 1
    });
  };
};
//初始化水库水电站水库调度窗口
var initReservoirDispatchWin = function (result, title, mocd) {

  var myWindow = new MyWindow($("#reservoir-dispatch"), {
    title: title
  });
  $('#reservoir-dispatch-chart').css("width", "100%").css("height", "100%");
  //initSmallWin('detail-dispatch');
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  resizeChartContainerSize(myWindow)
  var th = getMoniterClickTableHeight(myWindow);
  result.tableHeight = th;
  myWindow.body.find('.chart-container').show();
  $('#reservoir-dispatch-table').hide();
  $('#reservoir-dispatch-view').css("margin-top", "25px");
  $('#reservoir-dispatch-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/dispatch/data?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出excel" ></a>');
  result.isShowToolbox = true;
  result.title = title;
  initReservoirDispatchChart(result, myWindow);
  myWindow.resizecbfn(function () {
    resizeChartTableHeight(result.tableId, myWindow);
    resizeTablePaddingBottom(myWindow);
    resizeChartContainerSize(myWindow)
    resizeChart();
  });
  setTimeout(callback, 1000);

  function callback() {
    initDetailWinImg(mocd, 2);
    loadHtml2canvas(myWindow, 'reservoir-dispatch', 'detail-two', {
      mocd: mocd,
      num: 2
    });
  };
  $('#reservoir-dispatch-view').css("margin-top", "25px");
  $('#reservoir-dispatch-view').attr('flag', "chart");
  myWindow.body.find('.chart-container').show();
  $('#reservoir-dispatch-table').hide();
  $('#reservoir-dispatch-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').hide();
  $('#reservoir-dispatch-view').unbind('click').bind('click', function () {
    if ($('#reservoir-dispatch-view').attr('flag') == "chart") {
      $('#reservoir-dispatch-view').css("margin-top", "5px");
      $('#reservoir-dispatch-view').attr('flag', "table");
      myWindow.body.find('.chart-container').hide();
      $('#reservoir-dispatch-table').show();
      $('#reservoir-dispatch-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
      myWindow.body.find('.export-excel').show();
    } else {
      $('#reservoir-dispatch-view').css("margin-top", "25px");
      $('#reservoir-dispatch-view').attr('flag', "chart");
      myWindow.body.find('.chart-container').show();
      $('#reservoir-dispatch-table').hide();
      $('#reservoir-dispatch-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      resizeChart();
    }
  });
};
//
var initReservoirReportWin = function (title) {
  $("#detail-report").find(".title").html("成果报告");
  //initSmallWin('detail-report');
  $('#detail-report').show();
  var myWindow = new MyWindow($('#reservoir-report'), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  initReportSmallWin("detail-report", myWindow, obj_type_reservoir);
}
//水库监控视频
var initReservoirVideo = function () {
  $('#detail-video').show();
  $('#detail-video  .content-img').show();
}
//水库基本信息
var initReservoirDataWin = function (mocd, name) {
  var title = name + "-基础信息";
  $("#detail-four").find(".title").html("基础信息");
  //initSmallWin('detail-basic');
  $('#water-storage').css("background", "rgba(25, 136, 211, 0.6)");
  $('#water-area').css("background", "rgba(96, 96, 96, 0.6)");
  $('#basic-data-left-one-chart').css("width", "100%").css("height", "100%");
  $('#basic-data-left-two-chart').css("width", "100%").css("height", "100%");
  var myWindow = new MyWindow($("#reservoir-basic-data"), {
    title: title
  });
  loadTab();
  $('#basic-data-left-one-chart').show();
  $('#basic-data-left-table').hide();
  $('#basic-data-left-one-chart').html("");

  $('#basic-data-left-view').attr('flag', 'chart');
  $("#basic-data-left-view").css("margin-top", "25px");
  $('#reservoir-data-basic-top').css('display', 'none');
  $('#basic-data-left-view').html('<img src="/images/data-table.png"  class="data-table" title="数据图表"  >');
  var clickTableHeight = getMoniterClickTableHeight(myWindow);
  initReservoirRight(mocd, clickTableHeight, myWindow); //水库基本信息
  earlyWarningSinglePointWindow = myWindow;
  reservoirBasicMocd = mocd;
  initReservoirReleaseFlood(mocd, clickTableHeight, myWindow);
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  setTimeout(callback, 1000);

  function callback() {
    initDetailWinImg(mocd, 4);
    $('#reservoir-basic-data a[name=".reservoir-release-flood"]').removeClass('current');
    $('#reservoir-basic-data a[name=".reservoir-basic-document"]').removeClass('current');
    loadHtml2canvas(myWindow, 'reservoir-basic-data', 'detail-four', {
      mocd: mocd,
      num: 4
    }, function () {
      if ($('#reservoir-basic-data a[name=".reservoir-release-flood"]').attr('class') != 'current') {
        $('.reservoir-release-flood').hide();
      }
      if ($('#reservoir-basic-data a[name=".reservoir-basic-document"]').attr('class') != 'current') {
        $('.reservoir-basic-document').hide();
      }
    });
  };
  myWindow.resizecbfn(function () {
    resizeWaterLevelChartTableHeight("basic-data-left-table-content", myWindow); //水位库容放大窗口
    resizeChartTableHeight("reservoir-release-flood-content", myWindow); //防洪曲线放大窗口
    resizeChart();
    resizeTablePaddingBottom(myWindow)
  });
}
//水库基本信息
var reservoirBaseDataArray, reservoirBaseDataWindow;

function initReservoirRight(mocd, clickTableHeight, win) {

  ajaxCallJson({
    mocd: mocd
  }, "/floodSituation/rsvrbase/Info", function (result) {
    if (!result) {
      return;
    }
    reservoirBaseDataArray = result.data;
    reservoirBaseDataWindow = win;
    var content = $("#basic-data-right");
    var contentHtml = "<table style='width: 100%;text-align: left;' class='base-'>" +
      "<tr><td>水库名称：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.rsvrnm == undefined ? "" : result.data.rsvrnm) + "' name='rsvrnm'></td></tr>" +
      "<tr><td>行政区:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.adnm == undefined ? "" : result.data.adnm) + "' name='adnm'></td></tr>" +
      "<tr><td>行政区编码:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.adcd == undefined ? "" : result.data.adcd) + "' name='adcd'></td></tr>" +
      "<tr><td>等级：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.rsvrgrade == undefined ? "" : result.data.rsvrgrade) + "' name='rsvrgrade'></td></tr>" +
      "<tr><td>类型:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.rorh == undefined ? "" : result.data.rorh) + "' name='rorh'></td></tr>" +
      "<tr><td>经度：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.lgtd == undefined ? "" : result.data.lgtd) + "' name='lgtd'></td></tr>" +
      "<tr><td>纬度:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.lttd == undefined ? "" : result.data.lttd) + "' name='lttd'></td></tr>" +
      "<tr><td>水库位置：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.address == undefined ? "" : result.data.address) + "' name='address'></td></tr>" +
      "<tr><td>坝址控制流域面积(km²):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.controlarea == undefined ? "" : result.data.controlarea) + "' name='controlarea'></td></tr>" +
      "<tr><td>坝址多年平均径流量(万m³)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.avgvolumeofr == undefined ? "" : result.data.avgvolumeofr) + "' name='avgvolumeofr'></td></tr>" +
      "<tr><td>水库类型:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.rsvrtp == undefined ? "" : result.data.rsvrtp) + "' name='rsvrtp'></td></tr>" +
      "<tr><td>类型：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.damtp == undefined ? "" : result.data.damtp) + "' name='damtp'></td></tr>" +
      "<tr><td>挡水主坝类型按材料分:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.materialtp == undefined ? "" : result.data.materialtp) + "' name='materialtp'></td></tr>" +
      "<tr><td>挡水主坝类型按结构分：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.structuretp == undefined ? "" : result.data.structuretp) + "' name='structuretp'></td></tr>" +
      "<tr><td>主要泄洪建筑物型式:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.sluicetp == undefined ? "" : result.data.sluicetp) + "' name='sluicetp'></td></tr>" +
      "<tr><td>建成时间(年)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.activtm == undefined ? "" : (result.data.activtm).split('.')[0]) + "' name='activtm'></td></tr>" +
      "<tr><td>水库调节性能:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.adjustfunc == undefined ? "" : result.data.adjustfunc) + "' name='adjustfunc'></td></tr>" +
      "<tr><td>工程等别：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.projgrade == undefined ? "" : result.data.projgrade) + "' name='projgrade'></td></tr>" +
      "<tr><td>主坝级别:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.damgrade == undefined ? "" : result.data.damgrade) + "' name='damgrade'></td></tr>" +
      "<tr><td>主坝尺寸坝高(m)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.damheight == undefined ? "" : (result.data.damheight)) + "' name='damheight'></td></tr>" +
      "<tr><td>主坝尺寸坝长(m):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.damlength == undefined ? "" : (result.data.damlength)) + "' name='damlength'></td></tr>" +
      "<tr><td>最大泄洪流量(m³/s)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.hmxotq == undefined ? "" : result.data.hmxotq) + "' name='hmxotq'></td></tr>" +
      "<tr><td>坝顶高程(m):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.damel == undefined ? "" : (result.data.damel)) + "' name='damel'></td></tr>" +
      "<tr><td>设计洪水标准[重现期](年)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.dsflstandard == undefined ? "" : result.data.dsflstandard) + "' name='dsflstandard'></td></tr>" +
      "<tr><td>校核洪水标准[重现期](年):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.ckflstandard == undefined ? "" : result.data.ckflstandard) + "' name='ckflstandard'></td></tr>" +
      "<tr><td>校核洪水位(m)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.ckflz == undefined ? "" : (result.data.ckflz)) + "' name='ckflz'></td></tr>" +
      "<tr><td>设计洪水位(m):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.dsflz == undefined ? "" : (result.data.dsflz)) + "' name='dsflz'></td></tr>" +
      "<tr><td>防洪高水位(m)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.flgz == undefined ? "" : (result.data.flgz)) + "' name='flgz'></td></tr>" +
      "<tr><td>正常蓄水位(m):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.normz == undefined ? "" : (result.data.normz)) + "' name='normz'></td></tr>" +
      "<tr><td>防洪限制水位(m)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.flxz == undefined ? "" : (result.data.flxz)) + "' name='flxz'></td></tr>" +
      "<tr><td>死水位(m):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.ddz == undefined ? "" : (result.data.ddz)) + "' name='ddz'></td></tr>" +
      "<tr><td>总库容(万m³)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.ttcp == undefined ? "" : (result.data.ttcp)) + "' name='ttcp'></td></tr>" +
      "<tr><td>调洪库容(万m³):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.thcp == undefined ? "" : (result.data.thcp)) + "' name='thcp'></td></tr>" +
      "<tr><td>防洪库容(万m³)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.fldcp == undefined ? "" : (result.data.fldcp)) + "' name='fldcp'></td></tr>" +
      "<tr><td>兴利库容(万m³):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.actcp == undefined ? "" : (result.data.actcp)) + "' name='actcp'></td></tr>" +
      "<tr><td>死库容(万m³)：</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.ddcp == undefined ? "" : (result.data.ddcp)) + "' name='ddcp'></td></tr>" +
      "<tr><td>正常蓄水位相应水面面积(km²):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.normzarea == undefined ? "" : result.data.normzarea) + "' name='normzarea'></td></tr>" +
      "<tr><td>设计年供水量(万m³):</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.designywsup == undefined ? "" : result.data.designywsup) + "' name='designywsup'></td></tr>" +
      "<tr><td>水库管理单位名称:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.manaunitnm == undefined ? "" : result.data.manaunitnm) + "' name='manaunitnm'></td></tr>" +
      "<tr><td>水库归口管理部门:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.belongtoman == undefined ? "" : result.data.belongtoman) + "' name='belongtoman'></td></tr>" +
      "<tr><td>所在水资源三级名称:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.watersourcenm == undefined ? "" : result.data.watersourcenm) + "' name='watersourcenm'></td></tr>" +
      "<tr><td>所在河流（湖泊）名称:</td><td><input onblur='changeEarlyWarningInputValue(this)' class='input-update-background-color'  value='" + (result.data.rivernm == undefined ? "" : result.data.rivernm) + "' name='rivernm'></td></tr>"
    "</table>";
    var buttonHtml = "";
    var earlyReservoirTypeData = JSON.parse(privilegeBaseData);
    var earlyReservoirBaseTypeData = false;
    earlyReservoirTypeData.privilege.forEach(function (value) {
      if (value && value.ptype == 7) {
        earlyReservoirBaseTypeData = true;
      }
    });
    if (earlyReservoirBaseTypeData) {
      buttonHtml = '<div id="save-reservoir-base-button" style="position: absolute;bottom: 3px;margin-left: 180px;" onclick="saveReservoirBaseData()"><button class="button-update-background-color">保存</button></div>'
    } else {
      buttonHtml = ""
    }
    content.html(contentHtml + buttonHtml);
    layer.close(doubleClickLayer);
  });
  getReservoirWaterCapacity(mocd, clickTableHeight, win); //水库库容曲线
  $('#basic-data-left-view').unbind('click').bind('click', function () {
    if ($('#basic-data-left-view').attr('flag') == "chart") {
      $("#basic-data-left-view").css("margin-top", "25px");
      $('#basic-data-left-view').attr('flag', 'table');
      $('#basic-data-left-one-chart').hide();
      $("#reservoir-data-basic-top").css("display", "none");
      var earlyWarningType = JSON.parse(privilegeBaseData);
      var earlyWarningTypeData = false;
      earlyWarningType.privilege.forEach(function (value) {
        if (value && value.ptype == 7) {
          earlyWarningTypeData = true;
        }
      });
      if (earlyWarningTypeData) {
        $("#reservoir-data-basic-top").css("display", "block");
      }
      $('#basic-data-left-table').show();
      $('#basic-data-left-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
    } else {
      $("#basic-data-left-view").css("margin-top", "25px");
      $('#basic-data-left-view').attr('flag', "chart");
      $('#basic-data-left-one-chart').show();
      $('#basic-data-left-table').hide();
      $('#reservoir-data-basic-top').css('display', 'none');
      $('#basic-data-left-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      resizeChart();
      loadReservoirBaseData()
    }
  });
  //    资料文档
  ajaxCallJson({
    mocd: mocd,
    reqtype: '0',
    relcd: ""
  }, '/floodSituation/data/document', function (result) {
    if (!result) {
      return;
    }
    if (!result.xData || result.xData == "") {
      $("#reservoir-basic-data-document").css("display", "none");
      $("#reservoir-basic-document-message").css("display", "block");
      return;
    }
    $("#reservoir-basic-data-document").css("display", "block");
    $("#reservoir-basic-document-message").css("display", "none");
    var obj = getZtreeDataFirstData(result.xData);
    showPointBaseData(obj.data, 2, obj.first);
  })
  ////水库三类责任人
  threeResponsiblePersons(mocd, clickTableHeight)
}

//初始化水库泄洪曲线
var initReservoirReleaseFlood = function (mocd, clickTableHeight, win) {
  ajaxCallJson({
    mocd: mocd
  }, "/floodSituation/release/fac", function (result) {
    if (!result) {
      return;
    }
    var data = result.data;
    var html = "";
    if (!data || data.length == 0) {
      html = "<span style='font-size: 14px'>暂无数据</span>";
      $('.reservoir-release-flood').css({
        margin: "auto"
      });
      $('#release-flood-noData').html(html);
      $('.reservoir-release-flood div:first').show();
      $('.reservoir-release-flood div').not(":first").hide();
    } else {
      $('.reservoir-release-flood div:first').hide();
      $('.reservoir-release-flood div').not(":first").show();
      $(".reservoir-release-flood-select div").css('display', 'inline-block');
      html = "<span style='font-size: 14px'>泄洪设施:</span>"
      html += '<select style="background-color: rgba(12, 47, 77, 0.7);border: none;color: #00AEDB;display: inline-block;margin-left: 10px;font-size: 14px" class="form-control">'
      for (var i = 0; i < data.length; i++) {
        var name = data[i].dnnm;
        if (!name) {
          name = data[i].dnid;
        }
        html += '<option value="' + data[i].dnid + '">' + name + '</option>';
      }
      $('#reservoir-release-flood-select').html(html);
      getReservoirReleaseData(mocd, data[0].dnid, clickTableHeight, win);
      $("#reservoir-release-flood-select select").change(function () {
        var id = $("#reservoir-release-flood-select select").val();
        getReservoirReleaseData(mocd, id, clickTableHeight, win);
      })
    }

  })
}
var getReservoirReleaseData = function (mocd, dnid, clickTableHeight, win) {
  ajaxCallJson({
    mocd: mocd,
    dnid: dnid
  }, "/floodSituation/release/data", function (result) {
    if (!result) {
      return;
    }
    var data = result.data;
    var html = "";
    if (!data) {
      html = "<span style='font-size: 14px'>暂无数据</span>";
      $('.reservoir-release-flood').html(html);
    } else {
      if (data[0]) {
        html = "<span style='font-size: 14px'>开度:</span>"
        html += '<select style="background-color: rgba(12, 47, 77, 0.7);border: none;color: #00AEDB;display: inline-block;margin-left: 10px" class="form-control">'
        for (var i = 0; i < data.length; i++) {
          html += '<option value="' + data[i].height + '">' + data[i].height + '</option>';
        }
      }
      $('#reservoir-release-flood-height').html(html);
      createReservoirReleaseChart(data[0], clickTableHeight, win);
      $('#reservoir-release-flood-height select').change(function () {
        var height = $('#reservoir-release-flood-height select').val();
        for (var i = 0; i < data.length; i++) {
          if (data[i].height == height) {
            createReservoirReleaseChart(data[i], clickTableHeight, win);
            return;
          }
        }
      })
    }
  })
}
//生成水库泄洪曲线
var createReservoirReleaseChart = function (data, clickTableHeight, win) {
  if (!data) {
    $('#reservoir-release-flood-chart').html('');
    $('#reservoir-release-table').hide();
    $('#reservoir-release-flood-table').html('');
    return;
  }
  var z = data.z;
  var q = data.otq;
  var value = [];
  for (var i = 0; i < z.length; i++) {
    value[i] = [];
    if (typeof q[i] == 'number') {
      q[i] = q[i];
    }
    value[i][0] = q[i];
    value[i][1] = z[i];
  }
  $('#reservoir-release-flood-table').html(' <table id="reservoir-release-flood-content"></table>');
  var title = win.option.title.substring(0, 4) + "-泄洪曲线";
  var params = {
    id: 'reservoir-release-flood-chart',
    tableId: 'reservoir-release-flood-content',
    title: title
  };
  params.data = value;
  $('.reservoir-release-flood').css("display", "block");
  $('#reservoir-release-view').show();
  $('#reservoir-release-table').hide();
  $('.reservoir-release-flood-select').show();
  $('#reservoir-release-flood-chart').show();
  $('#reservoir-release-table').hide();
  $('#reservoir-release-flood-table').hide();

  initReservoirReleaseChart(params, clickTableHeight, win);
  $('#reservoir-release-view').unbind('click').bind('click', function () {
    $('#reservoir-release-view').hide();
    $('.reservoir-release-flood-select').hide();
    $('#reservoir-release-flood-chart').hide();
    $('#reservoir-release-table').show();
    $('#reservoir-release-flood-table').css("margin-top", "-10px")
    $('#reservoir-release-flood-table').show();
  });
  $('#reservoir-release-table').unbind('click').bind('click', function () {
    $('#reservoir-release-view').show();
    $('#reservoir-release-table').hide();
    $('.reservoir-release-flood-select').show();
    $('#reservoir-release-flood-chart').show();
    $('#reservoir-release-table').hide();
    $('#reservoir-release-flood-table').hide();
  });
}
/**水库水电站 end**/

/**山洪小流域 start**/
var getWatershedDbClickData = function (params, rightData) {
  noReservoirStageHtml(rightData);//判断右侧显示哪两个
  var mocd = params.mocd;
  var name = params.name;
  $('.monitor-detail-title').html(name);
  $('#watershed-rain-table').html('<table id="watershed-rain-table-content"></table>');
  getRiverForeRain({
    mocd: mocd,
    // rainId: "watershed-rain-chart",
    // otherId: "watershed-other-chart",
    rainId: "reservoir-rain-right-chart",
    otherId: "reservoir-other-right-chart",
    tableId: 'watershed-rain-table-content',
    type: obj_type_mountain_torrents
  }, function (result) {
    if (!result) {
      layer.close(doubleClickLayer);
      return;
    }
    if (result.rainData.length == 0) {
      layer.close(doubleClickLayer);
      return;
    }
    var title = name + "-来水预报";
    $("#detail-one").find(".title").html("来水预报");
    result.type = obj_type_mountain_torrents;
    // initDetailWinImg(mocd, 1);
    initEnlargeWatershedRainWin(result, title, mocd)
    layer.close(doubleClickLayer);
  });

  ajaxCallJson({
    mocd: mocd,
    type: 2
  }, '/floodSituation/cross/data', function (result) {
    if (!result) {
      return;
    }
    if (result && result.data) {
      if (result.data.pointList.length == 0 && result.data.pointArr.length == 0) {
        $("#monitor-detail-right").hide();
        $("#peripheral-information-max").hide();
        return;
      }
      $("#monitor-detail-right").show();
      $("#peripheral-information-max").show();
      var title = name + "-横断面示意图";
      $('#watershed-cross-sectional').prev().find(".title-name").html(title);
      $("#peripheral-information-max .monitor-detail-right-title").html("横断面示意图");
      //初始化横断面示意图
      $('#watershed-cross-chart').html('');
      $('#watershed-cross-chart').css("text-align", "center");
      changeType = 3;
      reservoirDamWindow = "";
      initEnlargeWatershedCrossWin(result.data, title, mocd);
    }
  });
  // initLoadPeripheral(mocd);//周边信息；
  // ajaxCallJson({
  //     mocd: mocd,
  //     type: 2
  // }, '/floodSituation/vertical/data', function (result) { //获取纵断面图数据
  //     if (result && result.data) {
  //         var title = name + "-纵断面示意图";
  //         $('#watershed-vertical-sectional').prev().find(".title-name").html(title);
  //         $("#detail-three").find(".title").html("纵断面示意图");
  //         //初始化横断面示意图
  //         $('#watershed-vertical-chart').html('');
  //         $('#watershed-vertical-chart').css("text-align", "center");
  //         initDetailWinImg(mocd, 3);
  //         initEnlargeWatershedVerticalWin(result.data, title, mocd);
  //     }
  // });
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/watershed/basic/data', function (result) { //获取基础信息
    if (!result) {
      return;
    }
    var data = result.data;
    if (!data || data == "") {
      return;
    }
    var title = name + "-基础信息";
    $("#detail-four").find(".title").html("基础信息");
    initDetailWinImg(mocd, 4);
    initEnlargeWatershedBasicDataWin(result, mocd, title);
  });
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: "RRSTON09"
  }, '/floodSituation/data/document', function (result) { //获取调查图片
    if (!result) {
      return;
    }
    var data = result.xData;
    if (!data || data == "") {
      return;
    }
    var title = name + "-图片";
    $("#detail-five").find(".title").html("调查图片");
    //initSmallWin('detail-five');
    initDetailWinImg(mocd, 5);
    var myWindow = new MyWindow($("#watershed-image"), {
      title: title
    });
    myWindow.dom.css("z-index", "-999");
    myWindow.show();
    showPointBaseData(result.xData, typr = 8);
    setTimeout(callback, 1000);

    function callback() {
      loadHtml2canvas(myWindow, 'watershed-image', 'detail-five', {
        mocd: mocd,
        num: 5
      });
    };
  });
  // inlitVideoData(mocd);视频加载

}
//来水预报
var initEnlargeWatershedRainWin = function (result, title, mocd) {
  // initSmallWin('detail-one');
  var myWindow = new MyWindow($("#watershed-rain"), {
    title: title
  });
  $('#watershed-rain-chart').css("width", "100%").css("height", "45%");
  $('#watershed-other-chart').css("width", "100%").css("height", "55%");
  $('#reservoir-rain-right-chart').css("width", "100%").css("height", "45%");
  $('#reservoir-other-right-chart').css("width", "100%").css("height", "55%");
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  resizeChartContainerSize(myWindow)
  result.tableHeight = getMoniterClickTableHeight(myWindow);
  myWindow.body.find('.chart-container').show();
  var startTime = result.publishTime,
    endTime = result.xData[result.xData.length - 1];
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出所有" ></a><a href="/floodSituation/fore/rain?mocd=' + mocd + '&startTime=' + startTime + '&endTime=' + endTime + '"><img src="/images/icon/export-forecast.png"  title="导出预报" ></a>');
  $('#watershed-rain-table').hide();
  $('#watershed-rain-view').css("margin-top", "23px");
  $('#watershed-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  result.title = title;
  initRainForecast(result, myWindow);
  myWindow.resizecbfn(function () {
    if (result.table.id) {
      resizeChartTableHeight(result.table.id, myWindow);
      resizeTablePaddingBottom(myWindow)
    }
    resizeChartContainerSize(myWindow)
    resizeChart();
  });
  $("#monitor-detail").hide();
  // setTimeout(callback, 1700);
  //
  // function callback() {
  //   loadHtml2canvas(myWindow, 'watershed-rain', 'detail-one', {
  //     mocd: mocd,
  //     num: 1
  //   });
  // };
  $('#watershed-rain-view').attr('flag', "chart");
  myWindow.body.find('.chart-container').show();
  $('#watershed-rain-table').hide();
  $('#watershed-rain-view').removeClass('has-export');
  $('#watershed-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').hide();
  $('#watershed-rain-view').unbind('click').bind('click', function () {
    if ($('#watershed-rain-view').attr('flag') == "chart") {
      $('#watershed-rain-view').css("margin-top", "5px");
      $('#watershed-rain-view').attr('flag', 'table');
      myWindow.body.find('.chart-container').hide();
      $('#watershed-rain-table').show();
      if ($("#watershed-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc') == false && $("#watershed-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('desc') == false) {
        $("#watershed-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      if ($("#watershed-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc')) {
        $("#watershed-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      $('#watershed-rain-view').addClass('has-export');
      $('#watershed-rain-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
      myWindow.body.find('.export-excel').show();
    } else {
      $('#watershed-rain-view').css("margin-top", "23px");
      $('#watershed-rain-view').attr('flag', "chart");
      myWindow.body.find('.chart-container').show();
      $('#watershed-rain-table').hide();
      $('#watershed-rain-view').removeClass('has-export');
      $('#watershed-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      resizeChart();
    }
  });
};
//横断面
var initEnlargeWatershedCrossWin = function (result, title, mocd) {
  initSmallWin('detail-right-peripheral');
  var myWindow = new MyWindow($("#watershed-cross-sectional"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.title = title;
  $('#detail-right-peripheral').css("width", "490px").css("height", "240px");
  createSectionView("detail-right-peripheral", result, myWindow);
  monitorWindow.push(myWindow);
}
//纵断面
var initEnlargeWatershedVerticalWin = function (result, title, mocd) {
  initSmallWin('detail-three');
  var myWindow = new MyWindow($("#watershed-vertical-sectional"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.title = title;
  createVerticalSectionView("watershed-vertical-sectional", result, myWindow);
  //var p=new PlayImage("#cross-sectional-chart",iData);
  monitorWindow.push(myWindow);
  setTimeout(callback, 1000);

  function callback() {
    loadHtml2canvas(myWindow, 'watershed-vertical-sectional', 'detail-three', {
      mocd: mocd,
      num: 3
    });
  };
}
//山洪小流域基础信息
var initEnlargeWatershedBasicDataWin = function (results, mocd, title) {
  //initSmallWin('detail-four');
  var myWindow = new MyWindow($("#watershed-basic-data"), {
    title: title
  });
  //$("#watershed-basic-data").css("background-color","rgba(51,52,54,0.7)");
  loadTab();
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  //基础信息
  var result = {};
  result.data = results.data[0]
  var content = $("#watershed-basic-infor-data");
  var contentHtml = "<table style='width: 100%;text-align: left'>" +
    "<tr><td width='45px'>类型:</td><td>" + (result.data.wstype == undefined ? "" : result.data.wstype) + "</td><td style='border-left: 1px solid #163174'></td><td width='45px'>面积:</td><td>" + (result.data.wsarea == undefined ? "" : result.data.wsarea) + "</td><td style='border-left: 1px solid #163174'></td><td width='45px'>形心高程:</td><td>" + (result.data.centerelv == undefined ? "" : result.data.centerelv + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td width='45px'>流域编码:</td><td>" + (result.data.wscd == undefined ? "" : result.data.wscd) + "</td></tr>" +
    "<tr><td>糙率：</td><td>" + (result.data.averou == undefined ? "" : result.data.averou) + "</td><td style='border-left: 1px solid #163174'></td><td>流域级别:</td><td>" + (result.data.wscs == undefined ? "" : result.data.wscs) + "</td><td style='border-left: 1px solid #163174'></td><td>形心坐标X:</td><td>-</td><td style='border-left: 1px solid #163174'></td><td>村落编码:</td><td>" + (result.data.villagecd == undefined ? "" : result.data.villagecd) + "</td></tr>" +
    "<tr><td>周长:</td><td >" + (result.data.wsperi == undefined ? "" : result.data.wsperi + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td>稳定下渗率:</td><td>" + (result.data.aveinf == undefined ? "" : result.data.aveinf) + "</td><td style='border-left: 1px solid #163174'></td><td>形心坐标Y:</td><td>-</td><td style='border-left: 1px solid #163174'></td><td>父流域编码:</td><td>" + (result.data.pwscd == undefined ? "" : result.data.pwscd) + "</td></tr>" +
    "<tr><td>分类码:</td><td >" + (result.data.gb == undefined ? "" : result.data.gb) + "</td><td style='border-left: 1px solid #163174'></td><td>出口高程:</td><td>" + (result.data.outletelv == undefined ? "" : result.data.outletelv + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td>出口坐标Y:</td><td>-</td><td style='border-left: 1px solid #163174'></td><td>出流流域编码:</td><td>" + (result.data.owscd == undefined ? "" : result.data.owscd) + "</td></tr>" +
    "<tr><td>流域名称：</td><td >" + (result.data.wsnm == undefined ? "" : result.data.wsnm) + "</td><td style='border-left: 1px solid #163174'></td><td>平均坡度:</td><td>" + (result.data.wsslp == undefined ? "" : result.data.wsslp) + "</td><td style='border-left: 1px solid #163174'></td><td >出口坐标X:</td><td>-</td><td style='border-left: 1px solid #163174'></td><td >村落断面编码：</td><td>" + (result.data.sectcd == undefined ? "" : result.data.sectcd) + "</td></tr>" +
    "<tr><td>形状系数:</td><td>" + (result.data.wsshpc == undefined ? "" : result.data.wsshpc) + "</td><td style='border-left: 1px solid #163174'></td><td>最长汇流路径长度:</td><td>" + (result.data.maxlen == undefined ? "" : result.data.maxlen + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td >最高点高程:</td><td>" + (result.data.maxelv == undefined ? "" : result.data.maxelv + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td >入流流域编码:</td><td>" + (result.data.iwscd == undefined ? "" : result.data.iwscd) + "</td></tr>" +
    "<tr><td>行政区名称：</td><td >" + (result.data.adnm == undefined ? "" : result.data.adnm) + "</td><td style='border-left: 1px solid #163174'></td><td>最长汇流路径比降:</td><td>" + (result.data.maxlslp == undefined ? "" : result.data.maxlslp) + "</td><td style='border-left: 1px solid #163174'></td><td >最低点高程:</td><td>" + (result.data.minelv == undefined ? "" : result.data.minelv + "(m)") + "</td><td style='border-left: 1px solid #163174'></td><td>出流节点编码:</td><td >" + (result.data.ondcd == undefined ? "" : result.data.ondcd) + "</td></tr>" +
    "<tr><td >村落断面名称:</td><td>" + (result.data.sectnm == undefined ? "" : result.data.sectnm) + "</td><td style='border-left: 1px solid #163174'></td><td></td><td></td><td style='border-left: 1px solid #163174'></td><td></td><td></td><td style='border-left: 1px solid #163174'></td><td></td><td></td></tr></table>";
  content.html(contentHtml);
  //山洪预警指标成果表
  initFloodWarningIndicator(results.data[0], mocd);
  //资料文档
  initDataDocument(results.data[0], mocd);
  setTimeout(callback, 1000);

  function callback() {
    loadHtml2canvas(myWindow, 'watershed-basic-data', 'detail-four', {
      mocd: mocd,
      num: 4
    });
  };
}

//山洪资料文档
function initDataDocument(results, mocd) {
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: ""
  }, '/floodSituation/data/document', function (result) {
    if (!result) {
      return;
    }
    var data = result.xData;
    if (!data || data == "") {
      $('#watershed-basic-document').hide();
      $('.watershed-basic-document').hide();
      return;
    }
    var obj = getZtreeDataFirstData(data);
    showPointBaseData(obj.data, 1, obj.first);
  })
}

//山洪预警指标成果表
function initFloodWarningIndicator(results, mocd) {
  $('#watershed-basic-warning-indicator').show();
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/warning/indicator', function (result) { //预警指标
    if (!result) {
      return;
    }
    //if(result.xData==""){
    //    return;
    //}
    var listHtml = "<span style='font-size:12pt;'>预警指标</span><table  style='text-align: center;margin-top: 10px;' class='textTableContext'>" +
      "<thead style='border-bottom: 1px solid #c4c8cc;border-top: 1px solid #c4c8cc;font-size: 12pt;'><tr style='height: 32px'><td>指标名称</td><td>指标等级</td><td>监控对象类型</td><td>备注</td><td>流量(m³/s)</td><td>水位(m)</td></tr></thead>" +
      "<tbody>";
    $.each(result.xData, function (index, data) {
      var ewtype = data.ewtype;
      switch (ewtype) {
        case "01":
          ewtype = "水库预警";
          break;
        case "03":
          ewtype = "重点城镇预警";
          break;
        case "14":
          ewtype = "山洪断面预警";
          break;
        case "15":
          ewtype = "河道断面预警";
          break;
        case "16":
          ewtype = "易涝点预警";
          break;
      }
      listHtml += "<tr><td>" + handlerUndefinedOrNull(data.ewnm) + "</td><td>" + handlerUndefinedOrNull(data.ewlevel) + "</td><td>" + handlerUndefinedOrNull(ewtype) + "</td><td>" + handlerUndefinedOrNull(data.remark) + "" +
        "</td><td>" + JSON.parse(data.comwarnvalue).q + "</td><td>" + JSON.parse(data.comwarnvalue).z + "</td></tr>"
    });
    listHtml += "</tbody></table>";
    $('#watershed-basic-warning-indicator').html(listHtml);
  })
  //    降雨指标
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/rainfall/index', function (result) { //降雨指标
    //if(result.xData==""){
    //    return;
    //}
    if (!result) {
      return;
    }
    var listHtml = "<span style='font-size:12pt'>降雨指标</span><table  style='text-align: center;margin-top: 10px;'>" +
      "<thead style='border-bottom: 1px solid #c4c8cc;border-top: 1px solid #c4c8cc;font-size: 12pt;'><tr style='height: 32px'><td >土壤含水量</td><td >指标类型</td><td>时段(h)</td><td>雨量(mm)</td></thead>" +
      "<tbody>";
    $.each(result.xData, function (index, data) {
      var warningType = data.warningType;
      if (warningType == 30) {
        warningType = "准备转移";
      } else {
        warningType = "立即转移";
      }
      for (var i = 0; i < data.indexIntv.length; i++) {
        listHtml += "<tr><td  >" + handlerUndefinedOrNull(data.lwater) + "</td><td >" + handlerUndefinedOrNull(warningType) + "</td><td>" + data.indexIntv[i] + "</td><td>" + data.indexValue[i] + "</td></tr>"
      }
    });
    listHtml += "</tbody></table>";
    $('#watershed-basic-rainfall-indicator').html(listHtml);
  })
}

//成果报告
var initWatershedReportWin = function (title) {
  $("#detail-report").find(".title").html("成果报告");
  //initSmallWin('detail-report');
  $('#detail-report').show();
  var myWindow = new MyWindow($('#watershed-report'), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  initReportSmallWin("detail-report", myWindow, obj_type_mountain_torrents)
}
//监控视频
var getWatershedVideoData = function () {
  initSmallWin('detail-video');
  var myWindow = new MyWindow($("#watershed-video"), {
    title: "图像监控"
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  $('#detail-video img').unbind('click').bind('click', function () {
    myWindow.dom.css("z-index", "999");
    myWindow.show();
  });
  setCenter()
}
var initEnlargeWatershedVideoWin = function () {
  $('#detail-video .content-img').css('display', 'block');
  $('#watershed-video').parent().css("z-index", -100);
}
/**山洪小流域 end**/

/**城市易涝点 start**/
var getWaterlogggedDbClickData = function (params, rightData) {
  noReservoirStageHtml(rightData);//判断右侧显示哪两个
  $("#monitor-detail-right").hide();
  var mocd = params.mocd;
  var name = params.name;
  $('.monitor-detail-title').html(name);
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/fore/rain', function (result) { //获取来水预报
    if (!result) {
      layer.close(doubleClickLayer);
      return;
    }
    var data = result.data;
    if (!data) {
      layer.close(doubleClickLayer);
      return;
    }
    if (data.rainData.length == 0) {
      layer.close(doubleClickLayer);
      return;
    }
    var title = name + "-降水预报";
    $('#waterlogged-fore-rain').prev().find(".title-name").html(title);
    $("#detail-one").find(".title").html("降水预报");
    $('#waterlogged-rain-table').html("<table id='waterlogged-rain-table-content'></table>")
    data.rainId = "waterlogged-rain-chart";
    data.type = obj_type_waterlogged;
    var columns = [{
      field: 'id',
      title: '序号',
      align: 'center'
    },
    {
      field: 'time',
      title: '时间',
      sortable: true,
      align: 'center'
    },
    {
      field: 'rain',
      title: '降水(mm)',
      align: 'center'
    }
    ];
    var tableData = [];
    for (var i = 0; i < data.xData.length; i++) {
      var temp = {};
      temp.id = i + 1;
      temp.time = data.xData[i];
      temp.rain = data.rainData[i];
      tableData.push(temp);
    }
    data.table = {
      columns: columns,
      data: tableData,
      id: 'waterlogged-rain-table-content'
    }
    initDetailWinImg(mocd, 1);
    initEnlargeWaterloggedRainWin(data, title, mocd);
    layer.close(doubleClickLayer);
  });
  // ajaxCallJson({
  //     mocd: mocd,
  //     stdate: ""
  // }, '/floodSituation/real/deep', function (result) { //获取实测水深
  //     if (!result) {
  //         return;
  //     }
  //     var data = result.xData;
  //     if (!data.depth) {
  //         return;
  //     }
  //     var title = name + "-实测水深";
  //     $('#waterlogged-water-depth').prev().find(".title-name").html(title);
  //     $("#detail-two").find(".title").html("实测水深");
  //     $('#water-depth-table').html('<table id="water-depth-table-content"></table>');
  //     result.id = "water-depth-chart";
  //     result.tableId = 'water-depth-table-content';
  //     initDetailWinImg(mocd, 2);
  //     initEnlargeWaterloggedDeepWin(result, title, mocd);
  //     $('#water-depth-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
  //     $('#water-depth-view').unbind('click').bind('click', function () {
  //         if ($('#water-depth-view').attr('flag') == "chart") {
  //             $('#water-depth-view').attr('flag', "table");
  //             $('#water-depth-chart').hide();
  //             $('#water-depth-table').show();
  //             $('#water-depth-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
  //         } else {
  //             $('#water-depth-view').attr('flag', "chart");
  //             $('#water-depth-chart').show();
  //             $('#water-depth-table').hide();
  //             $('#water-depth-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  //             resizeChart();
  //         }
  //     });
  // });
  ajaxCallJson({
    mocd: mocd
  }, '/floodSituation/waterloggedPoint/basic/data', function (result) { //获取基础信息
    if (!result) {
      return;
    }
    var data = result.data;
    if (!data || data == "") {
      return;
    }
    var title = name + "-基础信息";
    $("#detail-five").find(".title").html("基础信息");
    result.mocd = mocd;
    initDetailWinImg(mocd, 5);
    initEnlargeWaterloggedBasicDataWin(result, title, mocd);
  });
  ajaxCallJson({
    mocd: mocd,
    reqtype: '4',
    relcd: "RRSTON09"
  }, '/floodSituation/data/document', function (result) { //获取调查图片
    if (!result) {
      return;
    }
    var data = result.xData;
    if (!data || data == "") {
      return;
    }
    var title = name + "-图片";
    $('#waterlogged-image').prev().find(".title-name").html("调查图片");
    $("#detail-four").find(".title").html("图片");
    //initSmallWin('detail-four');
    initDetailWinImg(mocd, 4);
    var myWindow = new MyWindow($("#waterlogged-image"), {
      title: title
    });
    myWindow.dom.css("z-index", "-999");
    myWindow.show();
    showPointBaseData(result.xData, typr = 9);
    setTimeout(callback, 1000);

    function callback() {
      loadHtml2canvas(myWindow, 'waterlogged-image', 'detail-four', {
        mocd: mocd,
        num: 4
      });
    };
    $("#monitor-detail-right").css("display", "none");
  });

  ajaxCallJson({
    id: mocd
  }, '/video/getVideoCode', function (_data) {
    if (_data && _data.data && _data.data.length > 0) {
      videoUrl = '/video/getVideoView?id=' + mocd;
      videoTitle = name + "-图片监控";
    } else {
      $("#detail-video").hide();
    }
  });
  //   城市易捞点周边信息
  // initLoadPeripheral(mocd)
}
//来水预报
var initEnlargeWaterloggedRainWin = function (result, title, mocd) {
  initSmallWin('detail-one');
  var myWindow = new MyWindow($("#waterlogged-fore-rain"), {
    title: title
  });
  $('#waterlogged-rain-chart').css("width", "100%").css("height", "100%");
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  result.tableHeight = getMoniterClickTableHeight(myWindow);
  myWindow.body.find('.chart-container').show();
  $('#waterlogged-rain-table').hide();
  $('#waterlogged-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  $("#waterlogged-rain-view").css("margin-top", "25px");
  var startTime = result.publishTime,
    endTime = result.xData[result.xData.length - 1];
  myWindow.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出所有" ></a><a href="/floodSituation/fore/rain?mocd=' + mocd + '&startTime=' + startTime + '&endTime=' + endTime + '"><img src="/images/icon/export-forecast.png"  title="导出预报" ></a>');
  resizeChartContainerSize(myWindow);
  result.title = title;
  initRainForecast(result, myWindow);
  myWindow.resizecbfn(function () {
    if (result.table) {
      resizeChartTableHeight(result.table.id, myWindow);
      resizeTablePaddingBottom(myWindow);
    }
    resizeChartContainerSize(myWindow)
    resizeChart();
  });
  setTimeout(callback, 1700);

  function callback() {
    loadHtml2canvas(myWindow, 'waterlogged-fore-rain', 'detail-one', {
      mocd: mocd,
      num: 1
    });
  };
  $("#waterlogged-rain-view").css("margin-top", "25px");
  myWindow.body.find('.chart-container').show();
  $('#waterlogged-rain-table').hide();
  $('#waterlogged-rain-view').removeClass('has-export');
  $('#waterlogged-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
  myWindow.body.find('.export-excel').hide();
  $('#waterlogged-rain-view').unbind('click').bind('click', function () {
    if ($('#waterlogged-rain-view').attr('flag') == "chart") {
      $("#waterlogged-rain-view").css("margin-top", "5px");
      $('#waterlogged-rain-view').attr('flag', 'table');
      myWindow.body.find('.chart-container').hide();
      $('#waterlogged-rain-table').show();
      if ($("#waterlogged-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc') == false && $("#waterlogged-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('desc') == false) {
        $("#waterlogged-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      if ($("#waterlogged-rain-table-content thead tr th:nth-child(2)").children("div").hasClass('asc')) {
        $("#waterlogged-rain-table-content thead tr th:nth-child(2)").children("div").click();
      }
      $('#waterlogged-rain-view').addClass('has-export');
      $('#waterlogged-rain-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
      myWindow.body.find('.export-excel').show();
    } else {
      $('#waterlogged-rain-view').attr('flag', "chart");
      $("#waterlogged-rain-view").css("margin-top", "25px");
      myWindow.body.find('.chart-container').show();
      $('#waterlogged-rain-table').hide();
      $('#waterlogged-rain-view').removeClass('has-export');
      $('#waterlogged-rain-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      myWindow.body.find('.export-excel').hide();
      resizeChart();
    }
  });
};
//实测深度
var initEnlargeWaterloggedDeepWin = function (result, title, mocd) {
  //initSmallWin('detail-two');
  var myWindow = new MyWindow($("#waterlogged-water-depth"), {
    title: title
  });
  $('#water-depth-chart').css("width", "96%").css("height", "96%");
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  var tableHeight = getMoniterClickTableHeight(myWindow);
  initRealDeepChart(result, tableHeight);
  myWindow.resizecbfn(function () {
    resizeChartTableHeight(result.tableId, myWindow);
    resizeChart();
  });
  setTimeout(callback, 1000);

  function callback() {
    loadHtml2canvas(myWindow, 'waterlogged-water-depth', 'detail-two', {
      mocd: mocd,
      num: 1
    });
  };
};
//城市易涝点基础信息
var initEnlargeWaterloggedBasicDataWin = function (result, title, mocd) {
  //initSmallWin('detail-basic');
  var myWindow = new MyWindow($("#waterlogged-basic-data"), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  loadTab();
  //基础信息
  var content = $("#waterlogged-basic-data-top");
  var contentHtml = "<table style='width: 100%'>" +
    "<tr><td width='45px'>站点名称：</td><td>" + (result.data.wlpnm == undefined ? "" : result.data.wlpnm) + "</td><td style='border-left: 1px solid'></td><td width='45px'>区县:</td><td>" + (result.data.area == undefined ? "" : result.data.area) + "</td></tr>" +
    "<tr><td>街道:</td><td>" + (result.data.street == undefined ? "" : result.data.street) + "</td><td style='border-left: 1px solid'></td><td>站点地址:</td><td>" + (result.data.address == undefined ? "" : result.data.address) + "</td></tr>" +
    "<tr></tr></table>";
  content.html(contentHtml);
  ajaxCallJson({
    mocd: result.mocd
  }, '/floodSituation/waterloggedPoint/rainfall/accumulation', function (rainresult) { //降雨-积水关系
    var drp1 = rainresult.data.drp1;
    var depth1 = rainresult.data.depth1;
    var drp3 = rainresult.data.drp3;
    var depth3 = rainresult.data.depth3;
    rainresult.data.value1 = new Array()
    rainresult.data.value3 = new Array()
    for (var i = 0; i < drp1.length; i++) {
      rainresult.data.value1[i] = [];
      rainresult.data.value1[i][0] = depth1[i];
      rainresult.data.value1[i][1] = drp1[i];
    }
    for (var j = 0; j < drp3.length; j++) {
      rainresult.data.value3[j] = [];
      rainresult.data.value3[j][0] = depth3[j];
      rainresult.data.value3[j][1] = drp3[j];
    }
    var params = {
      id: 'waterlogged-basic-data-left-chart',
      data: rainresult.data,
      title: "时段降雨～积水深度曲线图"
    };
    initRainfallAccumulation(params);
    console.info(rainresult);
    var content = $("#waterlogged-basic-data-right-table");
    var history = rainresult.data;
    var htmlHead = '<div id="waterlogged-aa"><table class="table table-bordered table-responsive " style="margin-bottom: 0px"><thead class="server-report-thead" style="background-color: rgba(18, 41, 51, 0.7)"><tr><th >1小时降雨(mm)</th><th >积水深度(m)</th><th >3小时降雨(mm)</th><th >积水深度(m)</th></tr></thead></table></div>';
    var html = '<div style="overflow:auto;height:85%;text-align: center" id="waterlogged-bb"><table class="table table-bordered table-responsive" ><tbody class="report-history-tbody" style="overflow: auto;height: 100%;background-color: rgba(9, 25, 57, 0.85);text-align: center">'
    for (var i = 0; i < rainresult.data.depth3.length; i++) {
      html += '<tr style="text-align: center">';
      if (history.drp1[i] != undefined) {
        html += '<td style="text-align: center">' + history.drp1[i] + '</td>';
      } else {
        html += '<td></td>'
      }
      if (history.depth1[i] != undefined) {
        html += '<td style="text-align: center">' + history.depth1[i] + '</td>';
      } else {
        html += '<td></td>'
      }
      if (history.drp3[i] != undefined) {
        html += '<td style="text-align: center">' + history.drp3[i] + '</td>';
      } else {
        html += '<td>—</td>'
      }
      if (history.depth3[i] != undefined) {
        html += '<td style="text-align: center">' + history.depth3[i] + '</td>';
      } else {
        html += '<td>—</td>'
      }
      html += '</tr>';
    }
    html += "</tbody></table></div>";
    content.html(htmlHead + html)
    $("#waterlogged-aa  table").children("thead").find("th").each(function () {
      var idx = $(this).index();
      var td = $('#waterlogged-bb table').children('tbody').children('tr:first').children('td').eq(idx);
      if (idx == 0) {
        td.width($(this).width())
      }
      if (idx == 1) {
        td.width($(this).width() + 2)
      }
      if (idx == 2) {
        td.width($(this).width())
      }
      if ($('#waterlogged-bb table').children('tbody').height() > $('#waterlogged-bb').height()) {
        if (idx == 3) {
          td.width($(this).width() - 15)
        }
      } else {
        if (idx == 3) {
          td.width($(this).width())
        }
      }
    });
  });
  //资料文档
  ajaxCallJson({
    mocd: result.mocd,
    reqtype: '0',
    relcd: ""
  }, '/floodSituation/data/document', function (result) {
    if (!result.xData || result.xData == "" || result.xData.length == 0) {
      $("#waterlogged-basic-message").css("display", "block");
      $("#waterlogged-basic-data-document").css("display", "none");
      return;
    }
    $("#waterlogged-basic-message").css("display", "none");
    $("#waterlogged-basic-data-document").css("display", "block");
    var obj = getZtreeDataFirstData(result.xData);
    showPointBaseData(obj.data, 4, obj.first);
  })
  setTimeout(callback, 1000);

  function callback() {
    loadHtml2canvas(myWindow, 'waterlogged-basic-data', 'detail-five', {
      mocd: mocd,
      num: 5
    });
  };
  myWindow.resizecbfn(function () {
    resizeChart();
  });
}
//成果报告
var initWaterloggedReportWin = function (title) {
  $("#detail-report").find(".title").html("成果报告");
  //initSmallWin('detail-report');
  $('#detail-report').show();
  var myWindow = new MyWindow($('#waterlogged-report'), {
    title: title
  });
  myWindow.dom.css("z-index", "-999");
  myWindow.show();
  initReportSmallWin("detail-report", myWindow, obj_type_waterlogged);
}

/**城市易涝点 end**/

function addImageToDetail(image, id, window) {
  var pHtml = "<img src=" + image + " />";
  $('#' + id).find(".content-img").html(pHtml);
  $('#' + id).find(".content-img").css("display", "block");
  $('#' + id + ' img').css({
    height: 105,
    width: 150,
    margin: "0px",
    border: "none"
  });
  $('#' + id + ' .content-img').unbind('click').bind('click', function () {
    window.dom.css("z-index", 999);
    window.show();
  })
  setCenter()
}

//网页截屏
function loadHtml2canvas(enlargeWindow, canvasId, id, _obj, callback) {
  monitorWindow.push(enlargeWindow);
  html2canvas($('#' + canvasId), {
    onrendered: function (canvas) {
      var image;
      if (_obj.imgUrl) {
        image = _obj.imgUrl;
      } else {
        var extra_canvas = document.createElement("canvas");
        extra_canvas.setAttribute('width', 360);
        extra_canvas.setAttribute('height', 240);
        var ctx = extra_canvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 360, 240);
        image = extra_canvas.toDataURL("image/png");
      }
      if (_obj && canvasId != 'reservoir-dam-chart') {
        _obj.img = image;
        ajaxCallJson(_obj, '/base/detail/img/save', function () {

        })
      }
      //var pHtml = "<img src=" + image + " />";
      //$('#' + id).find(".content-img").html(pHtml);
      if (canvasId != 'reservoir-dam-chart')
        $('#' + id).find("img").attr('src', image);
      if ($('#' + id).find(".content-img").css("display") != "block")
        $('#' + id).find(".content-img").css("display", "block");
      if (id == "detail-right-peripheral") {
        $('#' + id + ' img').css({
          height: 230,
          width: 420,
          margin: "0px",
          border: "none"
        });
      } else {
        $('#' + id + ' img').css({
          height: 105,
          width: 150,
          margin: "0px",
          border: "none"
        });
      }
      $('#' + id + ' .content-img').unbind('click').bind('click', function () {
        enlargeWindow.dom.css("z-index", 999);
        enlargeWindow.show();
        if (canvasId == 'reservoir-dam-chart') {
          html2canvas($('#reservoir-dam-chart'), {
            onrendered: function (canvas) {
              var extra_canvas = document.createElement("canvas");
              extra_canvas.setAttribute('width', 360);
              extra_canvas.setAttribute('height', 240);
              var ctx = extra_canvas.getContext('2d');
              ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 360, 240);
              image = extra_canvas.toDataURL("image/png");
              if (_obj) {
                _obj.img = image;
                ajaxCallJson(_obj, '/base/detail/img/save', function () {

                })
              }
              $('#' + id).find("img").attr('src', image);
              //console.log(extra_canvas.toDataURL("image/png"))
            }
          });
        }
        if (callback) {
          callback();
        }
      })
      setCenter()
    }

  })
  // var toolHtml='<img src="images/close.png" id="p_hidden"></span>';
}

//关闭所有监控对象窗口
function closeMonitorWindow() {
  for (var i = 0; i < monitorWindow.length; i++) {
    monitorWindow[i].hide();
  }
}

//初始化小窗口
var initSmallWin = function (id) {
  // if(id!="detail-video"){
  //     $('#'+id).find(".content-img").html("");
  // }
  //$('#'+id).show();
}

//水库基本信息隐藏/显示菜单栏
function hideTreeMenu() {
  //山洪小流域
  $('#reservoir-infor-menu').hide();
  $('#watershed-basic-left').css('width', '98.5%');
  //山洪小流域调查图片
  $('#watershed-image-menu').hide();
  $('#watershed-image-left').css('width', '98.5%');
  //防洪城镇
  $('#monitor-city-data-menu').hide();
  $('#monitor-city-data-left').css('width', '98.5%');
  //水库水电站
  $('#reservoir-basic-document-menu').hide();
  $('#reservoir-basic-document-left').css('width', '98.5%');
  //重点河道
  $('#river-basic-document-menu').hide();
  $('#river-basic-document-left').css('width', '98.5%');
  //城市易涝点
  $('#waterlogged-basic-data-bottom-menu').hide();
  $('#waterlogged-basic-data-bottom-left').css('width', '98.5%');
  //城市易涝点调查图片
  $('#waterlogged-image-menu').hide();
  $('#waterlogged-image-left').css('width', '98.5%');
  //城镇风险图
  $('#monitor-city-risk-menu').hide();
  $('#monitor-city-risk-left').css('width', '98.5%');
  //城镇预案
  $('#monitor-city-plan-menu').hide();
  $('#monitor-city-plan-left').css('width', '98.5%');
  $('.showImage').css('display', 'none');
  $('.hideImage').css('display', 'block');
}

function showTreeMenu() {
  //山洪小流域
  $('#reservoir-infor-menu').show();
  $('#watershed-basic-left').css('width', '84%');
  //山洪小流域调查图片
  $('#watershed-image-menu').show();
  $('#watershed-image-left').css('width', '84%');
  //防洪城镇
  $('#monitor-city-data-menu').show();
  $('#monitor-city-data-left').css('width', '84%');
  //水库水电站
  $('#reservoir-basic-document-menu').show();
  $('#reservoir-basic-document-left').css('width', '84%');
  //重点河道
  $('#river-basic-document-menu').show();
  $('#river-basic-document-left').css('width', '84%');
  //城市易涝点
  $('#waterlogged-basic-data-bottom-menu').show();
  $('#waterlogged-basic-data-bottom-left').css('width', '84%');
  //城市易涝点调查图片
  $('#waterlogged-image-menu').show();
  $('#waterlogged-image-left').css('width', '84%');
  //城镇风险图
  $('#monitor-city-risk-menu').show();
  $('#monitor-city-risk-left').css('width', '84%');
  //城镇预案
  $('#monitor-city-plan-menu').show();
  $('#monitor-city-plan-left').css('width', '84%');
  $('.showImage').css('display', 'block');
  $('.hideImage').css('display', 'none');
}

//获取水位流量
var getWaterFloodData = function (result, clickTableHeight, win) {
  if (result.data) {
    if (result.data.z && result.data.q) {
      $('#river-water-view').show();
      var z = result.data.z;
      var q = result.data.q;
      var value = [];
      for (var i = 0; i < z.length; i++) {
        value[i] = [];
        value[i][0] = q[i];
        value[i][1] = z[i];
      }
      var params = {
        id: 'river-water-flood-chart',
        tableId: 'river-water-flood-table-content',
        data: value,
        title: result.title + '水位流量关系曲线'
      };
      win.body.find('.chart-container').show();
      $('#river-water-flood-table').hide();
      $("#river-water-view").css("margin-top", "0px")
      $('#river-water-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
      initWaterCurveChart(params, clickTableHeight, win);
      //$('.river-water-flood').css("display",'none');
      $('#river-water-flood-table').hide();
      $('#river-water-view').unbind('click').bind('click', function () {
        if ($('#river-water-view').attr('flag') == "chart") {
          $("#river-water-view").css("margin-top", "5px")
          $('#river-water-view').attr('flag', "table");
          win.body.find('.chart-container').hide();
          $('#river-water-flood-table').show();
          $('#river-water-view').html('<img src="/images/data-chart.png"  class="data-table" title="数据图表" >');
        } else {
          $("#river-water-view").css("margin-top", "0px")
          $('#river-water-view').attr('flag', "chart");
          win.body.find('.chart-container').show();
          $('#river-water-flood-table').hide();
          $('#river-water-view').html('<img src="/images/data-table.png"  class="data-table" title="数据表格" >');
          resizeChart();
        }
      });

    }
  }
}
//获取水库水位库容
var getReservoirWaterCapacity = function (mocd, clickTableHeight, win) {
  var id = "basic-data-left-one-chart";
  win.body.find('.export-excel').html('<a href="/floodSituation/fore/rain?mocd=' + mocd + '"><img src="/images/icon/export.png"  title="导出excel" ></a>');
  ajaxCallJson({
    mocd: mocd,
    curvetype: "1"
  }, "/floodSituation/capacity/curve", function (result) {
    if (!result) {
      return;
    }
    var data = result.data;
    if (!result.data.w || result.data.w == "") {
      $("#basic-data-left-view").hide();
      $("#basic-data-left-one-chart").html("<span style='font-size: 14px'>暂无数据</span>");
      return;
    }
    if (result.data) {
      if (result.data.w != undefined) {
        $("#basic-data-left-view").show();
        var data = result.data;
        var value = [];
        if (data.w.length == 0) {
          return
        }
        for (var i = 0; i < data.w.length; i++) {
          value[i] = [];
          value[i][0] = data.w[i];
          value[i][1] = data.z[i];
        }
        var title = win.option.title.substring(0, 4) + "-水位库容";
        var params = {
          id: id,
          data: value,
          water: data.z,
          title: title
        };
        initWaterCapacityChart(params); //初始化水位库容曲线
        //水位库容表格
        initWaterCapacityTable(params, clickTableHeight, win);

      }
    }
  })
}

//水位库容表格
function initWaterCapacityTable(params, clickTableHeight, win) {
  var columns = [{
    field: "checkbox",
    title: "select",
    align: true,
    checkbox: true
  }, {
    field: 'id',
    title: '序号',
    align: 'center'
  },
  {
    field: 'water',
    title: '水位(m)',
    align: 'center'
  }, {
    field: 'rt',
    title: '库容(万m³)',
    align: 'center'
  }
  ];
  $('#basic-data-left-table').html('<table id="basic-data-left-table-content"></table>');
  var tableData = [];
  for (var i = 0; i < params.data.length; i++) {
    var temp = {};
    temp.id = i + 1;
    temp.rt = params.data[i][0];
    temp.water = params.data[i][1];
    tableData.push(temp);
  }
  var tableId = "basic-data-left-table-content";
  $('#basic-data-left-table-content').bootstrapTable("destroy")
  var option = {
    height: clickTableHeight - 10,
    columns: columns,
    data: tableData,
    editable: true,
    pagination: true,
    pageNumber: 1, //初始化加载第一页，默认第一页
    pageSize: 50, //每页的记录行数（*）
    pageList: [20, 50, 100, 200],
  };
  $('#' + tableId).bootstrapTable('load', tableData);
  $('#' + tableId).bootstrapTable(option);
  resizeTablePaddingBottom(win)

}

//重点河道点击事件
function clickriversection(obj) {
  //layer.msg("加载中.....", {icon:16,time: 2000});
  var data = {
    mocd: obj.id.getValue()
  };
  $.ajax({
    url: '/base/getRealRiverData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues = [{
          "name": "日雨量(mm)",
          "value": (result.data.drp == undefined ? "" : result.data.drp)
        },
        {
          "name": "水位(m)",
          "value": (result.data.z == undefined ? "" : result.data.z)
        },
        {
          "name": "流量(m³/s)",
          "value": (result.data.q == undefined ? "" : result.data.q)
        },
        {
          "name": "时间",
          "value": (result.data.tm == undefined ? "" : moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))
        },
        {
          "name": "预警名称",
          "value": result.data.warnnm
        },
        ];
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        layer.msg(result.errorinfo, {
          time: 2000
        })
      }
    }
  })
}

//水库水电站实时数据点击事件
function clickreservoir(obj) {
  //layer.msg("加载中.....", {icon:16,time: 2000});
  var data = {
    mocd: obj.id.getValue()
  };
  $.ajax({
    url: '/base/getRealRsvrData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var dateTime;
        if (result.data.inq != undefined) {
          dateTime = getLocalTime(result.data.tm)
        }
        var channelvalues = [
          //{"name":"水库水电编码","value":result.mocd},
          //{"name":"名称","value":result.monm},
          {
            "name": "日雨量(mm)",
            "value": (result.data.drp == undefined ? "" : result.data.drp)
          },
          {
            "name": "库水位(m)",
            "value": (result.data.rz == undefined ? "" : result.data.rz)
          },
          {
            "name": "库容(万m³)",
            "value": (result.data.w == undefined ? "" : result.data.w)
          },
          // {"name":"入库流量(m³/s)","value": (result.data.inq==undefined?"":result.data.inq)},
          // {"name":"出库流量(m³/s)","value": (result.data.otq==undefined?"":result.data.otq)},
          // {"name":"时间","value":(result.data.tm==undefined?"":moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))},
          // {"name":"预警名称","value":result.data.warnnm},
        ];
        if (result.data.inq != undefined || result.data.otq != undefined) {
          channelvalues.push({
            "name": "入库流量(m³/s)",
            "value": (result.data.inq == undefined ? "" : result.data.inq)
          });
          channelvalues.push({
            "name": "出库流量(m³/s)",
            "value": (result.data.otq == undefined ? "" : result.data.otq)
          });
        }
        channelvalues.push({
          "name": "时间",
          "value": (result.data.tm == undefined ? "" : moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))
        });
        channelvalues.push({
          "name": "预警名称",
          "value": result.data.warnnm
        });
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        // layer.msg(result.error,{icon:16,time:2000})
      }
    }
  })
}

function getLocalTime(nS) {
  return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/, ' ');
}

//重点城镇实时数据
function clickRealCity(obj) {
  var data = {
    mocd: obj.id.getValue()
  };
  $.ajax({
    url: '/base/getRealCityTownData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues = [{
          "name": "日雨量(mm)",
          "value": (result.data.drp == undefined ? "" : (result.data.drp))
        },
        // {"name":"最大雨强","value":result.data.maxdrp},
        // {"name":"降水面积(km²)","value":(result.data.falldrprange==undefined?"":(result.data.falldrprange).toFixed(0))},
        //{"name":"比例值","value":result.data.per},
        {
          "name": "时间",
          "value": result.data.tm || ''
        },
        {
          "name": "预警名称",
          "value": result.data.warnnm
        },
        ];
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        layer.msg(result.error, {
          time: 2000
        })
      }
    }
  })
}

//山洪小流域实时数据
function clickRealSmallWater(obj) {
  var data = {
    mocd: obj.id.getValue()
  };
  $.ajax({
    url: '/base/getRealSmallWatershedData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues;
        channelvalues = [
          // {"name":"最近1小时雨量(mm)","value":(result.data.drp1h==undefined?"":(result.data.drp1h).toFixed(1))},
          // {"name":"最近3小时雨量(mm)","value":(result.data.drp3h==undefined?"":(result.data.drp3h).toFixed(1))},
          // {"name":"最近6小时雨量(mm)","value":(result.data.drp6h==undefined?"":(result.data.drp6h).toFixed(1))},
          // {"name":"最近12小时雨量(mm)","value":(result.data.drp12h==undefined?"":(result.data.drp12h).toFixed(1))},
          // {"name":"最近24小时雨量(mm)","value":(result.data.drp24h==undefined?"":(result.data.drp24h).toFixed(1))},
          {
            "name": '编码',
            "value": obj.stcd.getValue()
          },
          {
            "name": "日雨量(mm)",
            "value": result.data.drp1d
          },
          {
            "name": "时间",
            "value": result.data.tm
          },
          {
            "name": "预警名称",
            "value": result.data.warnnm
          },
        ];

        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue(), 'SH');
      } else {
        layer.msg(result.error, {
          time: 2000
        })
      }

    }
  })
}

//易涝点实时数据
function clickRealWaterlogged(obj) {
  var data = {
    mocd: obj.id.getValue()
  };
  $.ajax({
    url: '/base/getRealWaterloggedAreaData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues = [{
          "name": "位置",
          "value": result.data.position
        },
        {
          "name": "日雨量(mm)",
          "value": (result.data.drp == undefined ? "" : result.data.drp)
        },
        {
          "name": "水深(m)",
          "value": (result.data.depth == undefined ? "" : result.data.depth)
        },
        {
          "name": "时间",
          "value": (result.data.tm == undefined ? "" : moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))
        },
        {
          "name": "预警名称",
          "value": result.data.warnnm
        },
        ];
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        layer.msg(result.error, {
          icon: 16,
          time: 2000
        })
      }
    }
  })
}

//雨量站
function clickRainInfo(obj) {
  var drp = "--",
    tm = "--",
    sTm = "--",
    eTm = "--";
  if (obj.drp != undefined)
    drp = obj.drp.getValue();
  if (obj.newTm)
    tm = obj.newTm;
  else {
    if (obj.tm)
      tm = obj.tm.getValue();
  }
  if (obj.newStartTime)
    sTm = obj.newStartTime;
  else {
    if (obj.startTime != undefined)
      sTm = obj.startTime.getValue();
  }
  if (obj.newEndTime)
    eTm = obj.newEndTime;
  else {
    if (obj.endTime != undefined)
      eTm = obj.endTime.getValue();
  }
  var channelvalues = [{
    "name": "累积雨量(mm)",
    "value": drp
  },
  {
    "name": "开始时间",
    "value": sTm
  },
  {
    "name": "结束时间",
    "value": eTm
  }
    /*,
                 {"name":"最新数据时间","value":tm}*/
  ];
  showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
  return;
  var data = {
    mocd: obj.id.getValue()
  };
  if (flood_timeline_day.selectPointDateFormat)
    data.ymdDate = flood_timeline_day.selectPointDateFormat.substr(0, 10) + " 08:00:00";
  else
    data.ymdDate = SYSTEM.getSystemTime().format('YYYY-MM-DD') + " 08:00:00";
  $.ajax({
    url: '/base/getRealRainStationDataByDate',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues = [{
          "name": "累积雨量(mm)",
          "value": (result.data.curdaydrp == undefined ? "" : result.data.curdaydrp)
        },
        {
          "name": "时间",
          "value": (result.data.tm == undefined ? "" : moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))
        }
        ];
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        // layer.msg(result.error,{icon:16,time:2000})
      }
    }
  })
}

//气象站
function clickWeatherInfo(obj) {
  var drp = "--",
    tm = "--",
    sTm = "--",
    eTm = "--";
  if (obj.drp)
    drp = obj.drp;
  else {
    if (obj.drp)
      drp = obj.drp.getValue();
  }
  if (obj.newTm)
    tm = obj.newTm;
  else {
    if (obj.tm)
      tm = obj.tm.getValue();
  }
  if (obj.newStartTime)
    sTm = obj.newStartTime;
  else {
    if (obj.startTime != undefined)
      sTm = obj.startTime.getValue();
  }
  if (obj.newEndTime)
    eTm = obj.newEndTime;
  else {
    if (obj.endTime != undefined)
      eTm = obj.endTime.getValue();
  }
  var channelvalues = [{
    "name": "累积雨量(mm)",
    "value": drp
  },
  {
    "name": "开始时间",
    "value": sTm
  },
  {
    "name": "结束时间",
    "value": eTm
  }
    /*,
                 {"name":"最新数据时间","value":tm}*/
  ];
  showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
  return;
  var data = {
    mocd: obj.id.getValue()
  };
  if (flood_timeline_day.selectPointDateFormat)
    data.ymdDate = flood_timeline_day.selectPointDateFormat.substr(0, 10) + " 08:00:00";
  else
    data.ymdDate = SYSTEM.getSystemTime().format('YYYY-MM-DD') + " 08:00:00";
  $.ajax({
    url: '/base/getRealRainStationDataByDate',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var channelvalues = [{
          "name": "累积雨量(mm)",
          "value": (result.data.curdaydrp == undefined ? "" : result.data.curdaydrp)
        },
        {
          "name": "时间",
          "value": (result.data.tm == undefined ? "" : moment.unix(result.data.tm).format("YYYY-MM-DD HH:mm:ss"))
        }
        ];
        showPointInfor(obj.name.getValue(), obj.id.getValue(), channelvalues, false, obj.stcd.getValue());
      } else {
        // layer.msg(result.error,{icon:16,time:2000})
      }
    }
  })
}

function clickGateStationInfo(obj) {
  //layer.msg("加载中.....", {icon:16,time: 2000});
  var data = {
    mocd: obj.id.getValue().replace('_gate', '')
  };
  $.ajax({
    url: '/base/getRealGateStationData',
    method: 'post',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function (result) {
      if (result.flag == true) {
        var columns = [{
          field: 'stnm',
          title: '名称',
          align: "center"
        }, {
          field: 'gtq',
          title: '出流(m³/s)',
          align: "center"
        }, {
          field: 'tm',
          title: '时间',
          align: "center"
        }];
        if (result.data && result.data.length > 0 && result.data[0].hasgate == 1)
          columns.push({
            field: 'gtophgt',
            title: '开度(m)',
            align: "center"
          });
        showPointInfor(obj.name.getValue(), obj.id.getValue().replace('_gate', ''), result.data, false, obj.stcd.getValue(), obj_type_gate_station, columns, true);
      } else {
        // layer.msg(result.error,{icon:16,time:2000})
      }
    }
  })
}

//雨量站点点击事件
function clickrainfallstation(result) {
  var channelvalues = [{
    "name": "雨量(mm)",
    "value": (result.drp == undefined ? "" : result.drp)
  },
  {
    "name": "水位(m)",
    "value": (result.z == undefined ? "" : result.z)
  },
  {
    "name": "流量(m³/s)",
    "value": (result.q == undefined ? "" : result.q)
  },
  {
    "name": "时间",
    "value": result.tm
  },
  ];
  showPointInfor(result.monm, "", channelvalues);
}

var getMoniterClickTableHeight = function (window) {
  var ch = window.body.height();
  if (window.body.find(".select-chart").height()) {
    ch -= window.body.find(".select-chart").height() - 10;
  }
  if (window.body.find(".chart-table").height()) {
    ch -= window.body.find(".chart-table").height() - 10;
  }
  var bw = window.body.width();
  if (bw <= 600) {
    ch -= 45;
  }
  return ch - 80;
}
var resizeChartTableHeight = function (id, window) {
  $('#' + id).bootstrapTable("resetView", {
    height: getMoniterClickTableHeight(window) - 20
  });
}

var resizeTablePaddingBottom = function (window, type) {
  window.body.find(".fixed-table-container").css("padding-bottom", "0px");
  var ch = window.body.find(".fixed-table-container").height();
  var hh = window.body.find(".fixed-table-header").height();
  if (hh == 0) {
    hh = 41;
  }
  var h = ch - hh - 2;
  // console.log(h)
  window.body.find(".fixed-table-body").css("height", h + "px");
}
//水位流量放大窗口
var resizeWaterLevelChartTableHeight = function (id, window) {
  $('#' + id).bootstrapTable("resetView", {
    height: getWaterLevelClickTableHeight(window)
  });
}

var getWaterLevelClickTableHeight = function (window) {
  var ch = window.body.height();
  if (window.body.find(".select-chart").height()) {
    ch -= window.body.find(".select-chart").height() - 10;
  }
  if (window.body.find(".chart-table").height()) {
    ch -= window.body.find(".chart-table").height() - 10;
  }
  var bw = window.body.width();
  if (bw <= 600) {
    ch -= 45;
  }
  return ch - 100;
}

var getZtreeDataFirstData = function (data) {
  var data = data,
    first;
  for (var i = 0; i < data.length; i++) {
    if (data[i].pId == 0) {
      data[i].open = true;
      first = data[i];
      break;
    }
  }
  return {
    data: data,
    first: first
  }
}

function clickWarnRainInfo(obj) {
  var channelvalues;
  if (!obj.alarmLevel) {
    return;
  }
  var level = convertNumber(obj.alarmLevel.getValue());
  channelvalues = [{
    "name": "预警乡镇",
    "value": (obj.adnm == undefined ? "" : obj.adnm.getValue())
  },
  {
    "name": "预警等级",
    "value": level
  },
  {
    "name": "预警描述",
    "value": (obj.alarmDesc == undefined ? "" : obj.alarmDesc.getValue())
  },
  ];
  showPointInfor(obj.padnm.getValue(), obj.id.getValue(), channelvalues, false, obj.id.getValue());
}

var initDetailWinImg = function (mocd, num) {
  var $dom;
  switch (num) {
    case 1:
      $dom = $('#detail-one');
      break;
    case 2:
      $dom = $('#detail-two');
      break;
    case 3:
      $dom = $('#detail-three');
      break;
    case 4:
      $dom = $('#detail-four');
      break;
    case 5:
      $dom = $('#detail-five');
      break;
    case 6:
      $dom = $('#detail-six');
      break;
    case 7:
      $dom = $('#detail-video');
      break;
    case 8:
      $dom = $('#detail-report');
      break;
    case 9:
      $dom = $('#detail-right-one');
      break;
    case 10:
      $dom = $('#detail-right-peripheral');
      break;
    case 11:
      $dom = $('#detail-real-time');
      break;
    case 12:
      $dom = $('#detail-dam-break');
      break;
    case 13:
      $dom = $('#detail-reservoir-waring');
      break;
  }
  if (num == 7 || num == 8 || num == 9) {
    if (num == 8) {

    }
  } else {
    // ajaxCallJson({
    //   mocd: mocd,
    //   num: num
    // }, '/base/detail/img/getImg', function (_data) {
    //   if (_data && _data.flag && _data.data) {
    //     if (num == 10) {
    //       $dom.find("img").attr('src', _data.data.img);
    //       $dom.find("img").css({
    //         height: 230,
    //         width: 420,
    //         margin: "0px",
    //         border: "none"
    //       });
    //       $dom.find(".content-img").css("display", "block");
    //       setCenter();
    //     } else {
    //       $dom.find("img").attr('src', _data.data.img);
    //       $dom.find("img").css({
    //         height: 105,
    //         width: 150,
    //         margin: "0px",
    //         border: "none"
    //       });
    //       $dom.find(".content-img").css("display", "block");
    //       setCenter();
    //     }
    //
    //   }
    // })
  }
  $dom.show();
}
function openFullscreen(element) {
  if (element.requestFullscreen) {
    element.requestFullscreen();
  } else if (element.mozRequestFullScreen) {
    element.mozRequestFullScreen();
  } else if (element.msRequestFullscreen) {
    element.msRequestFullscreen();
  } else if (element.webkitRequestFullscreen) {
    element.webkitRequestFullScreen();
  }
}



//周边信息加载
function initLoadPeripheral(mocd) {
  ajaxCallJson({
    mocd: mocd
  }, '/base/findMoAroundRel', function (_data) {
    peripheralWindow = new MyWindow($("#peripheral-information-echarts"), {
      title: ""
    });
    peripheralWindow.dom.css("z-index", "-999");
    peripheralWindow.show();
    if (_data && _data.data) {
      $("#detail-three").find(".title").html("周边信息");
      var data = JSON.parse(_data.data);
      if (data.resflag && data.data.length > 0) {
        var valuesObj = {}, valuesObjList = [];
        var nameData;
        for (var i = 0; i < data.data.length; i++) {
          nameData = "";
          nameData = data.data[0].monm;
          var name = (data.data[i].relname).replace(/\(/g, "").replace(/\)/g, "").replace("（", "").replace("）", "")
          valuesObjList = [];
          var wlevel;
          if (data.data[i].wlevel == null) {
            wlevel = "error";
          } else {
            wlevel = data.data[i].wlevel
          }
          valuesObjList = [data.data[i].distance, data.data[i].direction, data.data[i].reltype, wlevel];
          eval("valuesObj." + name + "='" + valuesObjList + "'");
        }
        for (var key in valuesObj) {
          valuesObj[key] = (valuesObj[key]).split(",");
        }
        var width = $('#information-echarts').width();
        var height = $('#information-echarts').height()
        $('#information-echarts').radarChart({
          size: [width, height],
          step: 1,
          title: nameData + "周边图",
          max: 10,
          values: valuesObj,
        });
        initDetailWinImg(mocd, 3);
        setTimeout(callback, 1500);

        function callback() {
          resizeChart();
          loadHtml2canvas(peripheralWindow, 'information-echarts', 'detail-three', {
            mocd: mocd,
            num: 3
          });
        };
      } else {
        peripheralWindow.hide();
        // $("#peripheral-information").hide();
        // layer.msg('周边信息暂无数据',{time:1500})
      }
    }
  });
}

function inlitVideoData(mocd) {
  ajaxCallJson({
    id: mocd
  }, '/video/getVideoCode', function (_data) {
    if (_data && _data.data && _data.data.length > 0) {
      $("#monitor-detail-right-content-video").show();
      videoUrl = '/video/getVideoView?id=' + mocd;
      videoTitle = "视频图像";
      maxVideo = true;
      // $("#video-max").click();
      $("#detail-right-one").html();
      $("#detail-right-one").html('<IFRAME marginWidth=0 marginHeight=0 src="' + videoUrl + '&topShow=true" frameBorder=0 width="440px"  height="230px"  scrolling="no"></IFRAME>');
    } else {
      ajaxCallJson({
        mocd: mocd
      }, '/base/getStationImage', function (_data) {
        if (_data && _data.data) {
          var data = JSON.parse(_data.data);
          if (data.resflag == false) {
            $("#detail-right-one").html();
            $("#detail-right-one").html("<img />");
            $("#detail-right-one img").attr('src', "images/window/videos.png");
            return
          }
          videoUrl = "";
          var url = downLoadUrl + data.data;
          $("#detail-right-one").html();
          $("#detail-right-one").html("<img />");
          $("#detail-right-one img").attr('src', url);
          $("#detail-right-one img").css("width", "480px");
          $("#detail-right-one img").css("height", "300px")
        } else {
          $("#detail-right-one").html();
          $("#detail-right-one").html("<img />");
          $("#detail-right-one img").attr('src', "images/window/videos.png");

        }
      });
    }
  })
}

$("#detail-dam-break img").click(function () {
  note.notify("reservoir.dambreak", {
    mocd: currentMocd,
    adnm: currentName,
    lgtd: reservoir[0],
    lttd: reservoir[1],
    stcd: currentStcd
  });
  $("#dam-break-control").show(300)
});
