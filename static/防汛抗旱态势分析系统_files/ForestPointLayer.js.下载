// 森林监测点
define([
    "esri/layers/FeatureLayer",
    "esri/layers/support/LabelClass",
    "esri/geometry/Point",
  ],
  function (FeatureLayer, LabelClass, Point) {
    /**
     * mapPointArr点数据数组，classBreakInfosArr 渲染器数组
     */
    return function (mapPointArr, classBreakInfosArr, featureLayerID) {
      var minScale = 250000000; //label在视图中可见的最小比例
      //定义需要显示的字段
      var fields = [{
        name: "ObjectID",
        alias: "ObjectID",
        type: "oid"
      }, {
        name: "name", //名称
        alias: "name",
        type: "string"
      }, {
        name: "lgtd", //经度
        alias: "lgtd",
        type: "double"
      }, {
        name: "lttd", //纬度
        alias: "lttd",
        type: "double"
      }, {
        name: "firepoint", //发生火点行政区
        alias: "firepoint",
        type: "string"
      }, {
        name: "vollage", //距离火点最近的村
        alias: "vollage",
        type: "string"
      }, {
        name: "neardist", //火点与最近村的距离
        alias: "neardist",
        type: "string"
      }, {
        name: "nearaz", //火点与最近村的方位角
        alias: "nearaz",
        type: "string"
      }, {
        name: "g", //着火点灰度值
        alias: "g",
        type: "double"
      }, {
        name: "t", //着火点温度值
        alias: "t",
        type: "double"
      }, {
        name: "t0", //着火点温度阈值
        alias: "t0",
        type: "double"
      }, {
        name: "g0", //着火点灰度阈值
        alias: "g0",
        type: "double"
      }, {
        name: "hight", //本次高出阈值的温度
        alias: "hight",
        type: "double"
      }, {
        name: "dt10m", //10分钟变温
        alias: "dt10m",
        type: "double"
      }, {
        name: "tm", //数据更新时间
        alias: "tm",
        type: "string"
      }, {
        name: "typeId", //typeId
        alias: "typeId",
        type: "string"
      }];
      //构造popUp显示模板
      var pTemplate = {
        title: "{name}",
        content: [{
          type: "fields",
          fieldInfos: [{
              fieldName: "id",
              label: "森林监测站id",
              visible: true
            }, {
              fieldName: "name",
              label: "森林监测站",
              visible: true
            }, {
              fieldName: "lgtd",
              label: "经度",
              visible: true
            }, {
              fieldName: "lttd",
              label: "纬度",
              visible: true
            }, {
              fieldName: "firepoint",
              label: "发生火点行政区",
              visible: true
            }, {
              fieldName: "vollage",
              label: "距离火点最近村",
              visible: true
            }, {
              fieldName: "neardist",
              label: "火点与最近村的距离",
              visible: true
            }, {
              fieldName: "nearaz",
              label: "火点与最近村的方位角",
              visible: true
            }, {
              fieldName: "g",
              label: "着火点灰度值",
              visible: true
            }, {
              fieldName: "t",
              label: "着火点温度值",
              visible: true
            },
            {
              fieldName: "t0",
              label: "着火点温度阈值",
              visible: true
            }, {
              fieldName: "g0",
              label: "着火点灰度阈值",
              visible: true
            },
            {
              fieldName: "hight",
              label: "本次高出阈值的温度",
              visible: true
            }, {
              fieldName: "dt10m",
              label: "10分钟变温",
              visible: true
            }, {
              fieldName: "tm",
              label: "数据更新时间",
              visible: true
            }
          ]
        }]
      }

      //定义渲染器
      var pointRenderer = {
        type: "class-breaks", // autocasts as new ClassBreaksRenderer()
        field: "t",
        normalizationField: "EDUCBASECY",
        classBreakInfos: classBreakInfosArr
      }

      //创建点的label标注
      var statesLabelClass = new LabelClass({
        labelExpressionInfo: {
          expression: "$feature.name"
        },
        labelPlacement: "above-center",
        minScale: minScale,
        symbol: {
          type: "label-3d", // autocasts as new LabelSymbol3D()
          symbolLayers: [{
            type: "text", // autocasts as new TextSymbol3DLayer()
            material: {
              color: "black"
            },
            halo: {
              size: 1,
              color: "white"
            },
            size: 10
          }]
        }
      });

      var sourceObj = pointCreateGraphicsObj(mapPointArr);

      var pointLayer = new FeatureLayer({
        id: featureLayerID,
        source: sourceObj,
        fields: fields,
        objectIdField: "ObjectID",
        renderer: pointRenderer,
      });

      // pointLayer.labelingInfo = [statesLabelClass];
      var obj = {
        pointLayer: pointLayer,
        renderer: pointRenderer,
        source: sourceObj,
        labelClass: statesLabelClass,
        fields: fields,
        classBreakInfosArr: classBreakInfosArr
      }
      return obj;
      // return pointLayer;
    }

    //创建点图形对象
    function pointCreateGraphicsObj(mapPointArrParam) {
      return mapPointArrParam.map(function (ele, i) {
        return {
          geometry: new Point({
            x: ele.lgtd,
            y: ele.lttd
          }),
          attributes: {
            ObjectID: i,
            id: ele.id,
            name: ele.name,
            lgtd: ele.lgtd,
            lttd: ele.lttd,
            firepoint: ele.firepoint,
            vollage: ele.vollage,
            neardist: ele.neardist,
            nearaz: ele.nearaz,
            g: ele.g,
            t: ele.t,
            t0: ele.t0,
            g0: ele.g0,
            hight: ele.hight,
            dt10m: ele.dt10m,
            tm: ele.tm,
            typeId: ele.typeId
          }
        }
      })
    }
  }
)