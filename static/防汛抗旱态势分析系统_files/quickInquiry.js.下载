var addCollectPointArr;//收藏点数组
$(function () {
  $('#quick-inquiry').unbind().on('click', 'span', function () {
    const isclick = $(this).hasClass('isclick') ? true : false;
    $('#quick-inquiry span').removeClass("isclick");
    // if (map.findLayerById('1112')) {
    //   map.findLayerById('1112').visible = isclick;
    //   map.findLayerById('1112').opacity = isclick ? 1 : 0;
    // }
    if (isclick) return
    $(this).addClass('isclick');
    const name = $(this).attr("name");
    checkMenu(name);
    checkNewMenu(name, addCollectPointArr);
  })

  $('#close-quick-inquiry,#quick-inquiry-zoom').unbind().on('click', function () {
    $('#quick-inquiry-div').slideToggle(300);
  })

  note.on("flood.analysis", (event, data) => onFloodAnalysis(data));
  addCollectPointHtml()
})

//添加收藏点
var addCollectPointHtml = function () {
  addCollectPointArr = [
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [112.930956, 27.862164, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_61102000",
        name: "湘潭",
        stcd: "61102000",
        type: "15",
        wscd: "1616170000"
      },
      obj: {
        ObjectID: 1,
        adcd: "430302002000000",
        addr: "湘-湘潭",
        adnm: "",
        exparams: {
          mocd: "ZQ_61102000", monm: "湘潭", createtime: "2019-06-28T16:41:47.895254", detail: [{ video: 0 },
          { hcross: 1 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 112.930956,
        lttd: 27.862164,
        mocd: "ZQ_61102000",
        monm: "湖南湘潭",
        motype: "15",
        oecd: "",
        stcd: "61102000",
        topoid: "modelcj_11293745002786778",
        typeId: "ZQ_61102000",
        wlevel: 0,
        wscd: "1616170000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [113.149714, 27.813546, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_61101900",
        name: "株洲",
        stcd: "61101900",
        type: "15",
        wscd: "1616170000",
      },
      obj: {
        ObjectID: 0,
        adcd: "430203005000000",
        addr: "湘-株洲",
        adnm: "",
        exparams: {
          mocd: "ZQ_61101900", monm: "株洲", createtime: "2019-06-28T16:42:07.121165", detail: [{ video: 0 },
          { hcross: 1 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 113.149714,
        lttd: 27.813546,
        mocd: "ZQ_61101900",
        monm: "湖南株洲",
        motype: "15",
        oecd: "",
        stcd: "61101900",
        topoid: "modelcj_11314293002782300",
        typeId: "ZQ_61101900",
        wlevel: 0,
        wscd: "1616170000"
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [112.872044, 27.229817, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_61101600",
        name: "衡山",
        stcd: "61101600",
        type: "15",
        wscd: "1616170000",
      },
      obj: {
        ObjectID: 0,
        adcd: "430423100000000",
        addr: "湘-衡阳",
        adnm: "",
        exparams: {
          mocd: "ZQ_61101600", monm: "衡山", createtime: "2019-06-28T16:41:03.209544", detail: [{ video: 0 },
          { hcross: 1 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 112.872044,
        lttd: 27.229817,
        mocd: "ZQ_61101600",
        monm: "湖南衡山",
        motype: "15",
        oecd: "",
        stcd: "61101600",
        topoid: "modelcj_11286959002724293",
        typeId: "ZQ_61101600",
        wlevel: 0,
        wscd: "1616170000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [112.646974, 26.934547, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_61101400",
        name: "衡阳",
        stcd: "61101400",
        type: "15",
        wscd: "1616170000",
      },
      obj: {
        ObjectID: 0,
        adcd: "430407005000000",
        addr: "湘-衡阳",
        adnm: "",
        exparams: { mocd: "ZQ_61101400", monm: "衡阳", createtime: "2019-06-28T16:41:03.215591", detail: Array(7) },
        lgtd: 112.646974,
        lttd: 26.934547,
        mocd: "ZQ_61101400",
        monm: "湖南衡阳",
        motype: "15",
        oecd: "",
        stcd: "61101400",
        topoid: "modelcj_11263681002694073",
        typeId: "ZQ_61101400",
        wlevel: 0,
        wscd: "1616170000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [106.603693, 29.613789, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_60105400",
        name: "寸滩",
        stcd: "60105400",
        type: "15",
        wscd: "1611110000",
      },
      obj: {
        ObjectID: 1,
        adcd: "500108103000000",
        addr: "渝-江北区",
        adnm: "",
        exparams: {
          mocd: "ZQ_60105400", monm: "寸滩", createtime: "2019-06-28T16:40:50.054399", detail: [{ video: 0 },
          { hcross: 1 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 106.603693,
        lttd: 29.613789,
        mocd: "ZQ_60105400",
        monm: "重庆寸滩",
        motype: "15",
        oecd: "",
        stcd: "60105400",
        topoid: "modelcj_10662162002961479",
        typeId: "ZQ_60105400",
        wlevel: 0,
        wscd: "1611110000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [107.734465, 29.325419, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_60803000",
        name: "武隆",
        stcd: "60803000",
        type: "15",
        wscd: "1615120000",
      },
      obj: {
        ObjectID: 240,
        adcd: "500156100000000",
        addr: "渝-武隆县",
        adnm: "",
        exparams: {
          mocd: "ZQ_60803000", monm: "武隆", createtime: "2019-06-28T16:41:43.93163", detail: [{ video: 0 },
          { hcross: 0 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 107.734465,
        lttd: 29.325419,
        mocd: "ZQ_60803000",
        monm: "重庆武隆",
        motype: "15",
        oecd: "",
        stcd: "60803000",
        topoid: "modelcj_10772283002933467",
        typeId: "ZQ_60803000",
        wlevel: 0,
        wscd: "1615120000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [111.316553, 30.681206, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_60107300",
        name: "宜昌",
        stcd: "60107300",
        type: "15",
        wscd: "1611110000",
      },
      obj: {
        ObjectID: 413,
        adcd: "420502003000000",
        addr: "鄂-宜昌市",
        adnm: "",
        exparams: {
          mocd: "ZQ_60107300", monm: "宜昌", createtime: "2019-06-28T16:41:57.379721", detail: [{ video: 0 },
          { hcross: 0 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 111.316553,
        lttd: 30.681206,
        mocd: "ZQ_60107300",
        monm: "湖北宜昌",
        motype: "15",
        oecd: "",
        stcd: "60107300",
        topoid: "modelcj_11128570003068588",
        typeId: "ZQ_60107300",
        wlevel: 0,
        wscd: "1611110000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [114.298318, 30.575565, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_60112200",
        name: "汉口",
        stcd: "60112200",
        type: "15",
        wscd: "1619140000",
      },
      obj: {
        ObjectID: 0,
        adcd: "420103001000000",
        addr: "",
        adnm: "",
        exparams: {
          mocd: "ZQ_60112200", monm: "汉口", createtime: "2019-06-28T16:41:01.709928", detail: [{ video: 0 },
          { hcross: 1 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 114.298318,
        lttd: 30.575565,
        mocd: "ZQ_60112200",
        monm: "湖北汉口",
        motype: "15",
        oecd: "",
        stcd: "60112200",
        topoid: "modelcj_11429431003056757",
        typeId: "ZQ_60112200",
        wlevel: 0,
        wscd: "1619140000"
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [116.027158, 29.741528, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_60113400",
        name: "九江",
        stcd: "60113400",
        type: "15",
        wscd: "1620110000",
      },
      obj: {
        ObjectID: 10,
        adcd: "360403004000000",
        addr: "赣-九江市",
        adnm: "",
        exparams: {
          mocd: "ZQ_60113400", monm: "九江", createtime: "2019-06-28T16:41:12.765314", detail: [{ video: 0 },
          { hcross: 0 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 116.027158,
        lttd: 29.741528,
        mocd: "ZQ_60113400",
        monm: "江西九江",
        motype: "15",
        oecd: "",
        stcd: "60113400",
        topoid: "modelcj_11601820002975074",
        typeId: "ZQ_60113400",
        wlevel: 0,
        wscd: "1620110000",
      }
    },
    {
      flag: true,
      subject: 1,
      date: getTime(getSystemTime()),
      point: [116.220474, 29.742284, 15],
      dataObj: {
        eacId: undefined,
        mocd: "ZQ_62601600",
        name: "湖口",
        stcd: "62601600",
        type: "15",
        wscd: "1618180000",
      },
      obj: {
        ObjectID: 363,
        adcd: "360429100000000",
        addr: "赣-湖口县",
        adnm: "",
        exparams: {
          mocd: "ZQ_62601600", monm: "湖口", createtime: "2019-06-28T16:41:04.480337", detail: [{ video: 0 },
          { hcross: 0 },
          { flood: 1 },
          { fore: 1 },
          { real: 0 },
          { base: 1 },
          { around: 1 }]
        },
        lgtd: 116.220474,
        lttd: 29.742284,
        mocd: "ZQ_62601600",
        monm: "江西湖口",
        motype: "15",
        oecd: "",
        stcd: "62601600",
        topoid: "modelcj_11621876002975411",
        typeId: "ZQ_62601600",
        wlevel: 0,
        wscd: "1618180000",
      }
    }
  ];

  for (var i = 0; i < addCollectPointArr.length; i++) {
    var index = addCollectPointArr[i];
    var name = index.obj.monm;
    var html = `<span name="${name}">
    <i class="fa fa-window-minimize fa-rotate-90 fa-font-size" aria-hidden="true"></i>${name}</span>`;
    $("#quick-inquiry").prepend(html);
  }
}

var checkNewMenu = function (name, checkObjArr) {
  let [flag, subject, date, point, dataObj, TDobj, obj] = [false, ...[]];
  for (var i = 0; i < checkObjArr.length; i++) {
    var index = checkObjArr[i];
    if (name == index.obj.monm) {
      if (name == "湖南湘潭" || name == "湖南株洲" || name == "湖南衡山" || name == "湖北汉口" || name == "湖南衡阳") {
        if ($('#152clickbtn div').hasClass("layui-form-checked") === false) {
          $('#152clickbtn i').trigger('click');
        }
      } else if (name == "重庆寸滩" || name == "重庆武隆" || name == "湖北宜昌" || name == "江西九江" || name == "江西湖口") {
        if ($('#151clickbtn div').hasClass("layui-form-checked") === false) {
          $('#151clickbtn i').trigger('click');
        }
      }
      [flag, subject, date, point, dataObj, TDobj, obj] = [index.flag, index.subject, index.date, index.point, index.dataObj, index.TDobj, index.obj];
      flag && todosomething({
        subject,
        date,
        point,
        dataObj,
        TDobj,
        obj
      });
    }
  }
}

const checkMenu = function (name) {
  let [flag, subject, date, point, dataObj, TDobj] = [false, ...[]];
  var obj;
  switch (name) {
    case "山竹台风洪水预警":
      flag = true;
      subject = 1;
      date = '2018-09-16';
      point = [111.93218, 21.88566, 7];
      break;
    case "阳江9.17洪灾":
      flag = true;
      subject = 1;
      date = '2018-09-17';
      point = [111.93218, 21.88566, 13];
      break;
    case "98历史洪水演进":
      flag = true;
      subject = 2;
      date = '1998-06-16';
      point = [107.67, 26.65, 6];
      break;
    case "松柏山水库":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      point = [106.573062, 26.404167, 13];
      reservoir[0] = (106.573062);
      reservoir[1] = (26.404167);
      dataObj = {
        mocd: "RR_60809090",
        name: "松柏山水库",
        stcd: "60809090",
        type: "01",
        wscd: "1615110000"
      };
      if ($('#013clickbtn div').hasClass("layui-form-checked") === false) {
        $('#013clickbtn i').trigger('click');
      }
      obj = {
        ObjectID: 1,
        adcd: "520901000000000",
        addr: "贵阳市贵安新区党武乡",
        adnm: "",
        exparams: {
          mocd: "RR_60809090",
          monm: "松柏山水库",
          createtime: "2019-05-21T15:29:10.270358",
          detail: [{
            video: 1
          },
          {
            dam: 1
          },
          {
            flood: 1
          },
          {
            fore: 1
          },
          {
            dispatch: 1
          },
          {
            real: 1
          },
          {
            base: 1
          },
          {
            around: 1
          },
          {
            broken: 1
          },
          ]
        },
        lgtd: 106.574907,
        lttd: 26.400543,
        mocd: "RR_60809090",
        monm: "松柏山水库",
        motype: "01",
        oecd: "",
        stcd: "60809090",
        topoid: "modelcj_10657487002640956",
        typeId: "RR_60809090",
        wlevel: 0,
        wscd: "1615110000",
      };
      break;
    case "甲秀楼断面":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      point = [106.7197761, 26.571634, 13];
      dataObj = {
        mocd: "ZQ_DF100333",
        name: "甲秀楼",
        stcd: "DF100333",
        type: "15",
        wscd: "1615110000"
      };
      if ($('#152clickbtn div').hasClass("layui-form-checked") === false) {
        $('#152clickbtn i').trigger('click');
      }
      obj = {
        ObjectID: 0,
        adcd: "520102000000000",
        addr: "贵阳市南明区",
        adnm: "",
        exparams: {
          createtime: "2019-05-21T15:51:41.751201",
          detail: [{
            video: 1
          },
          {
            hcross: 1
          },
          {
            flood: 1
          },
          {
            fore: 1
          },
          {
            real: 1
          },
          {
            base: 1
          },
          {
            around: 1
          }
          ],
          mocd: "ZQ_DF100333",
          monm: "甲秀楼",
        },
        createtime: "2019-05-21T15:51:41.751201",
        mocd: "ZQ_DF100333",
        monm: "甲秀楼",
        __proto__: Object,
        lgtd: 106.719844,
        lttd: 26.571385,
        mocd: "ZQ_DF100333",
        monm: "甲秀楼",
        motype: "15",
        oecd: "",
        stcd: "DF100333",
        topoid: "modelcj_10671737002657313",
        typeId: "ZQ_DF100333",
        wlevel: 0,
        wscd: "1615110000",
      };
      break;
    case "贵阳优化调度":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      point = [106.694190, 26.557052, 13];
      loadRiverUnionDispatch();
      break;
    case "贵阳城市三维":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      TDobj = {
        ObjectID: "MODEL_520100000000000",
        adcd: "520100000000000",
        addr: null,
        adnm: null,
        exparams: {
          modifytime: "2019-04-04T20:49:55.949739",
          enable: 1,
          adcd: "520100000000000",
          lgtd: 106.630103999876,
          lttd: 26.6474810003404,
          params: {
            symbol3d: 1
          },
          url: [threeDimensionalUrl]
        },
        lgtd: 106.63367259960636,
        lttd: 26.643811543666573,
        mocd: "MODEL_520100000000000",
        monm: "贵阳市",
        motype: "33",
        oecd: null,
        stcd: "520100000000000",
        typeId: "MODEL_520100000000000",
        wlevel: 0,
        wscd: ""
      };
      break;
    case "羊午水库三维":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      TDobj = {
        ObjectID: "MODEL_520112000000000",
        adcd: "520112000000000",
        addr: null,
        adnm: null,
        exparams: {
          adcd: "520112000000000",
          adnm: "乌当区",
          enable: 1,
          lgtd: 106.792369065678,
          lttd: 26.8486664382407,
          modifytime: "2019-04-04T20:49:55.949739",
          params: {
            offset: -200,
            symbol3d: 1
          },
          url: [threeDimensionalYangwuUrl]
        },
        lgtd: 106.750674,
        lttd: 26.630806,
        mocd: "MODEL_520112000000000",
        monm: "乌当区",
        motype: "33",
        oecd: null,
        stcd: "520112000000000",
        topoid: "",
        typeId: "MODEL_520112000000000",
        wlevel: 0,
        wscd: ""
      };
      break;
    case "概化调度":
      flag = true;
      subject = 1;
      date = getTime(getSystemTime());
      note.notify("scheduling.generalized.open", '1615110000'); //概化调度
    default:
      console.log('无[' + name + ']模块业务逻辑');
      break;
  }
  flag && todosomething({
    subject,
    date,
    point,
    dataObj,
    TDobj,
    obj
  });
}

const todosomething = function ({
  subject,
  date,
  point,
  dataObj,
  TDobj,
  obj
}) {
  if (subject) {
    mainTittleClick(subject);
  }
  if (date) {
    setTimeout(function () {
      calendarClick(date);
    }, 1000)
  }
  if (point) {
    setTimeout(() => {
      view.goTo({
        center: [point[0], point[1]],
        zoom: 11,
        heading: 0,
        tilt: 0
      })
    }, 1500);
  }
  if (dataObj) {
    monitorClick(dataObj, obj);
  }
  if (TDobj) {
    loadFloodAnalysis(TDobj);
  }
}

function mainTittleClick(Num) {
  const div = $('.mainBox-flood-content div');
  // if ($(div[Num]).attr('checked')) return
  $(div[Num - 1]).trigger('click');
}

function onFloodAnalysis(data) {
  data && data.forEach((item) => {
    if (item.stcd == "520112000000000") {
      item.remark = "溃坝洪水";
    }
    let param = {
      id: item.stcd,
      checked: item.checked,
      code: item.code,
      label: item.remark,
      bindingflag: item.bindingflag,
      warningCount: 0,
      type: "ymfx"
    };
    if (item.checked) {
      onFloodChange(param);
    }
  })
}

function onFloodChange(item) {
  floodIndex = layer.load(2, {
    time: 10 * 1000,
    shade: [0.2, '#393D49']
  });
  let body = {
    interface: "com.ec.ws.service.def.monitoring.MonitorObjectService",
    method: "findModelWaters",
    args: [item.id, item.code]
  };
  ajaxCallJson(body, "/rpc", ({
    data
  }) => {
    if (data) {
      loadFloodModel(data, 1);
    } else {
      onFloodAnalysisBack();
      layer.msg("暂无该地区淹没分析图层数据...");
    }
  });
}