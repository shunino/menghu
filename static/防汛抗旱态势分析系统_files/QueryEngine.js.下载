// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.9/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper @dojo/framework/shim/Map @dojo/framework/shim/Set ../../../geometry ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/normalizeUtils ../../../geometry/support/scaleUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./SpatialQueryCache ./spatialQuerySupport ./utils ../../../tasks/support/Query".split(" "),
function(D,E,J,F,G,H,r,K,m,L,p,M,z,N,O,q,t,P,u,Q,v,w,y){function A(d){return d?JSON.parse(JSON.stringify(d,["latestWkid","wkid","wkt"])):d}function B(d,a,c,b,f,l,k,e){k&&!l?b.forEachFeatureInBounds(f,function(a){d.push({attributes:a.attributes,centroid:w.getCentroid(c,a,e)})}):l&&!k?b.forEachFeatureInBounds(f,function(b){a.add(b.objectId);d.push(new I(b.attributes,w.getGeometry(c,b,0,e)))}):b.forEachFeatureInBounds(f,function(b){a.add(b.objectId);d.push(new I(b.attributes,w.getGeometry(c,b,0,e),w.getCentroid(c,
b,e)))})}Object.defineProperty(E,"__esModule",{value:!0});var R=K.getLogger("esri.layers.graphics.data.QueryEngine"),I=function(){return function(d,a,c){this.attributes=d;this.geometry=a;this.centroid=c}}(),x={},C=new G.default;D=function(){function d(a){var c=this;this.capabilities={query:P.queryCapabilities};this.fieldsMap=new F.default;this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=
a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.gdbVersion=a.gdbVersion;this.historicMoment=a.historicMoment;this.spatialIndex=a.spatialIndex;this.spatialIndex.setEngine(this);this.timeInfo=a.timeInfo;this.cacheSpatialQueries&&(this._geometryQueryCache=new Q.default);a.fields.forEach(function(a){c.fieldsMap.set(a.name.trim(),a);c.fieldsMap.set(a.name.trim().toLowerCase(),a)})}d.prototype.destroy=function(){this.clearCache();this.fieldsMap.clear()};Object.defineProperty(d.prototype,
"fullExtent",{get:function(){var a=this.spatialIndex.fullBounds;return a?{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:A(this.spatialReference)}:null},enumerable:!0,configurable:!0});d.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._allItems=null};d.prototype.executeQuery=function(a){var c=this;void 0===a&&(a=new y);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).catch(function(a){if(a===
x)return new u.default([],c);throw a;}).then(function(a){return a.createQueryResponse(b)})};d.prototype.executeQueryForCount=function(a){var c=this;void 0===a&&(a=new y);var b=a.clone();b.returnGeometry=!1;b.returnCentroid=!1;b.outSpatialReference=null;return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){return a.size}).catch(function(a){if(a===
x)return 0;throw a;})};d.prototype.executeQueryForExtent=function(a){var c=this;void 0===a&&(a=new y);var b=a.clone(),f=b.outSpatialReference;return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(){b.returnGeometry=!0;b.returnCentroid=!1;b.outSpatialReference=null;return b}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){var b=a.size;
if(!b)return{count:b,extent:null};var e={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:A(c.spatialReference)};c.spatialIndex.forEachBounds(a.items,function(a){e.xmin=Math.min(a[0],e.xmin);e.ymin=Math.min(a[1],e.ymin);e.xmax=Math.max(a[2],e.xmax);e.ymax=Math.max(a[3],e.ymax)});a=t.project(e,a.spatialReference,f);a.spatialReference=A(f&&f.toJSON()||c.spatialReference);if(0===a.xmax-a.xmin){var l=z.getMetersPerUnitForSR(a.spatialReference);
a.xmin-=l;a.xmax+=l}0===a.ymax-a.ymin&&(l=z.getMetersPerUnitForSR(a.spatialReference),a.ymin-=l,a.ymax+=l);return{count:b,extent:a}}).catch(function(a){if(a===x)return{count:0,extent:null};throw a;})};d.prototype.executeQueryForIds=function(a){var c=this;void 0===a&&(a=new y);var b=a.clone();b.returnGeometry=!1;b.returnCentroid=!1;b.outSpatialReference=null;return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){a=
a.items;for(var b=[],c=0;c<a.length;c++)b[c]=a[c].objectId;return b}).catch(function(a){if(a===x)return[];throw a;})};d.prototype.executeTileQuery=function(a,c){var b=this,f=c.returnGeometry,l=c.returnCentroid,d=c.pixelBuffer;c=new G.default;var e=[],d=d*a.resolution,g=p.pad(a.bounds,d,p.create());B(e,c,this,this.spatialIndex,g,f,l,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]});if("esriGeometryPoint"===this.geometryType||l){var h=N.getInfo(this.spatialReference);
if(h){var n=h.valid,h=n[0],n=n[1];if(g[0]<h){var m=p.fromValues(n-d,g[1],n,g[3]);B(e,c,this,this.spatialIndex,m,f,l,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[n,a.bounds[3]]})}g[2]>n&&(d=p.fromValues(h,g[1],h+d,g[3]),B(e,c,this,this.spatialIndex,d,f,l,{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[h-n+a.bounds[0],a.bounds[3]]}))}}e.sort(function(a,c){return a.attributes[b.objectIdField]-c.attributes[b.objectIdField]});return{features:e,objectIds:c}};
d.prototype.executeTileQueryForIds=function(a,c){a=p.pad(a.bounds,c.pixelBuffer*a.resolution,p.create());return this.spatialIndex.mapFeaturesInBounds(a,function(a){return a.objectId})};d.prototype.executeQueryForLatestObservations=function(a){var c=this;if(this.timeInfo)return this.executeQuery(a).then(function(a){return c._filterLatest(a,c.timeInfo)});R.error(new r("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))};d.prototype._filterLatest=function(a,
c){var b=c.trackIdField,f=c.startTimeField;c=c.endTimeField||f;for(var f=new F.default,d=[],k=0,e=a.features;k<e.length;k++){var g=e[k],h=g.attributes[b],n=g.attributes[c];(!f.has(h)||f.get(h).attributes[c]<n)&&f.set(h,g)}f.forEach(function(a){return d.push(a)});return J({},a,{features:d})};d.prototype._getAll=function(){this._allItems||(this._allItems=new u.default(this.spatialIndex.getAllFeatures(),this));return this._allItems};d.prototype._normalizeQuery=function(a){var c=this,b=this.definitionExpression,
f=a.where,d=a.geometry,k=a.outFields,e=a.orderByFields,g=a.groupByFieldsForStatistics,h=a.outStatistics;a.where=f=f&&f.trim();if(!f||/^1 *= *1$/.test(f)||b&&b===f)a.where=null;if(k)for(b=0;b<k.length;b++)k[b]=k[b].trim();if(e)for(b=0;b<e.length;b++)e[b]=e[b].trim();if(g)for(b=0;b<g.length;b++)g[b]=g[b].trim();if(h)for(b=0;b<h.length;b++)h[b].onStatisticField=h[b].onStatisticField.trim();if(!d)return m.resolve(a);a.outSpatialReference||(a.outSpatialReference=d.spatialReference);return this._getInputGeometry(a).then(function(b){return a.geometry=
b}).then(function(a){return t.checkProjectionSupport(a.spatialReference,c.spatialReference)}).then(function(){return M.normalizeCentralMeridian(a.geometry)}).then(function(a){return t.project(a[0].toJSON(),a[0].spatialReference,c.spatialReference)}).then(function(b){if(!b)throw x;b.spatialReference=c.spatialReference;return a.read({geometry:b})})};d.prototype._executeGeometryQuery=function(a){var c=this,b=a.geometry,f=a.outSpatialReference,d=a.spatialRelationship,k=f&&!O.equals(this.spatialReference,
f),e=k?JSON.stringify({geometry:b,spatialRelationship:d,outSpatialReference:f}):JSON.stringify({geometry:b,spatialRelationship:d});if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(e))return m.resolve(this._geometryQueryCache.get(e));var g=null;if(b){var h=this._searchSpatialIndex(this._getQueryBBoxes(b));if(!h.length)return b=new u.default([],this),this.cacheSpatialQueries&&this._geometryQueryCache.set(e,b),m.resolve(b);g="envelope-intersects"===a.spatialRelationship||
"esriGeometryPoint"===this.geometryType&&v.canQueryWithRBush(b)?m.resolve(new u.default(h,this)):v.getSpatialQueryOperator(d,b,this.geometryType).then(function(a){if(a){var b=h.filter(function(b){return a(w.getGeometry(c,b))});return new u.default(b,c)}})}else g=m.resolve(this._getAll());return g.then(function(b){if(k&&(a.returnGeometry||a.returnCentroid))return b.project(f).then(function(a){c.cacheSpatialQueries&&c._geometryQueryCache.set(e,a);return a});c.cacheSpatialQueries&&c._geometryQueryCache.set(e,
b);return b})};d.prototype._getInputGeometry=function(a){var c=a.geometry,b=a.distance,f=a.units;if(null==b)return m.resolve(c);a=c.spatialReference;var d=f||z.getUnitString(a),f=null,f=a&&(a.isGeographic||a.isWebMercator)?m.resolve(c):t.checkProjectionSupport(a,H.SpatialReference.WGS84).then(function(){return L.project(c,H.SpatialReference.WGS84)});return f.then(function(a){return v.getGeodesicBufferOperator().then(function(c){return c(a,b,d)})})};d.prototype._getQueryBBoxes=function(a){if("point"===
a.type)return[p.fromValues(a.x,a.y,a.x,a.y)];a=v.canQueryWithRBush(a)?a:a.extent;switch(a.type){case "extent":return[p.fromExtent(a)];case "polygon":return a.rings.map(function(a){return p.fromValues(a[0][0],a[0][1],a[2][0],a[2][1])})}};d.prototype._searchSpatialIndex=function(a){for(var c=[],b=0;b<a.length;b++)this.spatialIndex.forEachFeatureInBounds(a[b],function(a){C.has(a)||(c.push(a),C.add(a))});C.clear();return c};d.prototype._checkQuerySupport=function(a){return 0>a.distance||null!=a.geometryPrecision||
a.multipatchOption||a.pixelSize||a.relationParameter||a.text||a.timeExtent?m.reject(new r("feature-store:unsupported-query","Unsupported query options",{query:a})):m.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),v.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),t.checkProjectionSupport(this.spatialReference,a.outSpatialReference)]).then(function(){return a})};d.prototype._checkAttributesQuerySupport=function(a){var c=a.outFields,b=a.orderByFields,
d=a.returnDistinctValues;b&&0<b.length&&(b=b.map(function(a){return-1<a.indexOf(" ASC")?a.split(" ASC")[0]:-1<a.indexOf(" DESC")?a.split(" DESC")[0]:a}),q.validateFields(this.fieldsMap,b,"orderByFields contains missing fields"));if(c&&0<c.length)q.validateFields(this.fieldsMap,c,"outFields contains missing fields");else if(d)throw new r("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});q.validateWhere(this.fieldsMap,a.where)};d.prototype._checkStatisticsQuerySupport=
function(a){var c=a.outStatistics,b=a.groupByFieldsForStatistics,d=a.having,l=b&&b.length,k=c&&c.length;if(d){if(!l||!k)return m.reject(new r("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a}));q.validateHaving(this.fieldsMap,d,c)}if(k)for(d=c.map(function(a){return a.onStatisticField.trim()}),q.validateFields(this.fieldsMap,d,"onStatisticFields contains missing fields"),l&&q.validateFields(this.fieldsMap,b,"groupByFieldsForStatistics contains missing fields"),
b=0;b<c.length;b++){var d=c[b],k=d.onStatisticField,e=d.statisticType;if((!l||"count"!==e)&&q.hasInvalidFieldType(k,this.fieldsMap))return m.reject(new r("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:d,query:a}))}};return d}();E.default=D});