// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.9/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/Set ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./utils".split(" "),function(z,A,D,l,B,E,F,C,G,H,u){function I(d){return d?JSON.parse(JSON.stringify(d,["latestWkid","wkid","wkt"])):d}Object.defineProperty(A,"__esModule",{value:!0});z=function(){function d(a,b){this.items=a;this.definitionExpression=
b.definitionExpression;this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.fieldsMap=b.fieldsMap}Object.defineProperty(d.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});d.prototype.createQueryResponse=function(a){return a.outStatistics?this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a)};d.prototype.executeAttributesQuery=function(a){var b=
G.getWhereClause(a.where);if(!b)return l.resolve(this);if(b.isStandardized()){for(var e=0,k=[],c=0,g=this.items;c<g.length;c++){var f=g[c];b.testFeature(f.attributes)&&(k[e++]=f)}b=this._createNew(k);b.definitionExpression=a.where;return l.resolve(b)}return l.reject(new TypeError("Where clause is not standardized"))};d.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return l.resolve(this);var b=new D.default(a.objectIds);return l.resolve(this._createNew(this.items.filter(function(a){return b.has(a.objectId)})))};
d.prototype.project=function(a){var b=this;return!a||E.equals(this.spatialReference,a)?l.resolve(this):H.projectMany(this.items.map(function(a){return u.getGeometry(b,a)}),this.spatialReference,a).then(function(e){for(var k=[],c=0;c<b.items.length;c++)k[c]={attributes:b.items[c].attributes,geometry:e[c]};e=[];F.convertFromFeatures(e,k,b.geometryType,b.hasZ,b.hasM,b.objectIdField);return new d(e,{definitionExpression:b.definitionExpression,geometryType:b.geometryType,hasM:b.hasM,hasZ:b.hasZ,objectIdField:b.objectIdField,
spatialReference:a,fieldsMap:b.fieldsMap})})};d.prototype._createFeatureQueryResponse=function(a){var b=this,e=this.items,k=this.geometryType,c=this.hasM,g=this.hasZ,f=this.objectIdField,d=this.spatialReference,m=a.outFields,p=a.outSpatialReference,q=a.quantizationParameters,t=!1;if(null!=a.num&&null!=a.start)var h=a.start+a.num,t=e.length>h,e=e.slice(a.start,Math.min(e.length,h));return{exceededTransferLimit:t,features:this._createFeatures(a,e),fields:m&&m.map(function(a){return b.fieldsMap.get(a)}),
geometryType:k,hasM:c,hasZ:g,objectIdFieldName:f,spatialReference:I(p?p.toJSON():d),transform:q&&B.toTransform(q)}};d.prototype._createFeatures=function(a,b){var e=new C.default(a,this.fieldsMap),k=a.quantizationParameters,c=a.returnGeometry,g=a.returnCentroid,f=a.maxAllowableOffset,d=a.orderByFields;a=[];var m=0;if(b.length&&d&&d.length){var d=d[0].split(" "),p=d[0],q="DESC"===d[1];b.sort(function(a,b){a=e.getFieldValue(a,p);b=e.getFieldValue(b,p);if("number"===typeof a&&"number"===typeof b)return q?
b-a:a-b;if("string"===typeof a&&"string"===typeof b)return a=a.toUpperCase(),b=b.toUpperCase(),(q?a>b:a<b)?-1:(q?a<b:a>b)?1:0})}if(c||g)if(k=B.toTransform(k),c&&!g)for(g=0;g<b.length;g++)c=b[g],a[m++]={attributes:e.getAttributes(c),geometry:u.getGeometry(this,c,f,k)};else if(!c&&g)for(f=0;f<b.length;f++)c=b[f],a[m++]={attributes:e.getAttributes(c),centroid:u.getCentroid(this,c,k)};else for(g=0;g<b.length;g++)c=b[g],a[m++]={attributes:e.getAttributes(c),centroid:u.getCentroid(this,c,k),geometry:u.getGeometry(this,
c,f,k)};else for(f=0;f<b.length;f++)c=b[f],(c=e.getAttributes(c))&&(a[m++]={attributes:c});return a};d.prototype._createNew=function(a){return new d(a,this)};d.prototype._createStatisticsQueryResponse=function(a){var b=new C.default(a,this.fieldsMap),e=[],k=[],c=a.groupByFieldsForStatistics,g=a.having,f=c&&c.length,c=f&&c[0],d={},m={},p={},q={attributes:{}},t=0;for(a=a.outStatistics;t<a.length;t++){var h=a[t],r=h.onStatisticField,x=h.outStatisticFieldName,v=h.statisticType,l="1"===r;if(f&&(r===c||
l)&&"count"===v){d[r]||(d[r]=this._calculateUniqueValues(b,l?c:r));var v=d[r],u;for(u in v){var n=v[u],y=n.count,h=n.data,w=n.items,n=m[h]||{attributes:{}};if(!g||b.validateItems(w,g))n.attributes[x]=y,n.attributes[l?"EXPR_1":r]=h,m[h]=n}k.push({name:x,alias:x,type:"esriFieldTypeString"})}else{if(f)for(u in l=this._calculateUniqueValues(b,c),l){if(n=l[u],h=n.data,w=n.items,!g||b.validateItems(w,g))n=m[h]||{attributes:{}},w=this._calculateStatistics(w,b,r),y="var"===v?"variance":v,n.attributes[x]=
w[y],n.attributes[c]=h,m[h]=n}else p[r]||(p[r]=this._calculateStatistics(this.items,b,r)),w=p[r],y="var"===v?"variance":v,q.attributes[x]=w[y];k.push({name:x,alias:x,type:"esriFieldTypeDouble"})}}if(f)for(var z in m)e.push(m[z]);else e.push(q);return{fields:k,features:e}};d.prototype._calculateStatistics=function(a,b,d){for(var e=a.length,c=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,f=null,l=null,m=null,p=null,q=[],t=0;t<e;t++){var h=q[t]=b.getFieldValue(a[t],d);isNaN(h)||(f+=h,c=Math.min(c,
h),g=Math.max(g,h))}if(e){l=f/e;for(b=a=0;b<q.length;b++)h=q[b],a+=Math.pow(h-l,2);p=1<e?a/(e-1):0;m=Math.sqrt(p)}else g=c=null;return{avg:l,count:e,max:g,min:c,stddev:m,sum:f,variance:p}};d.prototype._calculateUniqueValues=function(a,b){for(var e={},d=0,c=this.items;d<c.length;d++){var g=c[d],f=a.getFieldValue(g,b);if(null==f||"string"===typeof f&&""===f.trim())f=null;null==e[f]?e[f]={count:1,data:f,items:[g]}:(e[f].count++,e[f].items.push(g))}return e};return d}();A.default=z});