// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.9/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/generatorHelper dojo/errors/CancelError ../../../Color ../../../Graphic ../../../core/arrayUtils ../../../core/Collection ../../../core/has ../../../core/iteratorUtils ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../geometry/support/aaBoundingBox ../../../geometry/support/scaleUtils ../../../layers/IntegratedMeshLayer ../../../layers/graphics/controllers/I3SOnDemandController ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ../../../tasks/support/Query ./LayerView3D ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SProjectionUtil ./i3s/I3SQueryEngine ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/layerViewUpdatingProperties ./support/symbolColorUtils ../lib/gl-matrix ../support/mathUtils ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../support/buffer/typedArrayUtil ../webgl-engine/Stage ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/DefaultMaterial module".split(" "),
function(Y,P,Z,q,aa,ba,ca,da,D,F,ea,fa,ga,Q,ha,y,ia,ja,w,ka,l,z,la,R,ma,na,oa,pa,qa,ra,S,sa,ta,ua,va,r,wa,J,xa,ya,K,H,L,za,E,Aa,T,Ba,Ca,Da,Ea,M,N,A,Fa,U,Ga){function Ha(m,c,a,b,d){var e=!1,h;c.encoding===r.DDS_ENCODING_STRING?h=N.DDS_ENCODING:e=!(L.isPowerOfTwo(m.width)&&L.isPowerOfTwo(m.height));a=((m=c.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||c.atlas)?b:a)&&!e;return{mipmap:a,wrapClamp:m||!c.wrap,disableAnisotropy:m&&a&&d,encoding:h,noUnpackFlip:!0}}function V(m){return T.isArrayBuffer(m.data)}
function Ia(m,c){for(var a=1024,b=0;b<m.length;b++)var d=m[b],a=a+(d.interleavedVertexData.byteLength+(d.indices?d.indices.byteLength:0)),a=a+(d.positionData.data.byteLength+d.positionData.indices.byteLength);for(m=0;m<c.length;m++)b=c[m],T.isArrayBuffer(b.data)&&(a+=b.data.byteLength);return a}var u=Ba.ModelContentType,t=ha.getLogger("esri.views.3d.layers.SceneLayerView3D"),W=[1,1,1,1],Ja=[.8,.8,.8],Ka=[.5,.5,.5],La=function(){return function(){}}();P=function(m){function c(){var a=null!==m&&m.apply(this,
arguments)||this;a._queryEngine=null;a._highlights=new sa(a);a._elevationProvider=null;a._worker=new ra;a._workerThread=null;a._texId2Meta=new Map;a._nodeId2Meta=new Map;a._rendererVersion=0;a._rendererFields=null;a._colorVariable=null;a._opacityVariable=null;a._symbolInfos=new Map;a._idbCache=new wa.IDBCache("esri-scenelayer-cache","geometries",10);a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a.alwaysLoadEverythingModeEnabled=!1;a._cacheKeySuffix=null;a._definitionExpressionErrors=
0;a._maxDefinitionExpressionErrors=20;a._tmpAttributeOnlyGraphic=new D(null,null,{});return a}Z(c,m);Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererNeedsTextures",{get:function(){return r.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",
{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=la.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=oa.getMetersPerUnit(a.unit);return(a.offset||0)*d/b}return 0},enumerable:!0,configurable:!0});c.prototype._enableSecretAlwayLoadMode=function(){this.layer.store.lodModel&&"always-load"===this.layer.store.lodModel&&(this.alwaysLoadEverythingModeEnabled=!0)};Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",
{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!fa("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.has("s3tc")&&a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});
c.prototype.initialize=function(){var a=this;ka.open(ia.getAbsMid("./SceneLayerWorker",Y,Ga),{client:this}).then(function(b){a.destroyed?b.close():a._workerThread=b});r.checkSceneLayerValid(this.layer);r.checkSceneLayerCompatibleWithView(this.layer,this.view);this._controller=new ma({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;if((this._isIntegratedMesh=this.layer instanceof R)||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=
!1;else{var b=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(b&&b.faceRange&&b.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.view.getEdgeView());this._memCache=this.view.resourceController.getMemCache(this.layer.uid,function(b){return a._deleteNodeStageData(b)});this._addThisLayerToStage();
this._elevationProvider=new ta({layerView:this,stageLayer:this._stageLayer});this.handles.add([w.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),w.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),w.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),w.init(this.layer,"rangeInfos",function(b){return a._rangeInfosChanged(b)}),w.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),w.watch(this,"fullOpacity",
function(b){return a._opacityChange(b)}),w.watch(this,"slicePlaneEnabled",function(b){return a._slicePlaneEnabledChange(b)}),w.watch(this,"elevationOffset",function(b,e){return a._reloadAll(e)}),w.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){a._reloadAll();a._memCache.clear()}),w.init(this,"suspended",function(b){return a._suspendedChange(b)})],"sceneLayerHandles");this._idbCache.init().catch(function(a){t.warn("Failed to initialize IndexedDB cache: "+a)});
this._cacheKeySuffix=r.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._componentColorManager=this._hasSymbolColors?new Fa.BufferManager(this._stage.view.renderingContext):null;this._enableSecretAlwayLoadMode()};c.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._memCache=null;this._removeThisLayerFromStage();
this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);null!=this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=this._texId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};
c.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)};c.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};c.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};
c.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};c.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a.id)};c.prototype.getUsedMemory=function(){var a=0;this._nodeId2Meta.forEach(function(b){return a+=b.node.memory});return a};c.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};c.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),
this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._isIntegratedMesh?"im":"scene",this._elevationProvider)};c.prototype.getStats=function(){var a={index:0,nodes:this._nodeId2Meta.size.toString(),textures:this._texId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+
"MB"};this._controller&&(this._cachingEnabled()&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a};c.prototype._addThisLayerToStage=function(){for(var a=this._stage,b=new Uint8Array(256),d=0;d<b.length;d++)b[d]=255;this._whiteTexture=new N(b,"white",{width:8,height:8});a.add(u.TEXTURE,this._whiteTexture);b=this.layer.id;this._stageLayer=b=new Da(b,{},b);a.add(u.LAYER,b);this._stage.addToViewContent([b.id])};c.prototype._removeThisLayerFromStage=
function(){if(null!=this._stageLayer){var a=this._stage;a.remove(u.TEXTURE,this._whiteTexture.id);this._removeAllNodeDataFromStage();A.assert(0===this._nodeId2Meta.size);A.assert(0===this._texId2Meta.size);a.remove(u.LAYER,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};c.prototype.getLoadedAttributes=function(a){if(a=this._nodeId2Meta.get(a.id))return a.loadedAttributes};c.prototype.getAttributeData=function(a){if(a=this._nodeId2Meta.get(a.id))return a.attributeData};c.prototype.setAttributeData=
function(a,b,d){var e=this._nodeId2Meta.get(a.id);e&&(e.loadedAttributes=b,e.attributeData=d,e.cachedRendererVersion=this._getInvalidRendererVersion(),this._updateEngineObject(a,e))};c.prototype.getLoadedNodeIDs=function(){return F.keysOfMap(this._nodeId2Meta)};c.prototype._calcEngineMaterialTransparencyParams=function(a,b,d){var e=this.fullOpacity,c=1-L.clamp(A.fallbackIfUndefined(b.transparency,0),0,1);a=1>c||1>e||a&&Q.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||d;return{opacity:c,layerOpacity:e,
transparent:a}};c.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};c.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};c.prototype._getMaterialParameters=function(a,b,d,e){var c;null!=a&&(c=(c=this._texId2Meta.get(b))&&c.engineTex?c.engineTex.id:this._whiteTexture.id);b=d.params;var f=A.fallbackIfUndefined(b.diffuse,Ja);"standard"!==d.type&&t.warn("Unknown material type '"+
d.type+"', must be 'standard'");d=this._isIntegratedMesh;e={ambient:f,diffuse:f,specular:A.fallbackIfUndefined(b.specular,Ka),atlasRegions:b.vertexRegions,textureId:c,vertexColors:this._hasVertexColors,componentIndices:this._hasSymbolColors,componentColorBuffer:this._hasSymbolColors&&e?e.textureBuffer:null,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(b),cullFace:this._calcEngineMaterialCullFaceParams(b),writeStencil:d,receiveSSAO:!d,groundNormalShading:d,compressedNormals:!d,slicePlaneEnabled:this.slicePlaneEnabled};
d||(a=this._calcEngineMaterialTransparencyParams(a,b),Q.mixin(e,a));return e};c.prototype._createEngineMaterial=function(a,b,d,e,c,f,g){var h=null==b?null:this._getI3STexEncoding(b);g=this._getMaterialParameters(b,d,e,g);g=new U(g,c);g.metadata={i3sMatId:c,i3sTexId:d,i3sTex:b,i3sMatParams:e.params};if(null!=b){(e=this._texId2Meta.get(d))?e.usedByEngineMats.push(g):(e={id:d,usedByEngineMats:[g],images:b.images,encoding:h,atlas:!0===b.atlas,wrap:"none"!==b.wrap[0]||"none"!==b.wrap[1]},this._texId2Meta.set(d,
e));a:{for(b=0;b<f.length;b++)if(h=f[b],h.i3sTexId===d){d=h.data;break a}d=null}null!=d&&null==e.engineTex&&(f=Ha(d,e,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),e.engineTex=new N(d,e.id,f),this._stage.add(u.TEXTURE,e.engineTex),a.memory+=this.memEstimateTextureAdded(e.engineTex));if(null!=e.engineTex)for(a=e.engineTex.id,d=0,f=e.usedByEngineMats;d<f.length;d++)f[d].setParameterValues({textureId:a})}return g};c.prototype._getI3STexEncoding=function(a){var b=r.getAppropriateTextureEncoding(a.encoding,
this.useCompressedTextures);return-1<b?a.encoding[b]:a.encoding};c.prototype._getVertexBufferLayout=function(a,b){var d=a.params.materialID,e=b.materialDefinitions[d];A.assert(void 0!==e,"geometry wants unknown material "+d);a=a.params.textureID||"none";var c;"none"!==a&&(null!=b.textureDefinitions&&null!=b.textureDefinitions[a]||t.warn("textureDefinitions missing in shared resource"),c=b.textureDefinitions[a]);b=this._getMaterialParameters(c,a,e);return Aa.glLayout(U.getVertexBufferLayout(b))};c.prototype._createEngineMat=
function(a,b,d,e,c){var f=b.params.materialID,g=d.materialDefinitions[f];A.assert(void 0!==g,"geometry wants unknown material "+f);b=b.params.textureID||"none";var h;"none"!==b&&(null!=d.textureDefinitions&&null!=d.textureDefinitions[b]||t.warn("textureDefinitions missing in shared resource"),h=d.textureDefinitions[b]);return this._createEngineMaterial(a,h,b,g,f,e,c)};c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=
J.attributeLookup(a.attributes,this._getObjectIdField()),d=null;ga.everyMap(this._nodeId2Meta,function(a,c){c=a.featureIds.indexOf(b);if(-1===c)return!0;d={node:a.node,index:c};return!1});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.id);if(!a)return[];for(var d=[],e=this._getObjectIdField(),c=0;c<b.length;c++){var f=J.attributeLookup(b[c].attributes,e),f=a.featureIds.indexOf(f);-1!==f&&d.push(f)}return d};c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);
if(!a)return y.reject();var b=this._nodeId2Meta.get(a.node.id).engineObject;a=this._boundingBoxCornerPoints(a.index,b,new Float64Array(24));if(E.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=z.empty(),z.expandWithBuffer(b,a,0,8),y.resolve({boundingBox:b,screenSpaceObjects:[]})};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return r.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),b,function(){var b=d._findGraphicNodeAndIndex(a);
return{node:b.node,indices:[b.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};c.prototype.getGraphicFromStageObject=function(a,b){if(this.layer instanceof R)return y.reject();var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,b);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?(d=this._createGraphic(a,d),y.resolve(d)):y.reject()};c.prototype._getMetadata=function(a){a=a.getMetadata();return this._nodeId2Meta.get(a.i3sNode)};c.prototype._getCacheKey=
function(a){return a.baseUrl+this._cacheKeySuffix};c.prototype._getMemCacheKey=function(a,b){void 0===b&&(b=this.elevationOffset);return a+"#"+b};c.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};c.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=(this._cancelCount|0)+1|0};c.prototype._handleCancelled=function(a){if(0<((this._cancelCount|0)+(-a|0)|0))throw new ca;};c.prototype.loadCachedGPUData=
function(a){return this._memCache.pop(this._getMemCacheKey(a.id))};c.prototype.loadCachedNodeData=function(a,b){var d=this,e=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a)).then(function(c){if(null==c)return null;d._handleCancelled(e);if(c.nodeVersion!==a.version)return d._idbCache.remove(d._getCacheKey(a)),null;a.obb||(a.obb=za.clone(c.nodeObb),d._controller.updateVisibility(a.id));var f=function(a){if(null==a.data)return!0;var b=d._getI3STexEncoding(c.sharedResource.textureDefinitions[a.i3sTexId]);
return a.encoding!==b};return d.rendererNeedsTextures&&c.textureData.some(f)?b(c.allGeometryData,c.sharedResource).then(function(b){c.textureData=b;b.every(V)&&d._idbCache.put(d._getCacheKey(a),c).catch(function(b){b&&"indexedb:not-initialized"===b.name||t.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+b)});d._handleCancelled(e);return c}):c}):y.resolve(null)};c.prototype.addNodeData=function(a,b){var d=this;return this._transformBundle(a,b).then(function(b){return d._controller.reschedule(a.id,
b)}).then(function(e){a.obb||(a.obb=e.obb,d._controller.updateVisibility(a.id));e={allGeometryData:b.allGeometryData,transformedGeometries:e.transformedGeometries,textureData:b.textureData,sharedResource:b.sharedResource,nodeVersion:a.version,nodeObb:a.obb,byteSize:Ia(e.transformedGeometries,b.textureData)};if(d._cachingEnabled()){var c=e.textureData.map(function(a){return V(a)?a:{i3sTexId:a.i3sTexId,encoding:a.encoding,data:null}});d._idbCache.put(d._getCacheKey(a),{allGeometryData:e.allGeometryData,
transformedGeometries:e.transformedGeometries,textureData:c,sharedResource:e.sharedResource,nodeVersion:e.nodeVersion,nodeObb:e.nodeObb,byteSize:e.byteSize}).catch(function(b){return t.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)})}return d.addCachedNodeData(a,e,b.attributeDataInfo)})};c.prototype._transformBundle=function(a,b){for(var d=this,e=[],c=[b.geometryBuffer],f=0,g=b.allGeometryData;f<g.length;f++)for(var k=0,n=g[f].geometries;k<n.length;k++)e.push(this._getVertexBufferLayout(n[k],
b.sharedResource));b={geometryBuffer:b.geometryBuffer,geometryData:b.allGeometryData,layouts:e,mbs:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",b,c):this._controller.reschedule(a.id,
b).then(function(a){return d._worker.transform(a)})};c.prototype.addCachedGPUData=function(a,b,d){if(!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(a))return this._memCache.put(this._getMemCacheKey(a.id),b,a.memory),y.resolve();b.attributeData=d?d.attributeData:null;b.loadedAttributes=d?d.loadedAttributes:null;this._nodeId2Meta.set(a.id,b);b.engineObject.setHidden(b.engineObject.geometryRecords[0],!1);this._updateEngineObject(a,b);this._highlights.objectCreated(b.engineObject);
return y.resolve()};c.prototype.addCachedNodeData=function(a,b,d){var e=this;if(this._nodeId2Meta.has(a.id))return this._addOrUpdateEdgeRendering(this._nodeId2Meta.get(a.id)),this._applyFilters(a),y.resolve();if(this.suspended||!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(a))return y.resolve();var c=b.allGeometryData,f=b.transformedGeometries,g=b.textureData;b=b.sharedResource;if(0===c.length)return y.resolve();1!==c.length&&console.warn("Node with",c.length,"geometries is unsupported");
if(!this.rendererNeedsTextures)for(var k=0;k<g.length;k++)g[k].data=null;var n={};n[u.OBJECT]={};n[u.GEOMETRY]={};n[u.MATERIAL]={};var k=0,p=!1;a.memory=0;var B=c[0],c=B.componentOffsets,m=B.geometries,B=B.featureIds,l=null,q=null;if(this._hasSymbolColors)for(var l=this._componentColorManager.getBuffer(B.length),q=new Uint16Array(B.length),r=0;r<B.length;r++)q[r]=l.aquireIndex();for(var r=a.id+"|"+B[0],t=[],w=[],z=[],A=[],C,D=0;D<m.length;D++){var I=m[D],E=this._createEngineMat(a,I,b,g,l),v=f[k++];
C=v.corMatrices.globalTrafo;p=p||v.hasColors;v=new M(new Float32Array(v.interleavedVertexData),v.layout,v.positionData,c||M.DefaultOffsets,v.indices||M.DefaultIndices,!0);this._hasSymbolColors&&this._setComponentIndices(v,q);var I=null!=I.transformation?H.mat4d.create(I.transformation):H.mat4d.identity(),F=t.length,v=new Ca(v,r+(0<F?"_"+F:""));t.push(v);z.push(I);A.push([E]);w.push(ua.createOrigin(a.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference));a.memory+=this.memEstimateGeometryAdded(v.data);
n[u.MATERIAL][E.id]=E;n[u.GEOMETRY][v.id]=v}var G=new Ea({idHint:a.id,name:r,geometries:t,materials:A,transformations:z,origins:w,castShadow:!0,metadata:{i3sNode:a.id,layerUid:this.layer.uid}});G.setObjectTransformation(C);n[u.OBJECT][G.id]=G;var x=new La;x.node=a;x.engineObject=G;x.featureIds=B;x.attributeData=d?d.attributeData:null;x.loadedAttributes=d?d.loadedAttributes:null;x.componentColorBuffer=l;x.componentIndices=q;x.cachedRendererVersion=this._getInvalidRendererVersion();x.cachedSymbolInfos=
[];!this._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(this._hasTextures=!0);this._hasColors||(this._hasColors=p);this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");return y.create(function(b){e._addOrUpdateEdgeRendering(x).then(function(){if(e._nodeId2Meta.has(a.id))return e._edgeView&&e._edgeView.removeObject(x.engineObject),b();var d=e._stageLayer,c=e._stage,f=n[u.OBJECT],g;for(g in f)f.hasOwnProperty(g)&&d.addObject(f[g]);for(var h in n)if(n.hasOwnProperty(h)){var d=
n[h],k;for(k in d)d.hasOwnProperty(k)&&null==c.get(h,k)&&c.add(h,d[k])}e._nodeId2Meta.set(a.id,x);if(e.suspended)return e._removeNodeStageData(a.id),b();e._setObjectSymbology(x);e._applyFilters(a);e._highlights.objectCreated(G);e.visibleGeometryChanged(G);b()})})};c.prototype._clippingAreaChanged=function(){var a=this,b=z.create();E.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)});
this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){var a=this;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)})};c.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var d=new Float64Array(this.layer.objectIdFilter.ids),e="include"===this.layer.objectIdFilter.method;d.sort();b.push(function(b,c){return a._objectIdFilter(d,e,c)})}if(this._controller&&this._controller.parsedDefinitionExpression&&
this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var c=this._controller.parsedDefinitionExpression,f=this._controller.definitionExpressionFields;b.push(function(b,d){return a._sqlFilter(b,c,f,d)})}this._clippingArea&&b.push(function(b,d){return a._boundingboxFilter(b,a._clippingArea,d)});this._filters=b};c.prototype._sqlFilter=function(a,b,d,e){var c={},f=new D(null,null,c);f.layer=this.layer;f.sourceLayer=this.layer;var g=this.layer.objectIdField,k=0,n=0,p=this._nodeId2Meta.get(a.id);
a=p.featureIds;for(var B=p.attributeData,p=d.every(function(a){return null!=B[a]||a===g}),m=0;m<a.length&&k<e.length;m++)if(e[k]===a[m]){var l=!0;if(p){c[g]=a[m];for(var l=0,q=d;l<q.length;l++){var t=q[l];t!==g&&(c[t]=r.getCachedAttributeValue(B[t],m))}l=this._evaluateClause(b,f)}l&&(e[n]=e[k],n++);k++}e.length=n};c.prototype._evaluateClause=function(a,b){try{return a.testFeature(b)}catch(d){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&t.error("Error while evaluating definitionExpression: "+
d),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&t.error("Further errors are ignored"),!1}};c.prototype._objectIdFilter=function(a,b,d){for(var e=0,c=0;e<d.length;)0<=F.binaryIndexOf(a,d[e])===b&&(d[c]=d[e],c++),e++;d.length=c};c.prototype._boundingboxFilter=function(a,b,d){var e=[0,0,0,0];E.mbsToMbs(a.mbs,this._controller.crsIndex,e,this.view.renderSpatialReference);e=null!=b?r.intersectBoundingBoxWithMbs(b,e):2;if(2!==e)if(0===e)d.length=
0;else{var c=e=0,f=this._nodeId2Meta.get(a.id);a=f.featureIds;var g=f.engineObject.getObjectTransformation(),k=f.engineObject.getGeometryRecords()[0].getShaderTransformation();H.mat4d.multiply(g,k);if(0===g[1]&&0===g[2]&&0===g[3]&&0===g[4]&&0===g[6]&&0===g[7]&&0===g[8]&&0===g[9]&&0===g[11]&&1===g[15]){k=X;k[0]=(b[0]-g[12])/g[0];k[1]=(b[1]-g[13])/g[5];k[2]=(b[2]-g[14])/g[10];k[3]=(b[3]-g[12])/g[0];k[4]=(b[4]-g[13])/g[5];k[5]=(b[5]-g[14])/g[10];b=f.engineObject.getGeometryRecords()[0].geometry;f=b.componentCount;
for(g=0;g<f&&e<d.length;g++)if(d[e]===a[g]){var n=b.getComponentAABB(g,Ma);z.intersects(k,n)&&(d[c]=d[e],c++);e++}d.length=c}}};c.prototype._addOrUpdateEdgeRendering=function(a){return aa(this,void 0,void 0,function(){var b,d,c,h,f,g;return ba(this,function(e){switch(e.label){case 0:if(!this._edgeView)return[2];b=a.engineObject;d=this._edgeView.hasObject(b);c=this._extractObjectEdgeMaterials(a);h=c.hasEdges;f=c.perFeatureEdgeMaterials;if(!h)return[3,4];g=!b.isHidden(b.geometryRecords[0]);if(!d)return[3,
1];this._edgeView.updateAllComponentMaterials(b,f);this._edgeView.updateObjectVisibility(b,g);return[3,3];case 1:return g?[4,this._edgeView.addObject(b,f)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:d&&this._edgeView.removeObject(b),e.label=5;case 5:return[2]}})})};c.prototype._applyFilters=function(a){var b=this._nodeId2Meta.get(a.id);b&&(this._applyFiltersToObjects(a,b),this._updateEdgeRendering(b))};c.prototype._applyFiltersToObjects=function(a,b){var d=b.engineObject;d.unhideAllComponents();
if(0!==this._filters.length){b=b.featureIds;for(var c=b.slice(),h=0,f=this._filters;h<f.length;h++)(0,f[h])(a,c);if(c.length!==b.length)for(a=0,h=d.getGeometryRecords()[0],f=0;f<b.length;f++){var g=b[f];a>=c.length||c[a]!==g?d.setComponentVisibility(h,f,!1):a++}}};c.prototype._removeAllNodeDataFromStage=function(a){var b=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(d,c){return b._removeNodeStageData(c,a)})};c.prototype.removeNodeData=function(a){var b=this;a.forEach(function(a){return b._removeNodeStageData(a.id)})};
c.prototype._removeNodeStageData=function(a,b){void 0===b&&(b=this.elevationOffset);var d=this._nodeId2Meta.get(a);if(d){var c=d.engineObject;c.setHidden(c.geometryRecords[0],!0);this.visibleGeometryChanged(c);this._addOrUpdateEdgeRendering(d);this._nodeId2Meta.delete(a);this._highlights.objectDeleted(c);this._memCache.put(this._getMemCacheKey(a,b),d,d.node.memory)}};c.prototype._deleteNodeStageData=function(a){var b=this._stage,d=this._stageLayer,c=a.engineObject;this._edgeView&&this._edgeView.removeObject(c);
d.removeObject(c);for(var d=0,h=c.getGeometryRecords();d<h.length;d++){var f=h[d];this.memEstimateGeometryRemoved(f.geometry.data);b.remove(u.GEOMETRY,f.geometry.id);for(var g=0,f=f.materials;g<f.length;g++)this._removeMaterial(f[g],b)}if(a.componentIndices){for(d=0;d<a.componentIndices.length;d++)a.componentColorBuffer.releaseIndex(a.componentIndices[d]);this._componentColorManager.garbageCollect()}b.remove(u.OBJECT,c.id)};c.prototype._removeMaterial=function(a,b){b.remove(u.MATERIAL,a.id);var d=
a.metadata.i3sTexId;if(d){var c=this._texId2Meta.get(d);if(c){var h=c.usedByEngineMats;F.removeUnordered(h,a)||t.error("Missing reference from material to texture");0===h.length&&((a=c.engineTex)&&a!==this._whiteTexture&&(this.memEstimateTextureRemoved(a),b.remove(u.TEXTURE,c.engineTex.id)),this._texId2Meta.delete(d))}}};c.prototype.setPolygonOffset=function(a,b){var d=this._nodeId2Meta.get(a.id);if(d)for(a=0,d=d.engineObject.getGeometryRecords();a<d.length;a++)for(var c=0,h=d[a].materials;c<h.length;c++)h[c].setParameterValues({polygonOffset:b})};
c.prototype._getInvalidRendererVersion=function(){return(this._rendererVersion|0)+-1|0};c.prototype._rendererChange=function(a){this._currentRenderer=a;this._rendererVersion=(this._rendererVersion|0)+1|0;this._opacityVariable=this._colorVariable=this._rendererFields=null;a&&a.requiredFields&&(this._rendererFields=r.findFieldsCaseInsensitive(a.requiredFields,this.layer.fields));if(a&&a.visualVariables)for(var b=0,c=a.visualVariables;b<c.length;b++){var e=c[b];"color"===e.type?this._colorVariable=e:
"opacity"===e.type?this._opacityVariable=e:t.warn("Unsupported visual variable type for 3D Object Scene Services: "+e.type)}a&&(a.colorInfo||a.sizeInfo)&&t.warn("renderer.colorInfo and renderer.sizeInfo are not supported for 3D Object Scene Services. Use visualVariables instead.");if(a)for(b=0,a=a.getSymbols();b<a.length;b++)c=a[b],"mesh-3d"!==c.type&&t.error("Symbols of type '"+c.type+"' are not supported for 3D Object Scene Services.");this.view.resourceController.setMemoryDirty()};c.prototype._getSymbolInfos=
function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolInfos};c.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedSymbolColors};c.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var b=a.featureIds?a.featureIds.length:1,c={},e=this._tmpAttributeOnlyGraphic;
e.attributes=c;for(var h=this._currentRenderer,f=null!=a.featureIds?this.layer.objectIdField:null,g=null!=a.attributeData?this._rendererFields:null,k=0;k<b;k++){null!=f&&(c[f]=a.featureIds[k]);if(null!=g)for(var n=0,p=g;n<p.length;n++){var l=p[n];a.attributeData[l]&&(c[l]=r.getCachedAttributeValue(a.attributeData[l],k))}p=h&&h.getSymbol(e);n=null;p instanceof na&&(this._symbolInfos.has(p.id)||this._symbolInfos.set(p.id,r.getSymbolInfo(p)),n=this._symbolInfos.get(p.id));a.cachedSymbolInfos[k]=n;null==
a.cachedSymbolColors&&(a.cachedSymbolColors=new Uint8Array(4*a.featureIds.length));l=p=null;if(this._colorVariable){var m=h.getColor(e,{colorInfo:this._colorVariable,color:Na});m&&(p=O,p[0]=m.r/255,p[1]=m.g/255,p[2]=m.b/255,this._opacityVariable||null===m.a||(l=m.a))}this._opacityVariable&&(l=h.getOpacity(e,{opacityInfo:this._opacityVariable}));n&&n.material?(n=n.material,p=null==p||null==l?S.overrideColor(p,l,n.color,n.alpha,W,O):S.overrideColor(p,l,null,null,W,O),K.encodeSymbolColor(p,n.colorMixMode,
a.cachedSymbolColors,4*k)):K.encodeSymbolColor(null,null,a.cachedSymbolColors,4*k)}}};c.prototype._extractObjectEdgeMaterials=function(a){var b=[],c=a.engineObject,e=a.featureIds?a.featureIds.length:1,h=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),f={opacity:this.fullOpacity,slicePlaneEnabled:this.slicePlaneEnabled},g=!1,k=null,n=null;a=this._getSymbolInfos(a);for(var l=0;l<e;l++){var m=a[l];c.getComponentVisibility(c.getGeometryRecords()[0],l)&&m?(n!==m&&(n=m,(k=xa.createMaterialFromEdges(this._edgeView,
m.edges,f))&&(g=!0)),b.push(null!=k?k:h)):b.push(h)}return{hasEdges:g,perFeatureEdgeMaterials:b}};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors){for(var b=a.featureIds?a.featureIds.length:1,c=!1,e=this._getSymbolColors(a),h=a.componentColorBuffer.textureBuffer,f=0;f<b;f++){var g=4*f;h.setData(a.componentIndices[f],0,e[g],e[g+1],e[g+2],e[g+3]);K.isOpaqueSymbolColor(e,g)||(c=!0)}this._updateObjectOpacity(a.engineObject,c)}};c.prototype._setComponentIndices=function(a,b){for(var c=
a.getAttribute(A.VertexAttrConstants.COMPONENTINDEX),e=c.data,h=c.offsetIdx,c=c.strideIdx,f=a.getIndices(A.VertexAttrConstants.COMPONENTINDEX),g=0;g<b.length;g++)for(var k=a.componentOffsets[g+1],l=a.componentOffsets[g];l<k;l++)e[h+f[l]*c]=b[g]};c.prototype._rangeInfosChanged=function(a){null!=a&&0<a.length&&t.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};c.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);
this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._nodeId2Meta.forEach(function(a){b._updateObjectOpacity(a.engineObject);b._updateEdgeRendering(a)})};c.prototype._updateObjectOpacity=function(a,b){var c=0;for(a=a.getGeometryRecords();c<a.length;c++)for(var e=0,h=a[c].materials;e<h.length;e++){var f=h[e],g=f.metadata;void 0!==b&&(g.symbolIsTransparent=b);var k=f.getParams(),g=this._calcEngineMaterialTransparencyParams(g.i3sTex,
g.i3sMatParams,g.symbolIsTransparent);k.transparent===g.transparent&&k.layerOpacity===g.layerOpacity||f.setParameterValues(g)}};c.prototype._updateEngineObject=function(a,b){this._setObjectSymbology(b);this._addOrUpdateEdgeRendering(b);this._applyFilters(a);this.visibleGeometryChanged(b.engineObject)};c.prototype._slicePlaneEnabledChange=function(a){var b=this,c={slicePlaneEnabled:a};this._nodeId2Meta.forEach(function(a){for(var d=0,e=a.engineObject.getGeometryRecords();d<e.length;d++)for(var g=0,
k=e[d].materials;g<k.length;g++)k[g].setParameterValues(c);b._updateEdgeRendering(a)})};c.prototype._updateEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.engineObject)&&this._addOrUpdateEdgeRendering(a)};c.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};c.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};c.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};c.prototype.queryObjectIds=
function(a){return this._ensureQueryEngine().queryObjectIds(a)};c.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new va(this.layer,{forAll:function(c,e){a._forAllFeatures(function(d,e,g){b.id=d;b.index=e;b.meta=g;a._boundingBoxCornerPoints(e,g.engineObject,b.bbCorners);c(b)},e)},createGraphic:function(b){return a._createGraphic(b.index,
b.meta)},requestFields:function(b,c,h){return r.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),h,function(){var d=a._getGraphicIndices(b,c);return{node:b,indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return a._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};c.prototype._createExtentBuilder=function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,c=z.empty(),e=new Float64Array(24);return{add:function(d){E.bufferToBuffer(d.bbCorners,
a,0,e,b,0,8)&&z.expandWithBuffer(c,e,0,8)},getExtent:function(){return z.toExtent(c,b)}}};c.prototype._forAllFeatures=function(a,b,c){var d=this;this._nodeId2Meta.forEach(function(e,f){d._forAllFeaturesOfNode(e,a,c);b&&b(e.node)})};c.prototype._forAllFeaturesOfNode=function(a,b,c){for(var d=a.featureIds,h=a.engineObject.getGeometryRecords()[0],f=0;f<d.length;f++)(c||a.engineObject.getComponentVisibility(h,f))&&b(d[f],f,a,h)};c.prototype._createGraphic=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=
b.featureIds[a]);if(null!=b.attributeData)for(var e=0,h=Object.keys(b.attributeData);e<h.length;e++){var f=h[e];c[f]=r.getCachedAttributeValue(b.attributeData[f],a)}a=new D(null,null,c);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].getComponentAABB(a,X);for(var d=0;8>d;++d)C[0]=d&1?a[0]:a[3],C[1]=d&2?a[1]:a[4],C[2]=d&4?a[2]:a[5],H.mat4d.multiplyVec3(b.objectTransformation,C),c[3*d]=C[0],c[3*d+1]=C[1],c[3*d+2]=C[2];return c};
c.prototype.highlight=function(a,b){var c=this,e=this._highlights;if(a instanceof pa){b=e.acquireSet(b);var h=b.set,f=b.handle;this.queryObjectIds(a).then(function(a){return e.setFeatureIds(h,a)});return f}"number"===typeof a?a=[a]:a instanceof D?a=[a]:a instanceof ea&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof D)return a=a.map(function(a){return J.attributeLookup(a.attributes,c._getObjectIdField())}),f=e.acquireSet(b),b=f.set,f=f.handle,e.setFeatureIds(b,a),f;if("number"===
typeof a[0])return f=e.acquireSet(b),b=f.set,f=f.handle,e.setFeatureIds(b,a),f}return{remove:function(){}}};c.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=ja.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null}))};q([l.property()],c.prototype,"layer",void 0);q([l.property()],
c.prototype,"_controller",void 0);q([l.property({dependsOn:["_controller.updating"]})],c.prototype,"updating",void 0);q([l.property({dependsOn:["_controller.rootNodeVisible"]})],c.prototype,"suspended",void 0);q([l.property(ya.updatingPercentage)],c.prototype,"updatingPercentage",void 0);q([l.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0);q([l.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);q([l.property({readOnly:!0,
dependsOn:["layer.renderer"]})],c.prototype,"rendererNeedsTextures",null);q([l.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);q([l.property({type:Boolean})],c.prototype,"slicePlaneEnabled",void 0);q([l.property()],c.prototype,"alwaysLoadEverythingModeEnabled",void 0);q([l.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);
q([l.property({dependsOn:["layer.version"]})],c.prototype,"useCompressedTextures",null);return c=q([l.subclass("esri.views.3d.layers.SceneLayerView3D")],c)}(l.declared(qa));var C=H.vec3d.create(),X=z.create(),Ma=z.create(),O=[0,0,0,0],Na=new da([0,0,0,0]);return P});